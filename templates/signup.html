<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - FormPipeDB</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <h1>Create an Account</h1>
        <form id="signup-form">
            <input type="text" id="full_name" placeholder="Full Name" required>
            <input type="email" id="email" placeholder="Email" required>
            <input type="email" id="confirm_email" placeholder="Confirm Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <input type="password" id="confirm_password" placeholder="Confirm Password" required>
            <div style="text-align: left; margin-bottom: 1rem; font-size: 0.9rem;">
                <input type="checkbox" id="terms_agree" name="terms_agree" required>
                <label for="terms_agree">I agree to the 
                    <a href="/terms" target="_blank" style="color: #0070f3; text-decoration: underline;">Terms and Conditions</a> and 
                    <a href="/privacy" target="_blank" style="color: #0070f3; text-decoration: underline;">Privacy Policy</a>.</label>
            </div>
            <button type="submit">Sign Up</button>
        </form>
        <p id="error-message" style="color: red;"></p>
    </div>

    <script>
        const supabaseUrl = '{{ supabase_url }}';
        const supabaseAnonKey = '{{ supabase_anon_key }}';
        const errorMessage = document.getElementById('error-message');

        // Important: Check if the credentials are provided
        if (!supabaseUrl || !supabaseAnonKey) {
            console.error("Supabase URL or Anon Key is missing. Make sure environment variables are set in Vercel.");
            errorMessage.textContent = 'Configuration error. Please contact support.';
        }

        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        const signupForm = document.getElementById('signup-form');
        signupForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            errorMessage.textContent = ''; // Clear previous errors

            const fullName = document.getElementById('full_name').value;
            const email = document.getElementById('email').value;
            const confirmEmail = document.getElementById('confirm_email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const termsAgreed = document.getElementById('terms_agree').checked;

            // --- Client-side validation ---
            if (email !== confirmEmail) {
                errorMessage.textContent = 'Emails do not match.';
                return;
            }

            if (password !== confirmPassword) {
                errorMessage.textContent = 'Passwords do not match.';
                return;
            }

            if (!termsAgreed) {
                errorMessage.textContent = 'You must agree to the Terms and Conditions and Privacy Policy.';
                return;
            }

            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        full_name: fullName
                    }
                }
            });

            if (error) {
                errorMessage.textContent = error.message;
            } else {
                // If email confirmation is turned on, you might want to show a message here.
                // For now, we redirect directly to the app.
                window.location.href = '/app';
            }
        });
    </script>
</body>
</html>