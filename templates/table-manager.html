<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Manager - FormPipeDB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code&display=swap" rel="stylesheet">
    
    <!-- CodeMirror for SQL editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/sql/sql.min.js"></script>

    <!-- Highlight.js for static code views -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Google Identity Services Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style> 
        body { font-family: 'Inter', sans-serif; } .CodeMirror { font-family: 'Fira Code', monospace; border-radius: 0.375rem; height: 10rem; }
        .modal { transition: opacity 0.3s ease-in-out; }
        #sidebar, #main-content { transition: all 0.3s ease-in-out; }
        .sidebar-item-title, #sidebar-header-text, #sidebar-footer-text { transition: opacity 0.2s, width 0.2s; }
        #sidebar.collapsed .sidebar-item-title, #sidebar.collapsed #sidebar-header-text, #sidebar.collapsed #sidebar-footer-text {
            opacity: 0;
            width: 0;
            overflow: hidden;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-50">

<div class="h-screen flex">
    <!-- Collapsible Sidebar -->
    <aside id="sidebar" class="w-72 bg-white border-r flex flex-col shrink-0">
        <div class="p-4 border-b flex items-start gap-3 overflow-hidden">
            <a href="/app" class="shrink-0">
                <img src="/static/logo.svg" alt="FormPipeDB Logo" class="h-10 w-10">
            </a>
            <div id="sidebar-header-text" class="flex-1 min-w-0">
                <a href="/app" class="text-sm text-blue-600 hover:underline truncate">Back to Dashboard</a>
                <h1 class="text-2xl font-bold text-gray-800 mt-1 truncate" title="{{ db_name }}">{{ db_name }}</h1>
            </div>
        </div>
        <div class="p-4 border-b">
            <h2 id="sidebar-header-text" class="text-lg font-semibold text-gray-700">Tables</h2>
        </div>
        <nav id="table-list" class="flex-1 p-4 space-y-1 overflow-y-auto">
            <!-- Loading state -->
            <div class="flex items-center gap-2 text-sm text-gray-500 p-2">
                <svg class="animate-spin h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span class="sidebar-item-title">Loading tables...</span>
            </div>
        </nav>
        <div class="p-4 border-t space-y-2 overflow-hidden">
            <button id="create-table-btn" class="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 font-semibold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg><span class="sidebar-item-title">Create Table</span></button>
            <button id="import-csv-btn" class="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-purple-600 text-white hover:bg-purple-700 font-semibold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span class="sidebar-item-title">Import CSV</span></button>
            <button id="sql-runner-btn" class="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-green-600 text-white hover:bg-green-700 font-semibold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="sidebar-item-title">SQL Runner</span></button>
            <button id="view-db-sql-btn" class="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-gray-200 text-gray-800 hover:bg-gray-300 font-semibold text-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8-4"></path></svg><span class="sidebar-item-title">View SQL</span></button>
            <button id="delete-table-btn" class="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-red-100 text-red-700 hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span class="sidebar-item-title">Delete Table</span></button>
        </div>
        <div class="p-2 border-t">
            <button id="toggle-sidebar-btn" class="w-full flex items-center justify-center p-2 rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-800">
                <svg id="collapse-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                <svg id="expand-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </aside>

    <main id="main-content" class="flex-1 p-8 overflow-auto hidden">
        <div id="table-tabs-container" class="border-b mb-6">
            <nav class="flex space-x-6">
                <button data-tab="data" class="table-tab-btn py-2 px-1 font-medium border-b-2 border-blue-500 text-blue-600">Data</button>
                <button data-tab="structure" class="table-tab-btn py-2 px-1 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Structure</button>
                <button data-tab="integrations" class="table-tab-btn py-2 px-1 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Integrations</button>
                <button data-tab="table-sql" class="table-tab-btn py-2 px-1 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">SQL</button>
            </nav>
        </div>

        <div id="structure-tab-content" class="table-tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-3 text-left font-semibold">Column Name</th>
                            <th class="p-3 text-left font-semibold">Data Type</th>
                            <th class="p-3 text-center font-semibold">Not Null</th>
                            <th class="p-3 text-center font-semibold">Primary Key</th>
                            <th class="p-3 text-center font-semibold">Unique</th>
                            <th class="p-3 text-left font-semibold">Foreign Key</th>
                            <th class="p-3 text-center font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="structure-tbody" class="divide-y">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="table-sql-tab-content" class="table-tab-content hidden">
            <div class="p-4 rounded-md font-mono text-sm ring-1 ring-gray-200 relative bg-[#282c34]">
                <button id="copy-table-sql-btn" class="absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs font-semibold py-1 px-2 rounded">Copy</button>
                <pre><code id="table-sql-code"></code></pre>
            </div>
        </div>

        <div id="integrations-tab-content" class="table-tab-content hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">Webhook Integrations</h2>
                <button id="create-webhook-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold">Create New Webhook</button>
            </div>
            <div id="webhooks-list-container" class="space-y-4 min-h-[6rem]">
                <!-- Webhooks will be rendered here by JS -->
            </div>

            <hr class="my-8 border-t">

            <div>
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Calendar Automation</h2>
                <div id="calendar-automation-container" class="bg-white rounded-lg shadow-sm border p-6">
                    <!-- Calendar integration UI will be rendered here -->
                </div>
            </div>
        </div>

        <div id="data-tab-content" class="table-tab-content">
            <div class="flex justify-between items-center mb-4 gap-2">
                <div class="w-1/3">
                    <input type="search" id="row-search-input" placeholder="Search rows..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex gap-2">
                    <button id="add-row-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Add Row</button>
                    <button id="import-rows-btn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">Import Rows</button>
                    <button id="export-csv-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 ml-2">Export to CSV</button>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border overflow-auto max-h-[70vh]">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                    </thead>
                    <tbody id="data-tbody" class="divide-y">
                    </tbody>
                </table>
            </div>
            <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm text-gray-600">
            </div>
        </div>
    </main>

    <div id="sql-runner-view" class="flex-1 p-8 overflow-auto hidden">
        <div class="space-y-6">
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-4 border-b">
                    <h3 class="text-lg font-semibold">SQL Runner</h3>
                    <p class="text-sm text-gray-500 mt-1">Execute custom SQL queries against your database.</p>
                </div>
                <div class="p-4">
                    <textarea id="sql-query-input" class="w-full h-40" placeholder="-- Example: SELECT * FROM users WHERE id > 10;"></textarea>
                    <div class="mt-4 flex justify-end">
                        <button id="run-query-btn" class="bg-blue-600 text-white px-5 py-2 rounded-md hover:bg-blue-700 font-semibold">Run Query</button>
                    </div>
                </div>
            </div>
            <div id="query-results-container" class="bg-white rounded-lg shadow-sm border min-h-[10rem]">
            </div>
        </div>
    </div>

    <div id="placeholder-content" class="flex-1 flex items-center justify-center text-gray-500">
        Select a table to view its structure and data.
    </div>
</div>

<div id="error-banner" class="hidden fixed top-5 right-5 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-50" role="alert">
    <strong class="font-bold">Error: </strong>
    <span id="error-banner-message" class="block sm:inline"></span>
    <button onclick="this.parentElement.classList.add('hidden')" class="absolute top-0 bottom-0 right-0 px-4 py-3">&times;</button>
</div>

<div id="create-table-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <form id="create-table-form" class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
        <div class="p-4 border-b">
            <h3 class="text-xl font-semibold">Create New Table</h3>
        </div>
        <div class="border-b">
            <nav class="flex space-x-1 p-2 bg-gray-100">
                <button type="button" data-tab="gui" class="create-table-tab-btn flex-1 p-2 text-sm font-medium rounded-md bg-white shadow">GUI Builder</button>
                <button type="button" data-tab="sql" class="create-table-tab-btn flex-1 p-2 text-sm font-medium rounded-md">From SQL</button>
            </nav>
        </div>
        <div id="gui-create-tab" class="create-table-tab-content p-6 space-y-4 overflow-y-auto">
            <input id="new-table-name" type="text" placeholder="Table Name (e.g., users)" required class="w-full p-2 border rounded-md">
            <div id="new-columns-list" class="space-y-2 pt-2"></div>
            <button id="add-column-to-modal-btn" type="button" class="text-sm text-blue-600 hover:underline mt-2">+ Add Column</button>
        </div>
        <div id="sql-create-tab" class="create-table-tab-content hidden p-6 space-y-4 overflow-y-auto">
            <p class="text-sm text-gray-600">Paste a single `CREATE TABLE` statement below.</p>
            <textarea id="create-table-sql-input" class="w-full h-64" placeholder="CREATE TABLE products (...);"></textarea>
        </div>
        <div class="p-6 mt-auto border-t bg-gray-50 flex justify-end gap-4">
            <button id="cancel-create-table-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Create Table</button>
        </div>
    </form>
</div>

<div id="view-db-sql-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-xl font-semibold">Database SQL Schema</h3>
            <button id="close-db-sql-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
        </div>
        <div class="p-4 overflow-y-auto bg-[#282c34] text-white font-mono text-sm">
            <pre><code id="db-sql-code-content"></code></pre>
        </div>
    </div>
</div>

<div id="edit-column-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <form id="edit-column-form" class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
        <h3 class="text-lg font-semibold mb-6">Edit Column</h3>
        <input type="hidden" id="edit-column-index">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Column Name</label>
                <input type="text" id="edit-column-name" required class="mt-1 block w-full p-2 border rounded-md shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Data Type</label>
                <select id="edit-column-type" class="mt-1 block w-full p-2 border rounded-md shadow-sm bg-white">
                    <option value="text">TEXT</option>
                    <option value="integer">INTEGER</option>
                    <option value="real">REAL</option>
                    <option value="boolean">BOOLEAN</option>
                    <option value="timestamp">TIMESTAMP</option>
                    <option value="jsonb">JSONB</option>
                </select>
            </div>
            <fieldset class="space-y-2 pt-2">
                <legend class="text-sm font-medium text-gray-700">Constraints</legend>
                <div class="grid grid-cols-2 gap-4">
                    <label class="flex items-center"><input id="edit-is-not-null" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2"> Not Null</label>
                    <label class="flex items-center"><input id="edit-is-unique" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2"> Unique</label>
                </div>
            </fieldset>
        </div>
        <div class="mt-8 flex justify-end gap-4">
            <button id="cancel-edit-column-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save Changes</button>
        </div>
    </form>
</div>

<div id="delete-table-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
        <h3 class="text-lg font-semibold mb-4">Confirm Table Deletion</h3>
        <p>Are you sure you want to delete the table "<strong id="modal-table-name"></strong>"? This will permanently delete all of its data. This action cannot be undone.</p>
        <div class="mt-6 flex justify-end gap-4">
            <button id="cancel-delete-table-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button id="confirm-delete-table-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Delete</button>
        </div>
    </div>
</div>

<div id="import-csv-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <form id="import-csv-form" class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="p-4 border-b">
            <h3 class="text-xl font-semibold">Import Table from CSV</h3>
        </div>
        
        <!-- Step 1: File Upload -->
        <div id="import-step-1" class="p-6 space-y-4">
            <div>
                <label for="import-table-name" class="block text-sm font-medium text-gray-700">New Table Name</label>
                <input id="import-table-name" type="text" placeholder="e.g., customers" required class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div>
                <label for="import-csv-file" class="block text-sm font-medium text-gray-700">CSV File (with headers)</label>
                <input id="import-csv-file" type="file" accept=".csv" required class="mt-1 w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
        </div>

        <!-- Step 2: Review Columns -->
        <div id="import-step-2" class="p-6 space-y-4 overflow-y-auto hidden">
            <p class="text-sm text-gray-600">Review the detected columns and their inferred data types. You can make changes before importing.</p>
            <div class="border rounded-lg overflow-hidden">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-2 text-left font-semibold">Original Header</th>
                            <th class="p-2 text-left font-semibold">New Column Name (Sanitized)</th>
                            <th class="p-2 text-left font-semibold">Data Type</th>
                            <th class="p-2 text-center font-semibold">PK</th>
                        </tr>
                    </thead>
                    <tbody id="csv-review-tbody" class="divide-y">
                        <!-- Rows will be injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="p-4 mt-auto border-t bg-gray-50 flex justify-end gap-4">
            <button id="cancel-import-csv-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button id="import-csv-next-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold">Review Columns</button>
            <button id="import-csv-submit-btn" type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold hidden">Create Table & Import</button>
        </div>
    </form>
</div>

<div id="import-rows-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <form id="import-rows-form" class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
        <div class="p-4 border-b">
            <h3 class="text-xl font-semibold">Import Rows into '<span id="import-rows-table-name"></span>'</h3>
        </div>
        <div class="p-6 space-y-4 overflow-y-auto">
            <div>
                <label for="import-rows-csv-file" class="block text-sm font-medium text-gray-700">CSV File</label>
                <input id="import-rows-csv-file" type="file" accept=".csv" required class="mt-1 w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <div id="import-rows-mapping-container" class="hidden space-y-3 pt-4">
                <p class="text-sm font-medium text-gray-800">Map CSV columns to table columns:</p>
                <div id="import-rows-mapping-fields" class="space-y-2 border-t pt-3">
                    <!-- Mapping fields will be injected by JS -->
                </div>
            </div>
        </div>
        <div class="p-4 mt-auto border-t bg-gray-50 flex justify-end gap-4">
            <button id="cancel-import-rows-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold" disabled>Import Rows</button>
        </div>
    </form>
</div>

<div id="import-summary-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
        <h3 class="text-xl font-semibold mb-4">Import Summary</h3>
        <div id="import-summary-content" class="space-y-3 text-gray-700">
        </div>
        <div class="mt-6 flex justify-end gap-4">
            <button id="close-summary-modal-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Close</button>
        </div>
    </div>
</div>

<script>
const supabaseUrl = '{{ supabase_url }}';
const supabaseAnonKey = '{{ supabase_anon_key }}';
const supabase = supabaseUrl && supabaseAnonKey ? window.supabase.createClient(supabaseUrl, supabaseAnonKey) : null;
const googleClientId = '{{ google_client_id }}';

document.addEventListener('DOMContentLoaded', () => {
    if (!supabase) {
        document.body.innerHTML = '<div class="text-center p-8 text-red-600">Supabase client not configured. Please check your environment variables.</div>';
        return;
    }

    // State
    let state = {
        dbId: null,
        dbName: '{{ db_name }}',
        tables: [],
        selectedTable: null,
        pagination: {
            currentPage: 1,
            limit: 50, // This should match the default limit in the API
            totalRows: 0,
            calendarIntegration: null
        }
    };

    // DOM Elements
    const tableList = document.getElementById('table-list');
    const mainContent = document.getElementById('main-content');
    const placeholderContent = document.getElementById('placeholder-content');
    const deleteTableBtn = document.getElementById('delete-table-btn');
    const tableTabButtons = document.querySelectorAll('.table-tab-btn');
    const tableTabContainer = document.getElementById('table-tabs-container');
    const createTableBtn = document.getElementById('create-table-btn');
    const createTableModal = document.getElementById('create-table-modal');
    const createTableForm = document.getElementById('create-table-form');
    const cancelCreateTableBtn = document.getElementById('cancel-create-table-btn');
    const addColumnToModalBtn = document.getElementById('add-column-to-modal-btn');
    const deleteTableModal = document.getElementById('delete-table-modal');
    const modalTableName = document.getElementById('modal-table-name');
    const cancelDeleteTableBtn = document.getElementById('cancel-delete-table-btn');
    const confirmDeleteTableBtn = document.getElementById('confirm-delete-table-btn');
    const editColumnModal = document.getElementById('edit-column-modal');
    const editColumnForm = document.getElementById('edit-column-form');
    const cancelEditColumnBtn = document.getElementById('cancel-edit-column-btn');
    const structureTbody = document.getElementById('structure-tbody');
    const viewDbSqlBtn = document.getElementById('view-db-sql-btn');
    const dbSqlCodeContent = document.getElementById('db-sql-code-content');
    const viewDbSqlModal = document.getElementById('view-db-sql-modal');
    const closeDbSqlModalBtn = document.getElementById('close-db-sql-modal-btn');
    const importRowsBtn = document.getElementById('import-rows-btn');
    const addRowBtn = document.getElementById('add-row-btn');
    const dataTbody = document.getElementById('data-tbody');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const searchInput = document.getElementById('row-search-input');
    const runQueryBtn = document.getElementById('run-query-btn');
    const sqlQueryInput = document.getElementById('sql-query-input');
    const sqlRunnerBtn = document.getElementById('sql-runner-btn');
    const sqlRunnerView = document.getElementById('sql-runner-view');
    const queryResultsContainer = document.getElementById('query-results-container');
    const importCsvBtn = document.getElementById('import-csv-btn');
    const importCsvModal = document.getElementById('import-csv-modal');
    const importCsvForm = document.getElementById('import-csv-form');
    const cancelImportCsvBtn = document.getElementById('cancel-import-csv-btn');
    const importCsvNextBtn = document.getElementById('import-csv-next-btn');
    const importCsvSubmitBtn = document.getElementById('import-csv-submit-btn');
    const importCsvFile = document.getElementById('import-csv-file');
    const importStep1 = document.getElementById('import-step-1');
    const importStep2 = document.getElementById('import-step-2');
    const csvReviewTbody = document.getElementById('csv-review-tbody');
    const importTableName = document.getElementById('import-table-name');
    const importRowsModal = document.getElementById('import-rows-modal');
    const importRowsForm = document.getElementById('import-rows-form');
    const cancelImportRowsBtn = document.getElementById('cancel-import-rows-btn');
    const importSummaryModal = document.getElementById('import-summary-modal');
    const closeSummaryModalBtn = document.getElementById('close-summary-modal-btn');
    const createWebhookBtn = document.getElementById('create-webhook-btn');
    const webhooksListContainer = document.getElementById('webhooks-list-container');
    const calendarAutomationContainer = document.getElementById('calendar-automation-container');
    const sidebar = document.getElementById('sidebar');
    const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');


    const importRowsCsvFile = document.getElementById('import-rows-csv-file');
    
    // CodeMirror instances
    let sqlRunnerEditor;
    let createTableSqlEditor;

    function showError(message) {
        const banner = document.getElementById('error-banner');
        const bannerMessage = document.getElementById('error-banner-message');
        bannerMessage.textContent = message;
        banner.classList.remove('hidden');
    }

    /**
     * A wrapper for the native fetch function that automatically includes
     * the Supabase authentication token.
     * @param {string} url - The URL to fetch.
     * @param {object} options - The options for the fetch call (e.g., method, body).
     * @returns {Promise<Response>} The fetch Response object.
     */
    async function fetchWithAuth(url, options = {}) {
        const token = await getAuthToken();
        if (!token) return; // getAuthToken handles redirection

        const headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
        return fetch(url, { ...options, headers });
    }

    async function getAuthToken() {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error || !session) {
            console.error("Authentication error, redirecting to login.", error);
            window.location.href = '/login';
            return null;
        }
        return session.access_token;
    }

    /**
     * Helper functions for auto-matching webhook fields.
     */
    function normalizeString(str) {
        if (!str) return '';
        return str.toLowerCase().replace(/[\s_-]/g, '');
    }

    function findBestMatch(tableColumnName, incomingFields) {
        const normalizedTableCol = normalizeString(tableColumnName);
        let bestMatch = null;
        let highestScore = 0;

        for (const field of incomingFields) {
            const normalizedField = normalizeString(field);
            let score = 0;

            if (normalizedTableCol === normalizedField) {
                score = 100; // Perfect match
            } else if (normalizedTableCol.includes(normalizedField) || normalizedField.includes(normalizedTableCol)) {
                // Prioritize longer matches to avoid 'id' matching 'grid'
                const similarity = Math.min(normalizedTableCol.length, normalizedField.length) / Math.max(normalizedTableCol.length, normalizedField.length);
                score = 50 * similarity; // Substring match, weighted by similarity
            }

            if (score > highestScore) {
                highestScore = score;
                bestMatch = field;
            }
        }
        return bestMatch;
    }

    function debounce(func, timeout = 300){
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    }

    async function fetchDbIdAndTables() {
        try {
            // 1. Fetch all databases to find the ID for the current dbName
            const dbsResponse = await fetchWithAuth('/api/v1/databases');
            if (!dbsResponse.ok) throw new Error('Could not fetch databases to find ID.');
            const databases = await dbsResponse.json();
            const currentDb = databases.find(db => db.name === state.dbName);
            
            if (!currentDb) throw new Error(`Database '${state.dbName}' not found.`);
            state.dbId = currentDb.id;

            // 2. Fetch tables for the found database ID
            const tablesResponse = await fetchWithAuth(`/api/v1/databases/${state.dbId}/tables`);
            if (!tablesResponse.ok) throw new Error('Could not fetch tables.');
            state.tables = await tablesResponse.json();
            renderTables(state.tables);

        } catch (error) {
            console.error(error);
            placeholderContent.textContent = `Error: ${error.message}`;
        }
    }

    function renderTables(tables) {
        tableList.innerHTML = '';
        if (tables.length === 0) {
            tableList.innerHTML = `<p class="text-sm text-gray-500 p-2">No tables yet.</p>`;
            return;
        }
        tables.forEach(table => {
            const tableLink = document.createElement('a');
            tableLink.href = '#'; // Use flex for icon alignment
            tableLink.className = 'flex items-center gap-3 p-2 rounded-md hover:bg-gray-100';
            tableLink.textContent = table.name;
            tableLink.dataset.tableId = table.id;
            tableList.appendChild(tableLink);
        });
    }

    function handleTableSelect(e) {
        if (e.target.tagName === 'A') {
            e.preventDefault();
            const tableId = e.target.dataset.tableId;
            state.selectedTable = state.tables.find(t => t.id == tableId);
            if (!state.selectedTable) return;

            tableList.querySelectorAll('a').forEach(a => a.classList.remove('bg-blue-100', 'text-blue-700', 'font-semibold'));
            e.target.classList.add('bg-blue-100', 'text-blue-700', 'font-semibold');
            
            mainContent.classList.remove('hidden');
            placeholderContent.classList.add('hidden');
            sqlRunnerView.classList.add('hidden');
            deleteTableBtn.disabled = false;
            tableTabContainer.classList.remove('hidden');

            // Reset to page 1 whenever a new table is selected
            renderStructure(state.selectedTable.columns);
            fetchAndRenderData(state.selectedTable.id, 1);
            renderTableSql(state.selectedTable);
            fetchAndRenderWebhooks(state.selectedTable.id);
            fetchAndRenderCalendarAutomation(state.selectedTable.id);
        }
    }

    function renderStructure(columns) {
        const tbody = document.getElementById('structure-tbody');
        tbody.innerHTML = ''; // Clear existing
        if (!columns || columns.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">This table has no columns defined.</td></tr>`;
            return;
        }

        columns.forEach((col, index) => {
            const tr = document.createElement('tr');
            const checkmark = `<span class="text-green-600 font-bold">&#10003;</span>`;
            tr.innerHTML = `
                <td class="p-3 font-mono">${col.name}</td>
                <td class="p-3 font-mono text-purple-600 uppercase">${col.type}</td>
                <td class="p-3 text-center">${col.is_not_null ? checkmark : ''}</td>
                <td class="p-3 text-center">${col.is_primary_key ? checkmark : ''}</td>
                <td class="p-3 text-center">${col.is_unique ? checkmark : ''}</td>
                <td class="p-3 font-mono text-xs">${col.foreign_key ? `-> ${col.foreign_key.table_id}.${col.foreign_key.column_name}` : ''}</td>
                <td class="p-3 text-center">
                    <div class="flex items-center justify-center gap-2">
                    ${!col.is_primary_key ? `
                        <button data-column-index="${index}" class="edit-column-btn text-gray-500 hover:text-blue-600" title="Edit Column"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg></button>
                        <button data-column-index="${index}" class="delete-column-btn text-gray-500 hover:text-red-600" title="Delete Column"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    ` : ''}
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function fetchAndRenderData(tableId, page = 1, searchTerm = '') {
        state.pagination.currentPage = page;
        const offset = (page - 1) * state.pagination.limit;

        const dataTable = document.querySelector('#data-tab-content table');
        const thead = dataTable.querySelector('thead');
        const tbody = document.getElementById('data-tbody');
        const columns = state.selectedTable.columns;
        const colspan = columns.length + 1;

        thead.innerHTML = ''; // Clear old header while loading
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="p-8 text-center text-gray-500"><div class="flex justify-center items-center gap-2"><svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Loading data...</span></div></td></tr>`;
        renderPagination(); // Render empty pagination while loading

        const searchParam = searchTerm ? `&search=${encodeURIComponent(searchTerm)}` : '';

        try {
            const response = await fetchWithAuth(`/api/v1/tables/${tableId}/rows?limit=${state.pagination.limit}&offset=${offset}${searchParam}`);
            if (!response.ok) throw new Error('Failed to fetch rows');
            const result = await response.json();
            const rows = result.data;
            state.pagination.totalRows = result.total;

            const headerRow = document.createElement('tr');
            // Add an empty header for the actions column
            headerRow.innerHTML += `<th class="p-3 w-12"></th>`;
            columns.forEach(col => {
                headerRow.innerHTML += `<th class="p-3 text-left font-semibold">${col.name}</th>`;
            });
            thead.innerHTML = '';
            thead.appendChild(headerRow);

            tbody.innerHTML = ''; // Clear loading indicator
            if (rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${columns.length + 1}" class="p-8 text-center text-gray-500">No data in this table.</td></tr>`;
                renderPagination();
                return;
            }

            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.dataset.rowId = row.id;
                // Add delete button cell
                tr.innerHTML += `
                    <td class="p-3 text-center">
                        <button data-row-id="${row.id}" class="delete-row-btn text-gray-400 hover:text-red-600" title="Delete Row">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                columns.forEach(col => {
                    // The backend now injects the user-visible PK into the data blob.
                    const cellValue = row.data ? (row.data[col.name] ?? '') : '';
                    const contentEditable = !col.is_primary_key ? 'contenteditable="true"' : '';

                    tr.innerHTML += `
                        <td class="p-3 font-mono text-sm editable-cell" data-column-name="${col.name}" ${contentEditable}>${cellValue}</td>
                    `;
                });
                tbody.appendChild(tr);
            });
            renderPagination();
        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="99" class="p-4 text-center text-red-500">Error loading data.</td></tr>`;
        }
    }

    function renderTableSql(table) {
        const codeElement = document.getElementById('table-sql-code');
        if (!table || !table.name) {
            codeElement.textContent = '-- No table selected --';
            return;
        }
        let createStatement = `CREATE TABLE "${table.name}" (\n`;
        const columnDefs = table.columns.map(col => {
            let colDef = `  "${col.name}" ${col.type.toUpperCase()}`;
            if (col.is_primary_key) colDef += " PRIMARY KEY";
            if (col.is_not_null) colDef += " NOT NULL";
            if (col.is_unique) colDef += " UNIQUE";
            return colDef;
        });
        createStatement += columnDefs.join(',\n');
        createStatement += "\n);";
        codeElement.textContent = createStatement;
        hljs.highlightElement(codeElement);
    }

    async function fetchAndRenderCalendarAutomation(tableId) {
        calendarAutomationContainer.innerHTML = `<div class="text-sm text-gray-500">Loading calendar settings...</div>`;
        try {
            const response = await fetchWithAuth(`/api/v1/tables/${tableId}/calendar-integration`);
 
            if (!response.ok) {
                let errorDetail = `HTTP error! status: ${response.status}`;
                try {
                    const errorJson = await response.json();
                    errorDetail = errorJson.detail || JSON.stringify(errorJson);
                } catch (e) {
                    errorDetail = response.statusText || `(Status: ${response.status})`;
                }
                // Throw an actual error object to ensure `error.message` is populated.
                throw new Error(`Failed to load settings: ${errorDetail}`);
            }

            // A 200 OK with a null body is a valid response meaning "no integration".
            // We need to check the content-length to avoid a JSON parsing error on an empty body.
            const contentLength = response.headers.get("content-length");
            const integration = contentLength && parseInt(contentLength, 10) > 0 ? await response.json() : null;

            state.calendarIntegration = integration;
            renderCalendarAutomation(integration);
        } catch (error) {
            console.error("Calendar Automation Error:", error);
            // Display a more informative error message
            calendarAutomationContainer.innerHTML = `<div class="text-sm text-red-500">Error loading calendar settings: ${error.message || 'An unknown error occurred.'}</div>`;
        }
    }

    function renderCalendarAutomation(integration) {
        const tableColumns = state.selectedTable.columns;

        if (!integration) {
            // Check for prerequisites before showing the connect button
            const hasDateColumn = tableColumns.some(c => ['timestamp'].includes(c.type));
            const hasNonPkColumn = tableColumns.some(c => !c.is_primary_key);

            if (!hasDateColumn || !hasNonPkColumn) {
                // Show prerequisite message
                calendarAutomationContainer.innerHTML = `
                    <div class="text-center">
                        <h3 class="font-semibold text-gray-700">Connect to your Calendar</h3>
                        <p class="mt-1 text-sm text-gray-500 max-w-xl mx-auto">Automatically create calendar events from new rows in this table.</p>
                        <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg text-left max-w-2xl mx-auto">
                            <h4 class="font-semibold text-amber-800">Prerequisites</h4>
                            <p class="text-sm text-amber-700 mt-2">To use calendar automation, your table must have:</p>
                            <ul class="list-disc list-inside text-sm text-amber-700 mt-2 space-y-1">
                                <li>At least one column with a date/time type (e.g., <code class="bg-amber-200 text-amber-900 px-1 rounded font-mono">TIMESTAMP</code>) to serve as the event's start time.</li>
                                <li>At least one other column (e.g., <code class="bg-amber-200 text-amber-900 px-1 rounded font-mono">TEXT</code>) to use for the event title.</li>
                            </ul>
                        </div>
                    </div>
                `;
            } else {
                // Prerequisites met, show connect button
                calendarAutomationContainer.innerHTML = `
                    <div class="text-center">
                        <h3 class="font-semibold text-gray-700">Connect to your Calendar</h3>
                        <p class="mt-1 text-sm text-gray-500 max-w-xl mx-auto">Automatically create calendar events from new rows in this table. Keep track of deadlines, appointments, and tasks without leaving your workflow.</p>
                        <button id="connect-google-calendar-btn" class="mt-4 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-50 font-semibold flex items-center gap-2 mx-auto">
                            <svg class="w-5 h-5" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M473.16,221.48l-2.26-9.59H262.46v88.22H387c-12.93,61.4-72.5,108.61-124.54,108.61-94.26,0-171-76.75-171-171s76.75-171,171-171c52.5,0,93.36,21.25,119.25,49.5l63.42-63.42C431.35,62.46,352.19,24,262.46,24,122.48,24,12,134.48,12,274s110.48,250,250.46,250c144.93,0,249.54-103.87,249.54-253.52,0-16.4-1.84-33.57-4.84-50Z" fill="#4285f4"/><path d="M473.16,221.48l-2.26-9.59H262.46v88.22H387c-12.93,61.4-72.5,108.61-124.54,108.61-94.26,0-171-76.75-171-171s76.75-171,171-171c52.5,0,93.36,21.25,119.25,49.5l63.42-63.42C431.35,62.46,352.19,24,262.46,24,122.48,24,12,134.48,12,274s110.48,250,250.46,250c144.93,0,249.54-103.87,249.54-253.52,0-16.4-1.84-33.57-4.84-50Z" fill-opacity="0" transform="translate(256 256) scale(0.5) translate(-256 -256)"/></svg>
                            Connect Google Calendar
                        </button>
                    </div>
                `;
            }
        } else {
            // Connected and mapping state
            const dateColumns = tableColumns.filter(c => ['timestamp', 'text', 'real', 'integer', 'serial'].includes(c.type)); // Allow text/numbers/serial for flexible date parsing
            const booleanColumns = tableColumns.filter(c => c.type === 'boolean');
            
            const columnOptions = (cols, selectedVal) => cols.map(c => `<option value="${c.name}" ${c.name === selectedVal ? 'selected' : ''}>${c.name}</option>`).join('');
            const optionalColumnOptions = (cols, selectedVal) => `<option value="">-- Optional --</option>${columnOptions(cols, selectedVal)}`;

            const mapping = integration.field_mapping || {};

            calendarAutomationContainer.innerHTML = `
                <form id="calendar-mapping-form">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-gray-800">Calendar Automation is Active</h3>
                            <p class="text-sm text-gray-500 mt-1">Connected to Google Calendar: <strong class="text-gray-700">${integration.account_email}</strong></p>
                        </div>
                        <button id="disconnect-calendar-btn" type="button" class="bg-red-100 text-red-700 px-3 py-1 rounded-md hover:bg-red-200 text-sm font-semibold">Disconnect</button>
                    </div>

                    <div class="mt-6 pt-6 border-t space-y-4">
                        <p class="text-sm font-medium text-gray-800">Map table columns to calendar event fields:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Event Title <span class="text-red-500">*</span></label>
                                <select name="event_title_col" required class="mt-1 w-full p-2 border rounded-md bg-white">
                                    ${columnOptions(tableColumns, mapping.event_title_col)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Description</label>
                                <select name="description_col" class="mt-1 w-full p-2 border rounded-md bg-white">
                                    ${optionalColumnOptions(tableColumns, mapping.description_col)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Start Date / Time <span class="text-red-500">*</span></label>
                                <select name="start_datetime_col" required class="mt-1 w-full p-2 border rounded-md bg-white">
                                    ${columnOptions(dateColumns, mapping.start_datetime_col)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">End Date / Time</label>
                                <select name="end_datetime_col" class="mt-1 w-full p-2 border rounded-md bg-white">
                                    ${optionalColumnOptions(dateColumns, mapping.end_datetime_col)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Completed Status Column</label>
                                <select name="completed_status_col" class="mt-1 w-full p-2 border rounded-md bg-white">
                                    ${optionalColumnOptions(booleanColumns, mapping.completed_status_col)}
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Select a BOOLEAN column. If a row's value is 'true', the event will be marked as completed.</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-md hover:bg-blue-700 font-semibold">Save Mapping</button>
                    </div>
                </form>
            `;
        }
    }

    async function fetchAndRenderWebhooks(tableId) {
        webhooksListContainer.innerHTML = `<div class="text-sm text-gray-500">Loading integrations...</div>`;
        try {
            const response = await fetchWithAuth(`/api/v1/tables/${tableId}/webhooks`);
            if (!response.ok) throw new Error('Failed to fetch webhooks');
            const webhooks = await response.json();
            renderWebhooks(webhooks);
        } catch (error) {
            console.error(error);
            webhooksListContainer.innerHTML = `<div class="text-sm text-red-500">Error loading integrations.</div>`;
        }
    }

    function renderWebhooks(webhooks) {
        webhooksListContainer.innerHTML = '';
        if (webhooks.length === 0) {
            webhooksListContainer.innerHTML = `<div class="text-center p-6 border-2 border-dashed rounded-lg text-gray-500">
                    <h3 class="font-semibold">No webhooks yet.</h3>
                    <p class="mt-1 text-sm">Create a webhook to start receiving data from external forms.</p>
                    <div class="mt-4 text-xs text-left bg-gray-100 p-3 rounded-md max-w-lg mx-auto">
                        <p class="font-semibold text-gray-600">Pro Tip:</p>
                        <p class="text-gray-500 mt-1">For best results, ensure your table has columns that match the fields you expect to receive (e.g., columns named <code class="bg-gray-200 text-gray-700 px-1 rounded font-mono">name</code>, <code class="bg-gray-200 text-gray-700 px-1 rounded font-mono">email</code>, <code class="bg-gray-200 text-gray-700 px-1 rounded font-mono">message</code>, etc.). This makes field mapping easier after you receive your first test submission.</p>
                    </div>
                </div>`;
            return;
        }
        webhooks.forEach(webhook => {
            const webhookCard = document.createElement('div');
            webhookCard.className = 'bg-white rounded-lg shadow-sm border p-4';
            webhookCard.dataset.webhookId = webhook.id;
            webhookCard.innerHTML = renderSingleWebhook(webhook);
            webhooksListContainer.appendChild(webhookCard);
        });
    }

    function renderSingleWebhook(webhook) {
        const webhookUrl = `${window.location.origin}/api/v1/webhooks/incoming/${webhook.webhook_token}`;
        const statusColors = {
            listening: 'bg-blue-100 text-blue-800',
            active: 'bg-green-100 text-green-800',
            disabled: 'bg-gray-100 text-gray-800'
        };

        let contentHtml = '';
        if (webhook.status === 'listening' && webhook.sample_payload) {
            // State: Ready for mapping
            const incomingFields = Object.keys(webhook.sample_payload);
            const tableColumns = state.selectedTable.columns.filter(c => !c.is_primary_key);

            const mappingFieldsHtml = tableColumns.map(col => {
                // Find the best match for the current table column among the incoming fields.
                const bestMatch = findBestMatch(col.name, incomingFields);
                return `
                    <div class="grid grid-cols-2 gap-4 items-center">
                        <label class="text-right font-medium text-gray-700">${col.name} <span class="font-mono text-xs text-purple-600">(${col.type})</span></label>
                        <select data-table-col="${col.name}" class="p-2 border rounded-md bg-white">
                            <option value="">-- Don't Import --</option>
                            ${incomingFields.map(h => `<option value="${h}" ${h === bestMatch ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                    </div>
                `;
            }).join('');

            contentHtml = `
                <form class="webhook-mapping-form">
                    <h4 class="font-semibold text-gray-800">Map Incoming Fields to Table Columns</h4>
                    <p class="text-sm text-gray-600 mt-1">We received a test submission. Match the fields from your form to the columns in your table.</p>
                    <div class="mt-4 space-y-2 border-t pt-4">
                        ${mappingFieldsHtml}
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold">Save and Activate</button>
                    </div>
                </form>
            `;
        } else if (webhook.status === 'listening') {
            // State: Listening for first submission
            contentHtml = `
                <div class="text-center p-4 bg-blue-50 rounded-md">
                    <h4 class="font-semibold text-blue-800">Listening for data...</h4>
                    <p class="text-sm text-blue-700 mt-1">To complete setup, submit a test entry from your form (e.g., from WordPress) or send a sample payload.</p>
                    <div class="mt-4 flex justify-center items-center gap-4">
                        <button data-webhook-url="${webhookUrl}" class="send-test-webhook-btn text-sm bg-white border border-blue-600 text-blue-600 px-3 py-1 rounded-md hover:bg-blue-50">Send Test Data</button>
                        <button data-webhook-id="${webhook.id}" class="refresh-webhook-btn text-sm text-blue-600 hover:underline">Check for data</button>
                    </div>
                </div>
            `;
        } else if (webhook.status === 'active') {
            // State: Active and running
            const fieldMapping = webhook.field_mapping || {};
            const hasMapping = Object.keys(fieldMapping).length > 0;

            const mappingHtml = hasMapping
                ? Object.entries(fieldMapping).map(([tableCol, formField]) => `
                    <div class="flex items-center gap-2">
                        <span class="font-mono text-sm text-gray-500">${formField}</span>
                        <span class="text-gray-400">&rarr;</span>
                        <span class="font-mono text-sm font-semibold text-gray-800">${tableCol}</span>
                    </div>
                `).join('')
                : '<p class="text-sm text-amber-700">No fields are currently mapped. This webhook will not insert any data.</p>';

            contentHtml = `
                <div class="p-4 bg-green-50 rounded-md">
                    <div class="flex justify-between items-center">
                        <h4 class="font-semibold text-green-800">Webhook is Active</h4>
                        <div class="flex items-center gap-2">
                            <button data-webhook-id="${webhook.id}" data-status="listening" class="toggle-webhook-status-btn text-sm bg-white border border-blue-600 text-blue-600 px-3 py-1 rounded-md hover:bg-blue-50">Re-map Fields</button>
                            <button data-webhook-id="${webhook.id}" data-status="disabled" class="toggle-webhook-status-btn text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300">Pause</button>
                        </div>
                    </div>
                    <p class="text-sm text-green-700 mt-2">This webhook is live and will insert data into your table based on the following mapping:</p>
                    <div class="mt-3 space-y-1">${mappingHtml}</div>
                </div>
            `;
        } else if (webhook.status === 'disabled') {
            // State: Disabled
            contentHtml = `
                <div class="p-4 bg-gray-50 rounded-md">
                    <div class="flex justify-between items-center">
                        <h4 class="font-semibold text-gray-800">Webhook is Disabled</h4>
                        <button data-webhook-id="${webhook.id}" data-status="active" class="toggle-webhook-status-btn text-sm bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700">Resume</button>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">This webhook is currently disabled and will not process any incoming data.</p>
                </div>
            `;
        }

        return `
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-semibold text-gray-500">Webhook URL</p>
                    <div class="flex items-center gap-2 mt-1">
                        <input type="text" readonly value="${webhookUrl}" class="w-full max-w-md p-2 font-mono text-xs bg-gray-100 border rounded-md">
                        <button data-url="${webhookUrl}" class="copy-webhook-url-btn p-2 rounded-md bg-gray-200 hover:bg-gray-300" title="Copy URL">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-xs font-medium px-2 py-1 rounded-full ${statusColors[webhook.status]}">${webhook.status.toUpperCase()}</span>
                    <button data-webhook-id="${webhook.id}" class="delete-webhook-btn text-gray-400 hover:text-red-600" title="Delete Webhook">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t">${contentHtml}</div>
        `;
    }

    tableTabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tab = button.dataset.tab;

            tableTabButtons.forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            button.classList.add('border-blue-500', 'text-blue-600');
            button.classList.remove('border-transparent', 'text-gray-500');

            document.querySelectorAll('.table-tab-content').forEach(content => {
                // Hide all main tab contents
                content.classList.add('hidden');
            });

            // Show the selected one
            const activeContent = document.getElementById(`${tab}-tab-content`);
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }
        });
    });


    // Modal Logic

    function openModal(modal) {
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
    }

    function closeModal(modal) {
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 250);
    }

    function toggleSidebar() {
        const isCollapsed = sidebar.classList.toggle('collapsed');
        if (isCollapsed) {
            sidebar.classList.remove('w-72');
            sidebar.classList.add('w-20');
        } else {
            sidebar.classList.remove('w-20');
            sidebar.classList.add('w-72');
        }
        document.getElementById('collapse-icon').classList.toggle('hidden', isCollapsed);
        document.getElementById('expand-icon').classList.toggle('hidden', !isCollapsed);
        
        // Save preference to local storage
        localStorage.setItem('sidebarCollapsed', isCollapsed);
    }

    function createColumnRow(isPk = false) {
        const id = `col-${Date.now()}`;
        const tableOptions = state.tables.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

        const div = document.createElement('div');
        div.className = 'column-row grid grid-cols-12 gap-2 items-center border-t pt-2';
        div.innerHTML = `
            <div class="col-span-12 grid grid-cols-12 gap-2 items-center">
                <input type="text" data-key="name" placeholder="column_name" required class="col-span-4 p-2 border rounded-md" ${isPk ? 'value="id" readonly' : ''}>
                <select data-key="type" class="col-span-3 p-2 border rounded-md bg-white" ${isPk ? 'disabled' : ''}>
                    ${isPk ? '<option value="serial" selected>SERIAL (PK)</option>' : `
                    <option value="text" selected>TEXT</option>
                    <option value="integer">INTEGER</option>
                    <option value="real">REAL</option>
                    <option value="boolean">BOOLEAN</option>
                    <option value="timestamp">TIMESTAMP</option>
                    <option value="jsonb">JSONB</option>
                    `}
                </select>
                <div class="col-span-4 flex items-center justify-around text-xs">
                    <label class="flex flex-col items-center"><input data-key="is_not_null" type="checkbox" class="h-4 w-4 rounded" ${isPk ? 'checked disabled' : ''}><span>Not Null</span></label>
                    <label class="flex flex-col items-center"><input data-key="is_unique" type="checkbox" class="h-4 w-4 rounded" ${isPk ? 'checked disabled' : ''}><span>Unique</span></label>
                </div>
            </div>
            <div class="col-span-12 mt-2 pl-1">
                <label class="flex items-center text-xs cursor-pointer"><input type="checkbox" data-key="is_foreign_key" class="fk-checkbox h-4 w-4 rounded mr-2" ${isPk ? 'disabled' : ''}><span>Is Foreign Key</span></label>
                <div class="fk-options-container hidden grid grid-cols-2 gap-2 mt-2 pl-6">
                    <select data-key="fk_table_id" class="fk-table-select p-1 border rounded-md bg-white text-xs">
                        <option value="">-- Select Table --</option>
                        ${tableOptions}
                    </select>
                    <select data-key="fk_column_name" class="fk-column-select p-1 border rounded-md bg-white text-xs" disabled><option value="">-- Select Column --</option></select>
                </div>
            </div>
            <div class="col-span-1 flex justify-end">
                ${!isPk ? '<button type="button" class="remove-column-btn text-red-500 hover:text-red-700">&times;</button>' : ''}
            </div>
            <input type="hidden" data-key="is_primary_key" value="${isPk}">
        `;
        return div;
    }

    function resetCreateTableModal() {
        document.getElementById('new-table-name').value = '';
        const columnsList = document.getElementById('new-columns-list');
        columnsList.innerHTML = '';
        columnsList.appendChild(createColumnRow(true)); // Add default PK
    }

    async function handleCreateTableSubmit(e) {
        e.preventDefault();
        const tableName = document.getElementById('new-table-name').value.trim();
        const columnRows = document.querySelectorAll('#new-columns-list .column-row');
        
        const columns = Array.from(columnRows).map(row => {
            const isFk = row.querySelector('[data-key="is_foreign_key"]').checked;
            let foreignKey = null;
            if (isFk) {
                const tableId = row.querySelector('[data-key="fk_table_id"]').value;
                const columnName = row.querySelector('[data-key="fk_column_name"]').value;
                if (tableId && columnName) {
                    foreignKey = {
                        table_id: parseInt(tableId, 10),
                        column_name: columnName
                    };
                }
            }
            return {
                name: row.querySelector('[data-key="name"]').value,
                type: row.querySelector('[data-key="type"]').value,
                is_primary_key: row.querySelector('[data-key="is_primary_key"]').value === 'true',
                is_not_null: row.querySelector('[data-key="is_not_null"]').checked,
                is_unique: row.querySelector('[data-key="is_unique"]').checked,
                foreign_key: foreignKey
            };
        });

        const payload = { name: tableName, columns };

        try {
            const response = await fetchWithAuth(`/api/v1/databases/${state.dbId}/tables`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to create table');
            }
            closeModal(createTableModal);
            const newTable = await response.json();
            await fetchDbIdAndTables(); // Refresh table list
            
            // Auto-select the newly created table
            const newTableLink = tableList.querySelector(`a[data-table-id="${newTable.id}"]`);
            if (newTableLink) {
                newTableLink.click();
            }
        } catch (error) {
            showError(error.message);
        }
    }

    async function handleDeleteTable() {
        if (!state.selectedTable) return;
        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}`, { method: 'DELETE' });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to delete table');
            }
            // Success
            closeModal(deleteTableModal);
            mainContent.classList.add('hidden');
            placeholderContent.classList.remove('hidden');
            tableTabContainer.classList.add('hidden');
            deleteTableBtn.disabled = true;
            state.selectedTable = null;
            await fetchDbIdAndTables(); // Refresh list
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    async function handleAddRow() {
        if (!state.selectedTable) return;
        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/rows`, { method: 'POST' });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to add row');
            }
            await fetchAndRenderData(state.selectedTable.id);
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    async function handleDeleteRow(rowId) {
        if (confirm('Are you sure you want to delete this row?')) {
            try {
                const response = await fetchWithAuth(`/api/v1/rows/${rowId}`, { method: 'DELETE' });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to delete row');
                }
                // On success, just remove the row from the UI for a faster feel
                document.querySelector(`button.delete-row-btn[data-row-id="${rowId}"]`).closest('tr').remove();
                state.pagination.totalRows -= 1;
                renderPagination();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
    }

    async function handleExportCsv() {
        if (!state.selectedTable) return;
        exportCsvBtn.textContent = 'Exporting...';
        exportCsvBtn.disabled = true;

        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/all-rows`);
            if (!response.ok) throw new Error('Could not fetch data for export.');

            const rows = await response.json();
            if (rows.length === 0) {
                alert('Table is empty, nothing to export.');
                return;
            }

            const columns = state.selectedTable.columns.map(c => c.name);
            const csvRows = [columns.join(',')]; // Header row

            rows.forEach(row => {
                const values = columns.map(colName => {
                    const value = colName === 'id' ? row.id : (row.data ? (row.data[colName] ?? '') : '');
                    // Basic CSV escaping: wrap in quotes if it contains a comma or quote
                    const strValue = String(value);
                    if (strValue.includes(',') || strValue.includes('"')) {
                        return `"${strValue.replace(/"/g, '""')}"`;
                    }
                    return strValue;
                });
                csvRows.push(values.join(','));
            });

            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.selectedTable.name}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        } catch (error) {
            alert(`Error exporting CSV: ${error.message}`);
        } finally {
            exportCsvBtn.textContent = 'Export to CSV';
            exportCsvBtn.disabled = false;
        }
    }

    async function handleUpdateRow(cellElement) {
        const tr = cellElement.closest('tr');
        const rowId = tr.dataset.rowId;
        if (!rowId) return;

        const pkColName = state.selectedTable.columns.find(c => c.is_primary_key)?.name;
        const rowData = {};
        // IMPORTANT: Only gather data from cells that are actually editable.
        // This correctly excludes the primary key from the data payload.
        tr.querySelectorAll('td.editable-cell[contenteditable="true"]').forEach(cell => {
            const colName = cell.dataset.columnName;
            // Exclude the user-visible PK from the update payload
            if (colName !== pkColName) {
                rowData[colName] = cell.innerText;
            }
        });

        const payload = { data: rowData };

        try {
            const response = await fetchWithAuth(`/api/v1/rows/${rowId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to update row');
            }
            // Visual feedback for success
            cellElement.style.transition = 'background-color 0.5s';
            cellElement.style.backgroundColor = '#dcfce7'; // Tailwind green-100
            setTimeout(() => {
                cellElement.style.backgroundColor = '';
            }, 1500);
        } catch (error) {
            alert(`Error saving data: ${error.message}`);
            fetchAndRenderData(state.selectedTable.id); // Revert UI on failure
        }
    }

    function renderPagination() {
        const { currentPage, limit, totalRows } = state.pagination;
        const paginationControls = document.getElementById('pagination-controls');
        paginationControls.innerHTML = '';

        if (totalRows === 0) {
            // Don't show pagination if there are no results
            return;
        }

        if (totalRows <= limit && currentPage === 1) return; // Also hide if only one page

        const totalPages = Math.ceil(totalRows / limit);
        const startRow = totalRows > 0 ? (currentPage - 1) * limit + 1 : 0;
        const endRow = Math.min(currentPage * limit, totalRows);

        const info = document.createElement('div');
        info.textContent = `Showing ${startRow} to ${endRow} of ${totalRows} rows`;
        
        const buttons = document.createElement('div');
        buttons.className = 'flex gap-2';
        buttons.innerHTML = `
            <button data-page="${currentPage - 1}" class="prev-page-btn px-3 py-1 border rounded-md bg-white hover:bg-gray-100" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
            <span class="px-3 py-1">Page ${currentPage} of ${totalPages}</span>
            <button data-page="${currentPage + 1}" class="next-page-btn px-3 py-1 border rounded-md bg-white hover:bg-gray-100" ${currentPage >= totalPages ? 'disabled' : ''}>Next</button>
        `;

        paginationControls.appendChild(info);
        paginationControls.appendChild(buttons);
    }

    async function saveTableStructure() {
        if (!state.selectedTable) return false;

        const payload = {
            name: state.selectedTable.name,
            columns: state.selectedTable.columns
        };

        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to update table structure');
            }

            const updatedTable = await response.json();
            const tableIndex = state.tables.findIndex(t => t.id === updatedTable.id);
            if (tableIndex > -1) state.tables[tableIndex] = updatedTable;
            state.selectedTable = updatedTable;
            await fetchAndRenderData(state.selectedTable.id, 1, searchInput.value.trim());
            renderStructure(state.selectedTable.columns);
            return true; // Success
        } catch (error) {
            alert(`Error: ${error.message}`);
            await fetchDbIdAndTables(); // Re-fetch to revert optimistic changes
            return false; // Failure
        }
    }

    function populateAndOpenEditModal(column, index) {
        document.getElementById('edit-column-index').value = index;
        document.getElementById('edit-column-name').value = column.name;
        document.getElementById('edit-column-type').value = column.type;
        document.getElementById('edit-is-not-null').checked = column.is_not_null;
        document.getElementById('edit-is-unique').checked = column.is_unique;
        openModal(editColumnModal);
    }

    async function handleEditColumnSubmit(e) {
        e.preventDefault();
        const index = parseInt(document.getElementById('edit-column-index').value, 10);
        state.selectedTable.columns[index].name = document.getElementById('edit-column-name').value;
        state.selectedTable.columns[index].type = document.getElementById('edit-column-type').value;
        state.selectedTable.columns[index].is_not_null = document.getElementById('edit-is-not-null').checked;
        state.selectedTable.columns[index].is_unique = document.getElementById('edit-is-unique').checked;
        
        if (await saveTableStructure()) {
            closeModal(editColumnModal);
        }
    }

    function renderQueryResults(result) {
        queryResultsContainer.innerHTML = '';
        if (result.error) {
            queryResultsContainer.innerHTML = `
                <div class="p-4 border-b bg-red-50 text-red-700 font-semibold">Error</div>
                <div class="p-4 font-mono text-sm text-red-600 whitespace-pre-wrap">${result.error}</div>
            `;
            return;
        }

        const data = result.data;

        // Handle success message from INSERT/UPDATE/DELETE
        if (data && data.status === 'success') {
            queryResultsContainer.innerHTML = `
                <div class="p-4 border-b bg-green-50 text-green-700 font-semibold">Success</div>
                <div class="p-4 text-gray-600">${data.message}</div>
            `;
            return;
        }

        // Handle empty result set from SELECT
        if (!Array.isArray(data) || data.length === 0) {
            queryResultsContainer.innerHTML = `
                <div class="p-4 border-b font-semibold">Success</div>
                <div class="p-4 text-gray-500">Query executed successfully, but returned no rows.</div>
            `;
            return;
        }

        const headers = Object.keys(data[0]);
        const table = document.createElement('table');
        table.className = 'min-w-full text-sm';
        table.innerHTML = `
            <thead class="bg-gray-50">
                <tr>${headers.map(h => `<th class="p-3 text-left font-semibold">${h}</th>`).join('')}</tr>
            </thead>
            <tbody class="divide-y">
                ${data.map(row => `<tr>${headers.map(h => `<td class="p-3 font-mono">${row[h]}</td>`).join('')}</tr>`).join('')}
            </tbody>
        `;
        queryResultsContainer.appendChild(table);
    }

    async function handleRunQuery() {
        const query = sqlRunnerEditor.getValue().trim();
        if (!query) return;

        runQueryBtn.disabled = true;
        runQueryBtn.textContent = 'Running...';
        queryResultsContainer.innerHTML = `<div class="p-4 text-gray-500 flex items-center gap-2"><svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Executing query...</div>`;

        try {
            const response = await fetchWithAuth(`/api/v1/databases/${state.dbId}/execute-query`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });
            const result = await response.json();
            if (!response.ok) {
                renderQueryResults({ error: result.detail || 'An unknown error occurred.' });
            } else {
                renderQueryResults({ data: result });
            }
        } catch (error) {
            renderQueryResults({ error: error.message });
        }

        runQueryBtn.disabled = false;
        runQueryBtn.textContent = 'Run Query';
    }

    async function handleViewDbSql() {
        if (!state.dbId) return;
        
        dbSqlCodeContent.textContent = 'Loading SQL...';
        openModal(viewDbSqlModal);

        try {
            const response = await fetchWithAuth(`/api/v1/databases/${state.dbId}/export-sql`);
            if (!response.ok) throw new Error('Failed to fetch database SQL');
            
            const sqlText = await response.text();
            dbSqlCodeContent.textContent = sqlText;
            hljs.highlightElement(dbSqlCodeContent);
        } catch (error) {
            dbSqlCodeContent.textContent = `-- Error fetching SQL: ${error.message}`;
        }
    }

    // Sidebar Toggle Event Listener
    toggleSidebarBtn.addEventListener('click', toggleSidebar);
    // Event Listeners
    tableList.addEventListener('click', handleTableSelect);
    addRowBtn.addEventListener('click', handleAddRow);
    importRowsBtn.addEventListener('click', () => {
        if (!state.selectedTable) return;
        document.getElementById('import-rows-table-name').textContent = state.selectedTable.name;
        importRowsForm.reset();
        document.getElementById('import-rows-mapping-container').classList.add('hidden');
        importRowsForm.querySelector('button[type="submit"]').disabled = true;
        openModal(importRowsModal);
        closeModal(importSummaryModal);
    });
    cancelImportRowsBtn.addEventListener('click', () => closeModal(importRowsModal));

    importCsvBtn.addEventListener('click', () => {
        importCsvForm.reset();
        importStep1.classList.remove('hidden');
        importStep2.classList.add('hidden');
        importCsvNextBtn.classList.remove('hidden');
        importCsvSubmitBtn.classList.add('hidden');
        importCsvNextBtn.disabled = true;
        openModal(importCsvModal);
    });
    cancelImportCsvBtn.addEventListener('click', () => closeModal(importCsvModal));

    importCsvFile.addEventListener('change', () => {
        const file = importCsvFile.files[0];
        importCsvNextBtn.disabled = !file;
        if (file) {
            importTableName.value = file.name.replace(/\.csv$/i, '').replace(/[^a-z0-9_]+/gi, '_').toLowerCase();
        }
    });

    importCsvNextBtn.addEventListener('click', async () => {
        const file = importCsvFile.files[0];
        const tableName = importTableName.value.trim();
        if (!file || !tableName) {
            showError('Table name and CSV file are required.');
            return;
        }

        importCsvNextBtn.disabled = true;
        importCsvNextBtn.textContent = 'Processing...';

        const reader = new FileReader();
        reader.onload = async (e) => {
            const csvContent = e.target.result;
            try {
                const response = await fetchWithAuth('/api/v1/import-csv/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ csv_content: csvContent })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to preview CSV.');
                }
                const previewData = await response.json();
                
                // Populate review table
                csvReviewTbody.innerHTML = '';
                let pk_found = false;
                previewData.sanitized_headers.forEach((header, i) => {
                    const is_pk = header === 'id' && !pk_found;
                    if (is_pk) pk_found = true;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-2 font-mono text-gray-600">${previewData.original_headers[i]}</td>
                        <td class="p-2 font-mono">${header}</td>
                        <td class="p-2">
                            <select data-col-name="${header}" class="csv-col-type-select w-full p-1 border rounded-md bg-white">
                                <option value="text">TEXT</option>
                                <option value="integer">INTEGER</option>
                                <option value="real">REAL</option>
                                <option value="boolean">BOOLEAN</option>
                                <option value="timestamp">TIMESTAMP</option>
                            </select>
                        </td>
                        <td class="p-2 text-center">
                            <input type="checkbox" data-col-name="${header}" class="csv-col-pk-checkbox h-4 w-4 rounded" ${is_pk ? 'checked' : ''}>
                        </td>
                    `;
                    csvReviewTbody.appendChild(tr);
                    tr.querySelector('.csv-col-type-select').value = previewData.inferred_types[i];
                });

                // Switch to step 2
                importStep1.classList.add('hidden');
                importStep2.classList.remove('hidden');
                importCsvNextBtn.classList.add('hidden');
                importCsvSubmitBtn.classList.remove('hidden');

            } catch (error) {
                showError(error.message);
            } finally {
                importCsvNextBtn.disabled = false;
                importCsvNextBtn.textContent = 'Review Columns';
            }
        };
        reader.readAsText(file);
    });

    importCsvForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const tableName = importTableName.value.trim();

        // Gather column definitions from the review step
        const columns = [];
        csvReviewTbody.querySelectorAll('tr').forEach(tr => {
            const name = tr.children[1].textContent;
            const type = tr.querySelector('.csv-col-type-select').value;
            const is_pk = tr.querySelector('.csv-col-pk-checkbox').checked;
            columns.push({
                name: name,
                type: type,
                is_primary_key: is_pk,
                is_not_null: is_pk, // Default not null for PK
                is_unique: is_pk, // Default unique for PK
                foreign_key: null
            });
        });

        importCsvSubmitBtn.disabled = true;
        importCsvSubmitBtn.textContent = 'Importing...';

        const fileReader = new FileReader();
        fileReader.onload = async (e) => {
            const csvContent = e.target.result;
            const payload = {
                name: tableName,
                csv_content: csvContent,
                columns: columns
            };

            try {
                const response = await fetchWithAuth(`/api/v1/databases/${state.dbId}/import-csv`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to import CSV.');
                }
                closeModal(importCsvModal);
                const newTable = await response.json();
                await fetchDbIdAndTables();
                const newTableLink = tableList.querySelector(`a[data-table-id="${newTable.id}"]`);
                if (newTableLink) newTableLink.click();
            } catch (error) {
                showError(error.message);
            } finally {
                importCsvSubmitBtn.disabled = false;
                importCsvSubmitBtn.textContent = 'Create Table & Import';
            }
        };
        fileReader.readAsText(importCsvFile.files[0]);
    });

    importRowsCsvFile.addEventListener('change', () => {
        const file = importRowsCsvFile.files[0];
        const mappingContainer = document.getElementById('import-rows-mapping-container');
        const mappingFields = document.getElementById('import-rows-mapping-fields');
        const submitBtn = importRowsForm.querySelector('button[type="submit"]');

        if (!file) {
            mappingContainer.classList.add('hidden');
            submitBtn.disabled = true;
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const firstLine = e.target.result.split('\n')[0].trim();
            const csvHeaders = firstLine.split(',').map(h => h.trim().replace(/"/g, ''));
            const tableColumns = state.selectedTable.columns.filter(c => !c.is_primary_key);

            mappingFields.innerHTML = '';
            tableColumns.forEach(col => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-2 gap-4 items-center';
                div.innerHTML = `
                    <label class="text-right font-medium text-gray-700">${col.name} <span class="font-mono text-xs text-purple-600">(${col.type})</span></label>
                    <select data-table-col="${col.name}" class="import-rows-col-select p-2 border rounded-md bg-white">
                        <option value="">-- Don't Import --</option>
                        ${csvHeaders.map(h => `<option value="${h}">${h}</option>`).join('')}
                    </select>
                `;
                mappingFields.appendChild(div);
                // Auto-select if header matches column name
                const matchingHeader = csvHeaders.find(h => h.toLowerCase().replace(/[\s_]+/g, '') === col.name.toLowerCase().replace(/[\s_]+/g, ''));
                if (matchingHeader) {
                    div.querySelector('select').value = matchingHeader;
                }
            });
            mappingContainer.classList.remove('hidden');
            submitBtn.disabled = false;
        };
        reader.readAsText(file);
    });

    importRowsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = importRowsCsvFile.files[0];
        if (!file || !state.selectedTable) return;

        const columnMapping = {};
        document.querySelectorAll('.import-rows-col-select').forEach(select => {
            if (select.value) {
                columnMapping[select.dataset.tableCol] = select.value;
            }
        });

        if (Object.keys(columnMapping).length === 0) {
            showError('You must map at least one CSV column.');
            return;
        }

        const submitBtn = importRowsForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Importing...';

        const reader = new FileReader();
        reader.onload = async (e) => {
            const csvContent = e.target.result;
            try {
                const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/import-rows-from-csv`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ csv_content: csvContent, column_mapping: columnMapping })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to import rows.');
                }
                const result = await response.json();
                closeModal(importRowsModal);
                
                // Show summary modal
                const summaryContent = document.getElementById('import-summary-content');
                summaryContent.innerHTML = `
                    <p><strong class="font-semibold text-green-600">${result.inserted_count}</strong> rows were successfully imported.</p>
                    <p><strong class="font-semibold text-red-600">${result.failed_count}</strong> rows failed to import.</p>
                `;
                if (result.failed_count > 0) {
                    const errorReportLink = document.createElement('a');
                    errorReportLink.href = "#";
                    errorReportLink.className = "text-blue-600 hover:underline font-semibold";
                    errorReportLink.textContent = "Download Error Report (CSV)";
                    errorReportLink.onclick = (e) => {
                        e.preventDefault();
                        generateErrorCsv(result.errors);
                    };
                    const p = document.createElement('p');
                    p.className = "mt-4";
                    p.appendChild(errorReportLink);
                    summaryContent.appendChild(p);
                }
                openModal(importSummaryModal);

                if (result.inserted_count > 0) {
                    await fetchAndRenderData(state.selectedTable.id, 1); // Refresh data view if anything was inserted
                }
            } catch (error) {
                showError(error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Import Rows';
            }
        };
        reader.readAsText(file);
    });

    closeSummaryModalBtn.addEventListener('click', () => closeModal(importSummaryModal));

    function generateErrorCsv(errors) {
        if (!errors || errors.length === 0) return;

        const originalHeaders = Object.keys(errors[0].data);
        const csvHeaders = ['Row Number', 'Error', ...originalHeaders];
        
        const csvRows = [csvHeaders.join(',')]; // Header row

        errors.forEach(err => {
            const values = [
                err.row_number,
                `"${err.error.replace(/"/g, '""')}"`, // Escape quotes in error message
                ...originalHeaders.map(h => {
                    const value = err.data[h] ?? '';
                    const strValue = String(value);
                    if (strValue.includes(',') || strValue.includes('"')) {
                        return `"${strValue.replace(/"/g, '""')}"`;
                    }
                    return strValue;
                })
            ];
            csvRows.push(values.join(','));
        });

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `import_error_report.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }
    
    createTableBtn.addEventListener('click', () => {
        resetCreateTableModal();
        openModal(createTableModal);
    });
    cancelCreateTableBtn.addEventListener('click', () => closeModal(createTableModal));
    createTableForm.addEventListener('submit', handleCreateTableSubmit);
    
    deleteTableBtn.addEventListener('click', () => {
        if (!state.selectedTable) return;
        modalTableName.textContent = state.selectedTable.name;
        openModal(deleteTableModal);
    });
    cancelDeleteTableBtn.addEventListener('click', () => closeModal(deleteTableModal));
    confirmDeleteTableBtn.addEventListener('click', handleDeleteTable);

    editColumnForm.addEventListener('submit', handleEditColumnSubmit);
    cancelEditColumnBtn.addEventListener('click', () => closeModal(editColumnModal));

    structureTbody.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-column-btn');
        const deleteBtn = e.target.closest('.delete-column-btn');

        if (editBtn) {
            const index = parseInt(editBtn.dataset.columnIndex, 10);
            populateAndOpenEditModal(state.selectedTable.columns[index], index);
        }

        if (deleteBtn) {
            const index = parseInt(deleteBtn.dataset.columnIndex, 10);
            const column = state.selectedTable.columns[index];
            if (confirm(`Are you sure you want to delete the column "${column.name}"?`)) {
                state.selectedTable.columns.splice(index, 1);
                saveTableStructure();
            }
        }
    });
    dataTbody.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-row-btn');
        if (deleteBtn) {
            const rowId = deleteBtn.dataset.rowId;
            handleDeleteRow(rowId);
        }
    });

    document.getElementById('copy-table-sql-btn').addEventListener('click', (e) => {
        const code = document.getElementById('table-sql-code').textContent;
        navigator.clipboard.writeText(code).then(() => {
            e.target.textContent = 'Copied!';
            setTimeout(() => e.target.textContent = 'Copy', 2000);
        });
    });
    runQueryBtn.addEventListener('click', handleRunQuery);
    exportCsvBtn.addEventListener('click', handleExportCsv);

    viewDbSqlBtn.addEventListener('click', handleViewDbSql);
    closeDbSqlModalBtn.addEventListener('click', () => closeModal(viewDbSqlModal));

    sqlRunnerBtn.addEventListener('click', () => {
        // Hide other main views
        mainContent.classList.add('hidden');
        placeholderContent.classList.add('hidden');
        // Show the SQL runner
        sqlRunnerView.classList.remove('hidden');
        // Visually deselect any selected table
        tableList.querySelectorAll('a').forEach(a => a.classList.remove('bg-blue-100', 'text-blue-700', 'font-semibold'));
        state.selectedTable = null;
        deleteTableBtn.disabled = true;
    });
    dataTbody.addEventListener('blur', (e) => {
        // The 'blur' event fires when a user clicks away from an editable cell.
        if (e.target.classList.contains('editable-cell') && e.target.hasAttribute('contenteditable')) {
            handleUpdateRow(e.target);
        }
    }, true); // Use capture phase to handle event delegation properly

    dataTbody.addEventListener('keydown', (e) => {
        // When the user presses Enter in an editable cell, treat it as a confirmation.
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // Prevents adding a new line in the cell.
            const cell = e.target;
            cell.blur(); // Trigger the blur event, which calls the save function.
        }
    });

    const debouncedSearch = debounce(() => {
        const searchTerm = searchInput.value.trim();
        if (state.selectedTable) {
            fetchAndRenderData(state.selectedTable.id, 1, searchTerm);
        }
    });

    searchInput.addEventListener('input', debouncedSearch);

    document.getElementById('pagination-controls').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (target && (target.classList.contains('prev-page-btn') || target.classList.contains('next-page-btn'))) {
            const page = parseInt(target.dataset.page, 10);
            if (page && state.selectedTable) {
                fetchAndRenderData(state.selectedTable.id, page);
            }
        }
    });
    addColumnToModalBtn.addEventListener('click', () => {
        document.getElementById('new-columns-list').appendChild(createColumnRow());
    });

    document.getElementById('new-columns-list').addEventListener('change', (e) => {
        // FK checkbox toggle
        if (e.target.classList.contains('fk-checkbox')) {
            const container = e.target.closest('.column-row').querySelector('.fk-options-container');
            container.classList.toggle('hidden', !e.target.checked);
        }
        // FK table select
        if (e.target.classList.contains('fk-table-select')) {
            const tableId = e.target.value;
            const columnSelect = e.target.closest('.fk-options-container').querySelector('.fk-column-select');
            columnSelect.innerHTML = '<option value="">-- Select Column --</option>';
            columnSelect.disabled = true;

            if (tableId) {
                const targetTable = state.tables.find(t => t.id == tableId);
                if (targetTable) {
                    targetTable.columns.forEach(col => {
                        columnSelect.innerHTML += `<option value="${col.name}">${col.name}</option>`;
                    });
                    columnSelect.disabled = false;
                }
            }
        }
    });

    document.getElementById('new-columns-list').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-column-btn')) {
            e.target.closest('.column-row').remove();
        }
    });

    createWebhookBtn.addEventListener('click', async () => {
        if (!state.selectedTable) return;
        createWebhookBtn.disabled = true;
        createWebhookBtn.textContent = 'Creating...';
        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/webhooks`, { method: 'POST' });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to create webhook');
            }
            await fetchAndRenderWebhooks(state.selectedTable.id);
        } catch (error) {
            showError(error.message);
        } finally {
            createWebhookBtn.disabled = false;
            createWebhookBtn.textContent = 'Create New Webhook';
        }
    });

    webhooksListContainer.addEventListener('click', async (e) => {
        const copyBtn = e.target.closest('.copy-webhook-url-btn');
        if (copyBtn) {
            navigator.clipboard.writeText(copyBtn.dataset.url).then(() => {
                // Maybe add a "Copied!" tooltip later
            });
        }

        const deleteBtn = e.target.closest('.delete-webhook-btn');
        if (deleteBtn && confirm('Are you sure you want to delete this webhook?')) {
            const webhookId = deleteBtn.dataset.webhookId;
            const response = await fetchWithAuth(`/api/v1/webhooks/${webhookId}`, { method: 'DELETE' });
            if (response.ok) {
                deleteBtn.closest('[data-webhook-id]').remove();
            } else {
                showError('Failed to delete webhook.');
            }
        }

        const refreshBtn = e.target.closest('.refresh-webhook-btn');
        if (refreshBtn) {
            await fetchAndRenderWebhooks(state.selectedTable.id);
        }

        const toggleBtn = e.target.closest('.toggle-webhook-status-btn');
        if (toggleBtn) {
            const webhookId = toggleBtn.dataset.webhookId;
            const newStatus = toggleBtn.dataset.status;
            const response = await fetchWithAuth(`/api/v1/webhooks/${webhookId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            if (response.ok) {
                await fetchAndRenderWebhooks(state.selectedTable.id);
            } else {
                showError(`Failed to change status to ${newStatus}.`);
            }
        }

        const testBtn = e.target.closest('.send-test-webhook-btn');
        if (testBtn) {
            const webhookUrl = testBtn.dataset.webhookUrl;
            testBtn.disabled = true;
            testBtn.textContent = 'Sending...';

            const samplePayload = {
                name: "Jane Doe",
                email: "test@example.com",
                company: "Acme Inc.",
                message: "This is a test submission to help map fields."
            };

            try {
                // This is a public endpoint, so no auth is needed.
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(samplePayload)
                });

                if (!response.ok) throw new Error('Failed to send test data.');
                
                // Success! Refresh the UI to show the mapping view.
                setTimeout(() => fetchAndRenderWebhooks(state.selectedTable.id), 500);
            } catch (error) {
                showError(error.message);
                testBtn.disabled = false;
                testBtn.textContent = 'Send Test Data';
            }
        }
    });

    calendarAutomationContainer.addEventListener('click', async (e) => {
        const connectBtn = e.target.closest('#connect-google-calendar-btn');
        if (connectBtn) {
            connectBtn.disabled = true;
            connectBtn.textContent = 'Connecting...';

            if (!googleClientId) {
                showError("Google Client ID is not configured on the server. Cannot initiate login.");
                connectBtn.disabled = false; // Re-enable button
                connectBtn.textContent = 'Connect Google Calendar';
                return;
            }

            // --- Start Real Google OAuth2 Flow ---
            const client = google.accounts.oauth2.initCodeClient({
                client_id: googleClientId,
                scope: 'https://www.googleapis.com/auth/calendar.events openid email profile',
                ux_mode: 'popup',
                callback: async (response) => {
                    // This callback is executed after the user grants permission in the popup.
                    // The `response.code` is the one-time authorization code.
                    try {
                        // 1. Exchange the code for credentials via our backend
                        const tokenResponse = await fetchWithAuth('/api/v1/google/oauth2callback', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: response.code })
                        });
                        if (!tokenResponse.ok) {
                            const err = await tokenResponse.json();
                            throw new Error(err.detail || 'Failed to get Google credentials.');
                        }
                        const credentials = await tokenResponse.json();

                        // 2. Now, save the integration with the new credentials
                        const availableTitleCols = state.selectedTable.columns.filter(c => !c.is_primary_key);
                        const integrationData = {
                            provider: "google",
                            account_email: credentials.id_token_jwt.email, // Extract email from the ID token
                            calendar_id: "primary",
                            credentials: credentials, // The full credentials object from our backend
                            field_mapping: {
                                event_title_col: availableTitleCols.find(c => c.name.includes('title') || c.name.includes('name'))?.name || availableTitleCols[0].name,
                                start_datetime_col: state.selectedTable.columns.find(c => c.type === 'timestamp' || c.name.includes('date'))?.name || availableTitleCols[0].name,
                            }
                        };

                        const saveResponse = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/calendar-integration`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(integrationData)
                        });
                        if (!saveResponse.ok) throw new Error('Failed to save calendar integration.');
                        
                        state.calendarIntegration = await saveResponse.json();
                        renderCalendarAutomation(state.calendarIntegration);

                    } catch (error) {
                        showError(error.message);
                        connectBtn.disabled = false;
                        connectBtn.textContent = 'Connect Google Calendar';
                    }
                },
            });
            // 3. Trigger the Google login popup
            client.requestCode();
        }

        const disconnectBtn = e.target.closest('#disconnect-calendar-btn');
        if (disconnectBtn) {
            if (confirm('Are you sure you want to disconnect your calendar? This will stop creating new events.')) {
                try {
                    const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/calendar-integration`, { method: 'DELETE' });
                    if (response.ok) {
                        state.calendarIntegration = null;
                        renderCalendarAutomation(null);
                    } else {
                        throw new Error('Failed to disconnect calendar.');
                    }
                } catch (error) {
                    showError(error.message);
                }
            }
        }
    });

    calendarAutomationContainer.addEventListener('submit', async (e) => {
        if (e.target.id === 'calendar-mapping-form') {
            e.preventDefault();
            const formData = new FormData(e.target);
            const fieldMapping = {};
            for (const [key, value] of formData.entries()) {
                if (value) { // Only include fields that have a value selected
                    fieldMapping[key] = value;
                }
            }

            const payload = {
                ...state.calendarIntegration, // Keep existing provider, email, etc.
                field_mapping: fieldMapping
            };

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/calendar-integration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('Failed to save mapping.');
                
                state.calendarIntegration = await response.json();
                renderCalendarAutomation(state.calendarIntegration); // Re-render to confirm
            } catch (error) {
                showError(error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Mapping';
            }
        }
    });

    // Initialize CodeMirror editors
    sqlRunnerEditor = CodeMirror.fromTextArea(document.getElementById('sql-query-input'), {
        mode: 'text/x-sql',
        theme: 'material-darker',
        lineNumbers: true,
        lineWrapping: true,
    });

    createTableSqlEditor = CodeMirror.fromTextArea(document.getElementById('create-table-sql-input'), {
        mode: 'text/x-sql',
        theme: 'material-darker',
        lineNumbers: true,
        lineWrapping: true,
    });

    // We need to refresh the editor when its container becomes visible
    createTableBtn.addEventListener('click', () => {
        // A short delay ensures the modal is visible before refreshing
        setTimeout(() => createTableSqlEditor.refresh(), 10);
    });

    webhooksListContainer.addEventListener('submit', async (e) => {
        if (e.target.classList.contains('webhook-mapping-form')) {
            e.preventDefault();
            const form = e.target;
            const webhookId = form.closest('[data-webhook-id]').dataset.webhookId;
            
            const fieldMapping = {};
            form.querySelectorAll('select[data-table-col]').forEach(select => {
                if (select.value) {
                    fieldMapping[select.dataset.tableCol] = select.value;
                }
            });

            const payload = {
                field_mapping: fieldMapping,
                status: 'active'
            };

            const response = await fetchWithAuth(`/api/v1/webhooks/${webhookId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (response.ok) await fetchAndRenderWebhooks(state.selectedTable.id);
        }
    });

    // Check for saved sidebar state on load
    if (localStorage.getItem('sidebarCollapsed') === 'true') {
        toggleSidebar();
    }
    // Initial Load
    supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION' || event === 'TOKEN_REFRESHED') {
            if (session) {
                localStorage.setItem('supabase_token', session.access_token);
                // Only fetch initial data on sign in, not on every token refresh
                if (event !== 'TOKEN_REFRESHED') {
                    fetchDbIdAndTables();
                }
            } else {
                window.location.href = '/login';
            }
        } else if (event === 'SIGNED_OUT') {
            window.location.href = '/login';
        }
    });
});
</script>

</body>
</html>