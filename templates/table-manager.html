<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Manager - FormPipeDB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code&display=swap" rel="stylesheet">
    
    <!-- FullCalendar for Calendar view -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
    <!-- Tippy.js for event popovers -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <!-- CodeMirror for SQL editor -->

    <!-- Highlight.js for static code views -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style> 
        body { font-family: 'Inter', sans-serif; } .CodeMirror { font-family: 'Fira Code', monospace; border-radius: 0.375rem; height: 10rem; }
        :root { /* Fix: Use a class or direct element styling instead of :root for component-specific vars */
            --fc-border-color: #e2e8f0;
            --fc-daygrid-event-dot-width: 8px;
            --fc-list-event-hover-bg-color: #f3f4f6;
            --fc-today-bg-color: rgba(59, 130, 246, 0.08);
        }
        .fc .fc-button-primary { background-color: #2563eb; border-color: #2563eb; }
        .modal { transition: opacity 0.3s ease-in-out; }
        #sidebar, #main-content { transition: all 0.3s ease-in-out; }
        .sidebar-item-title, #sidebar-header-text, #sidebar-footer-text { transition: opacity 0.2s, width 0.2s; }
        #sidebar.collapsed .sidebar-item-title, #sidebar.collapsed #sidebar-header-text, #sidebar.collapsed #sidebar-footer-text {
            opacity: 0;
            width: 0;
            overflow: hidden;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-50">

<div class="h-screen flex">
    <!-- Collapsible Sidebar -->
    <aside id="sidebar" class="w-72 bg-white border-r flex flex-col shrink-0">
        <div class="p-4 border-b">
            <a href="/app" class="text-2xl font-bold text-black">FormPipeDB</a>
            <div id="sidebar-header-text" class="mt-2">
                <h1 class="text-2xl font-bold text-gray-800 mt-1 truncate" title="{{ db_name }}">{{ db_name }}</h1>
            </div>
        </div>
        <div class="p-4 border-b">
            <h2 id="sidebar-header-text" class="text-lg font-semibold text-gray-700">Tables</h2>
        </div>
        <nav id="table-list" class="flex-1 p-4 space-y-1 overflow-y-auto">
            <!-- Loading state -->
            <div class="flex items-center gap-2 text-sm text-gray-500 p-2">
                <svg class="animate-spin h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span class="sidebar-item-title">Loading tables...</span>
            </div>
        </nav>
        <div class="p-4 border-t space-y-2 overflow-hidden">
            <button id="create-table-btn" class="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 font-semibold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg><span class="sidebar-item-title">Create Table</span></button>
            <button id="import-csv-btn" class="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-purple-600 text-white hover:bg-purple-700 font-semibold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span class="sidebar-item-title">Import CSV</span></button>
            <button id="calendar-btn" class="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-yellow-500 text-white hover:bg-yellow-600 font-semibold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="sidebar-item-title">Calendar</span></button>
            <button id="view-db-sql-sidebar-btn" class="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 font-semibold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7v5c0 2.21 3.582 4 8 4s8-1.79 8-4V7"></path></svg><span class="sidebar-item-title">View DB SQL</span></button>
            <button id="delete-table-btn" class="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-red-100 text-red-700 hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span class="sidebar-item-title">Delete Table</span></button>
        </div>
        <div class="p-2 border-t">
            <button id="toggle-sidebar-btn" class="w-full flex items-center justify-center p-2 rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-800">
                <svg id="collapse-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                <svg id="expand-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </aside>

    <main id="main-content" class="flex-1 p-4 md:p-8 overflow-auto hidden">
        <div id="table-tabs-container" class="border-b mb-6 overflow-x-auto">
            <nav class="flex space-x-6 whitespace-nowrap">
                <button data-tab="data" class="table-tab-btn py-2 px-1 font-medium border-b-2 border-blue-500 text-blue-600">Data</button>
                <button data-tab="structure" class="table-tab-btn py-2 px-1 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Structure</button>
                <button data-tab="integrations" class="table-tab-btn py-2 px-1 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Integrations</button>
                <button data-tab="table-sql" class="table-tab-btn py-2 px-1 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">SQL</button>
            </nav>
        </div>

        <div id="structure-tab-content" class="table-tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left font-semibold">Column Name</th>
                                <th class="p-3 text-left font-semibold">Data Type</th>
                                <th class="p-3 text-center font-semibold">Not Null</th>
                                <th class="p-3 text-center font-semibold">Primary Key</th>
                                <th class="p-3 text-center font-semibold">Unique</th>
                                <th class="p-3 text-left font-semibold">Foreign Key</th>
                                <th class="p-3 text-center font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="structure-tbody" class="divide-y">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="table-sql-tab-content" class="table-tab-content hidden">
            <h3 class="text-lg font-semibold mb-2">Table SQL Schema</h3>
            <div class="p-4 rounded-md font-mono text-sm ring-1 ring-gray-200 relative bg-[#282c34]">
                <button id="copy-table-sql-btn" class="absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs font-semibold py-1 px-2 rounded">Copy</button>
                <pre><code id="table-sql-code"></code></pre>
            </div>
            <div class="mt-2 text-right">
                <button id="view-db-sql-btn" class="text-sm text-blue-600 hover:underline font-semibold">View Full Database SQL</button>
            </div>
        </div>

        <div id="integrations-tab-content" class="table-tab-content hidden space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <h2 class="text-xl font-semibold text-gray-800 shrink-0">Webhook Integrations</h2>
                <button id="create-webhook-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold">Create New Webhook</button>
            </div>
            <div id="webhooks-list-container" class="space-y-4 min-h-[6rem]">
                <!-- Webhooks will be rendered here by JS -->
            </div>

            <div class="pt-6 mt-6 border-t">
                <h2 class="text-xl font-semibold text-gray-800">Calendar Automation</h2>
                <div id="calendar-sync-container" class="mt-4">
                    <!-- Calendar sync UI will be rendered here -->
                </div>
            </div>
        </div>

        <div id="calendar-sync-form-template" class="hidden">
            <form class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex justify-between items-start">
                    <h4 class="font-semibold text-gray-800">Automatic Table Sync</h4>
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-700 mr-3">Enable Sync</span>
                        <label for="calendar-sync-enabled" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" id="calendar-sync-enabled" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mt-1">Automatically create or update a calendar event for every row in this table.</p>
                <div id="calendar-sync-mapping-fields" class="mt-4 space-y-4 border-t pt-4"></div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="delete-calendar-sync-btn" class="text-red-600 hover:underline text-sm font-semibold hidden">Disable and Remove Sync</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold disabled:bg-blue-300" disabled>Save Sync Settings</button>
                </div>
            </form>
        </div>

        <div id="data-tab-content" class="table-tab-content">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <div class="w-full md:w-1/3">
                    <input type="search" id="row-search-input" placeholder="Search rows..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <button id="add-row-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Add Row</button>
                    <button id="import-rows-btn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 flex-grow">Import Rows</button>
                    <button id="export-csv-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 ml-2">Export to CSV</button>
                </div>
            </div>
            <div id="data-table-wrapper" class="bg-white rounded-lg shadow-sm border overflow-auto max-h-[70vh] relative">
                <div id="data-table-loader" class="hidden absolute inset-0 bg-white bg-opacity-75 z-10 flex items-center justify-center">
                    <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                    </thead>
                    <tbody id="data-tbody" class="divide-y">
                    </tbody>
                </table>
            </div>
            <div id="pagination-controls" class="mt-4 flex flex-col md:flex-row justify-between items-center text-sm text-gray-600 gap-2">
            </div>
        </div>
    </main>

    <div id="calendar-view" class="flex-1 p-4 md:p-8 overflow-auto hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Calendar</h2>
            </div>
            <div id="calendar"></div>
            <!-- Container for events of a selected day -->
            <div id="selected-day-events-container" class="mt-6 hidden">
                <div class="bg-white p-4 rounded-lg shadow-md border">
                    <div class="flex justify-between items-center mb-3 pb-3 border-b">
                        <h3 id="selected-day-header" class="text-lg font-semibold text-gray-800">Events for...</h3>
                        <button id="add-event-for-selected-day-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm font-semibold hover:bg-blue-700">Add Event</button>
                    </div>
                    <div id="selected-day-events-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="placeholder-content" class="flex-1 flex items-center justify-center text-gray-500">
        Select a table to view its structure and data.
    </div>
</div>

<div id="error-banner" class="hidden fixed top-5 right-5 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-50" role="alert">
    <strong class="font-bold">Error: </strong>
    <span id="error-banner-message" class="block sm:inline"></span>
    <button onclick="this.parentElement.classList.add('hidden')" class="absolute top-0 bottom-0 right-0 px-4 py-3">&times;</button>
</div>

<div id="create-table-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-40">
    <form id="create-table-form" class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
        <div class="p-4 border-b">
            <h3 class="text-xl font-semibold">Create New Table</h3>
        </div>
        <div class="border-b">
            <nav class="flex space-x-1 p-2 bg-gray-100">
                <button type="button" data-tab="gui" class="create-table-tab-btn flex-1 p-2 text-sm font-medium rounded-md bg-white shadow">GUI Builder</button>
                <button type="button" data-tab="sql" class="create-table-tab-btn flex-1 p-2 text-sm font-medium rounded-md">From SQL</button>
            </nav>
        </div>
        <div id="gui-create-tab" class="create-table-tab-content p-6 space-y-4 overflow-y-auto">
            <input id="new-table-name" type="text" placeholder="Table Name (e.g., users)" required class="w-full p-2 border rounded-md">
            <div id="new-columns-list" class="space-y-2 pt-2"></div>
            <button id="add-column-to-modal-btn" type="button" class="text-sm text-blue-600 hover:underline mt-2">+ Add Column</button>
        </div>
        <div id="sql-create-tab" class="create-table-tab-content hidden p-6 space-y-4 overflow-y-auto">
            <p class="text-sm text-gray-600">Paste a single `CREATE TABLE` statement below.</p>
            <textarea id="create-table-sql-input" class="w-full h-64 p-2 border rounded-md font-mono text-sm" placeholder="CREATE TABLE products (...);"></textarea>
        </div>
        <div class="p-6 mt-auto border-t bg-gray-50 flex justify-end gap-4">
            <button id="cancel-create-table-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button id="submit-create-table-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed" disabled>Create Table</button>
        </div>
    </form>
</div>

<div id="view-db-sql-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-40">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-xl font-semibold">Database SQL Schema</h3>
            <button id="close-db-sql-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
        </div>
        <div class="p-4 overflow-y-auto bg-[#282c34] text-white font-mono text-sm">
            <pre><code id="db-sql-code-content"></code></pre>
        </div>
    </div>
</div>

<div id="edit-column-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-40">
    <form id="edit-column-form" class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
        <h3 class="text-lg font-semibold mb-6">Edit Column</h3>
        <input type="hidden" id="edit-column-index">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Column Name</label>
                <input type="text" id="edit-column-name" required class="mt-1 block w-full p-2 border rounded-md shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Data Type</label>
                <select id="edit-column-type" class="mt-1 block w-full p-2 border rounded-md shadow-sm bg-white">
                    <option value="text">TEXT</option>
                    <option value="integer">INTEGER</option>
                    <option value="real">REAL</option>
                    <option value="boolean">BOOLEAN</option>
                    <option value="timestamp">TIMESTAMP</option>
                    <option value="jsonb">JSONB</option>
                </select>
            </div>
            <fieldset class="space-y-2 pt-2">
                <legend class="text-sm font-medium text-gray-700">Constraints</legend>
                <div class="grid grid-cols-2 gap-4">
                    <label class="flex items-center"><input id="edit-is-not-null" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2"> Not Null</label>
                    <label class="flex items-center"><input id="edit-is-unique" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2"> Unique</label>
                </div>
            </fieldset>
        </div>
        <div class="mt-8 flex justify-end gap-4">
            <button id="cancel-edit-column-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save Changes</button>
        </div>
    </form>
</div>

<div id="delete-table-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-40">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
        <h3 class="text-lg font-semibold mb-4">Confirm Table Deletion</h3>
        <p class="text-gray-700">Are you sure you want to delete the table "<strong id="modal-table-name"></strong>"? This will permanently delete all of its data. This action cannot be undone.</p>
        <div class="mt-4 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
            <label class="flex items-center text-sm">
                <input id="keep-calendar-events-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">
                <span class="font-medium text-gray-800">Keep associated calendar events (unlink them from this table).</span>
            </label>
        </div>
        <div class="mt-8 flex justify-end gap-4">
            <button id="cancel-delete-table-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button id="confirm-delete-table-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Delete</button>
        </div>
    </div>
</div>

<div id="import-csv-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-40">
    <form id="import-csv-form" class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="p-4 border-b">
            <h3 class="text-xl font-semibold">Import Table from CSV</h3>
        </div>
        
        <!-- Step 1: File Upload -->
        <div id="import-step-1" class="p-6 space-y-4">
            <div>
                <label for="import-table-name" class="block text-sm font-medium text-gray-700">New Table Name</label>
                <input id="import-table-name" type="text" placeholder="e.g., customers" required class="mt-1 w-full p-2 border rounded-md">
            </div>
            <div>
                <label for="import-csv-file" class="block text-sm font-medium text-gray-700">CSV File (with headers)</label>
                <input id="import-csv-file" type="file" accept=".csv" required class="mt-1 w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
        </div>

        <!-- Step 2: Review Columns -->
        <div id="import-step-2" class="p-6 space-y-4 overflow-y-auto hidden">
            <p class="text-sm text-gray-600">Review the detected columns and their inferred data types. You can make changes before importing.</p>
            <div class="border rounded-lg overflow-hidden">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-2 text-left font-semibold">Original Header</th>
                            <th class="p-2 text-left font-semibold">New Column Name (Sanitized)</th>
                            <th class="p-2 text-left font-semibold">Data Type</th>
                            <th class="p-2 text-center font-semibold">PK</th>
                        </tr>
                    </thead>
                    <tbody id="csv-review-tbody" class="divide-y">
                        <!-- Rows will be injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="p-4 mt-auto border-t bg-gray-50 flex justify-end gap-4">
            <button id="cancel-import-csv-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button id="import-csv-next-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold">Review Columns</button>
            <button id="import-csv-submit-btn" type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold hidden">Create Table & Import</button>
        </div>
    </form>
</div>

<div id="import-rows-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-40">
    <form id="import-rows-form" class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
        <div class="p-4 border-b">
            <h3 class="text-xl font-semibold">Import Rows into '<span id="import-rows-table-name"></span>'</h3>
        </div>
        <div class="p-6 space-y-4 overflow-y-auto">
            <div>
                <label for="import-rows-csv-file" class="block text-sm font-medium text-gray-700">CSV File</label>
                <input id="import-rows-csv-file" type="file" accept=".csv" required class="mt-1 w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <div id="import-rows-mapping-container" class="hidden space-y-3 pt-4">
                <p class="text-sm font-medium text-gray-800">Map CSV columns to table columns:</p>
                <div id="import-rows-mapping-fields" class="space-y-2 border-t pt-3">
                    <!-- Mapping fields will be injected by JS -->
                </div>
            </div>
        </div>
        <div class="p-4 mt-auto border-t bg-gray-50 flex justify-end gap-4">
            <button id="cancel-import-rows-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold" disabled>Import Rows</button>
        </div>
    </form>
</div>

<div id="import-summary-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-40">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
        <h3 class="text-xl font-semibold mb-4">Import Summary</h3>
        <div id="import-summary-content" class="space-y-3 text-gray-700">
        </div>
        <div class="mt-6 flex justify-end gap-4">
            <button id="close-summary-modal-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Close</button>
        </div>
    </div>
</div>

<div id="create-event-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-40">
    <form id="create-event-form" class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="p-4 border-b">
            <h3 class="text-xl font-semibold">Create Event from Existing Row</h3>
        </div>
        <div class="p-6 space-y-4 overflow-y-auto">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Source Table</label>
                    <select id="event-source-table-select" required class="mt-1 block w-full p-2 border rounded-md bg-white"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Source Row</label>
                    <select id="event-source-row-select" required class="mt-1 block w-full p-2 border rounded-md bg-white" disabled></select>
                </div>
            </div>
            <div class="border-t pt-4 mt-4">
                <h4 class="text-md font-semibold text-gray-800">Event Details</h4>
                <div class="space-y-3 mt-2">
                    <div>
                        <label for="create-event-title" class="block text-sm font-medium text-gray-700">Event Title <span class="text-red-500">*</span></label>
                        <input type="text" id="create-event-title" required class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="create-event-start-time" class="block text-sm font-medium text-gray-700">Start Date/Time <span class="text-red-500">*</span></label>
                        <input type="datetime-local" id="create-event-start-time" required class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                </div>
            </div>
        </div>
        <div class="p-4 mt-auto border-t bg-gray-50 flex justify-end gap-4">
            <button id="cancel-create-event-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Create Event</button>
        </div>
    </form>
</div>

<!-- Event Details/Edit Modal -->
<div id="event-details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-40">
    <form id="event-details-form" class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-xl font-semibold">Event Details</h3>
            <button id="close-event-details-btn" type="button" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div class="p-6 space-y-4 overflow-y-auto">
            <input type="hidden" id="edit-event-id">
            <div>
                <label for="edit-event-title" class="block text-sm font-medium text-gray-700">Event Title</label>
                <input type="text" id="edit-event-title" required class="mt-1 block w-full p-2 border rounded-md">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="edit-event-start-time" class="block text-sm font-medium text-gray-700">Start Time</label>
                    <input type="datetime-local" id="edit-event-start-time" required class="mt-1 block w-full p-2 border rounded-md">
                </div>
                <div>
                    <label for="edit-event-end-time" class="block text-sm font-medium text-gray-700">End Time (Optional)</label>
                    <input type="datetime-local" id="edit-event-end-time" class="mt-1 block w-full p-2 border rounded-md">
                </div>
            </div>
            <div>
                <label for="edit-event-description" class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="edit-event-description" rows="3" class="mt-1 block w-full p-2 border rounded-md"></textarea>
            </div>
            <!-- This section will be populated with the full source row data -->
            <div id="event-source-data-container" class="hidden pt-4 mt-4 border-t">
                <h4 class="text-md font-semibold text-gray-800">Source Data from <span id="event-source-table-name" class="font-mono"></span></h4>
                <div id="event-source-data-details" class="mt-2 space-y-1 text-sm font-mono bg-gray-50 p-3 rounded-md"></div>
            </div>
            <div>
                <label class="flex items-center"><input id="edit-event-completed" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2"> Mark as Completed</label>
            </div>
        </div>
        <div class="p-4 mt-auto border-t bg-gray-50 flex justify-between items-center">
            <button id="delete-event-btn" type="button" class="bg-red-100 text-red-700 px-4 py-2 rounded-md hover:bg-red-200 font-semibold">Delete Event</button>
            <div class="flex gap-4">
                <button id="cancel-edit-event-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save Changes</button>
            </div>
        </div>
    </form>
</div>

<div id="send-to-calendar-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-40">
    <form id="send-to-calendar-form" class="bg-white rounded-lg shadow-xl w-full max-w-lg">
        <div class="p-4 border-b">
            <h3 class="text-xl font-semibold">Send Row to Calendar</h3>
        </div>
        <div class="p-6 space-y-4">
            <p class="text-sm text-gray-600">Map the columns from your table to the calendar event fields.</p>
            <input type="hidden" id="calendar-source-row-id">
            
            <div>
                <label class="block text-sm font-medium text-gray-700">Event Title <span class="text-red-500">*</span></label>
                <select id="calendar-title-col" required class="mt-1 block w-full p-2 border rounded-md bg-white"></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Start Date/Time <span class="text-red-500">*</span></label>
                <select id="calendar-start-col" required class="mt-1 block w-full p-2 border rounded-md bg-white"></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">End Date/Time (Optional)</label>
                <select id="calendar-end-col" class="mt-1 block w-full p-2 border rounded-md bg-white"></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Description (Optional)</label>
                <select id="calendar-desc-col" class="mt-1 block w-full p-2 border rounded-md bg-white"></select>
            </div>
        </div>
        <div class="p-4 mt-auto border-t bg-gray-50 flex justify-end gap-4">
            <button id="cancel-send-to-calendar-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Create Event</button>
        </div>
    </form>
</div>

<script>
const supabaseUrl = '{{ supabase_url }}';
const supabaseAnonKey = '{{ supabase_anon_key }}';
const supabase = supabaseUrl && supabaseAnonKey ? window.supabase.createClient(supabaseUrl, supabaseAnonKey) : null;

document.addEventListener('DOMContentLoaded', () => {
    if (!supabase) {
        document.body.innerHTML = '<div class="text-center p-8 text-red-600">Supabase client not configured. Please check your environment variables.</div>';
        return;
    }

    // State
    let state = {
        dbId: null,
        dbName: '{{ db_name }}',
        tables: [],
        fkDataCache: {},
        selectedTable: null,
        pagination: {
            currentPage: 1,
            limit: 50, // This should match the default limit in the API
            totalRows: 0
        }
    };

    // DOM Elements
    const tableList = document.getElementById('table-list');
    const mainContent = document.getElementById('main-content');
    const placeholderContent = document.getElementById('placeholder-content');
    const deleteTableBtn = document.getElementById('delete-table-btn');
    const tableTabButtons = document.querySelectorAll('.table-tab-btn');
    const tableTabContainer = document.getElementById('table-tabs-container');
    const createTableBtn = document.getElementById('create-table-btn');
    const createTableModal = document.getElementById('create-table-modal');
    const createTableForm = document.getElementById('create-table-form');
    const cancelCreateTableBtn = document.getElementById('cancel-create-table-btn');
    const submitCreateTableBtn = document.getElementById('submit-create-table-btn');
    const createTableTabButtonsInModal = document.querySelectorAll('#create-table-modal .create-table-tab-btn');
    const guiCreateTab = document.getElementById('gui-create-tab');
    const sqlCreateTab = document.getElementById('sql-create-tab');
    const addColumnToModalBtn = document.getElementById('add-column-to-modal-btn');
    const deleteTableModal = document.getElementById('delete-table-modal');
    const modalTableName = document.getElementById('modal-table-name');
    const cancelDeleteTableBtn = document.getElementById('cancel-delete-table-btn');
    const confirmDeleteTableBtn = document.getElementById('confirm-delete-table-btn');
    const editColumnModal = document.getElementById('edit-column-modal');
    const editColumnForm = document.getElementById('edit-column-form');
    const cancelEditColumnBtn = document.getElementById('cancel-edit-column-btn');
    const structureTbody = document.getElementById('structure-tbody');
    const viewDbSqlBtn = document.getElementById('view-db-sql-btn');
    const dbSqlCodeContent = document.getElementById('db-sql-code-content');
    const viewDbSqlModal = document.getElementById('view-db-sql-modal');
    const closeDbSqlModalBtn = document.getElementById('close-db-sql-modal-btn');
    const importRowsBtn = document.getElementById('import-rows-btn');
    const addRowBtn = document.getElementById('add-row-btn');
    const dataTbody = document.getElementById('data-tbody');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const searchInput = document.getElementById('row-search-input');
    const importCsvBtn = document.getElementById('import-csv-btn');
    const viewDbSqlSidebarBtn = document.getElementById('view-db-sql-sidebar-btn');
    const importCsvModal = document.getElementById('import-csv-modal');
    const importCsvForm = document.getElementById('import-csv-form');
    const cancelImportCsvBtn = document.getElementById('cancel-import-csv-btn');
    const importCsvNextBtn = document.getElementById('import-csv-next-btn');
    const importCsvSubmitBtn = document.getElementById('import-csv-submit-btn');
    const importCsvFile = document.getElementById('import-csv-file');
    const importStep1 = document.getElementById('import-step-1');
    const importStep2 = document.getElementById('import-step-2');
    const csvReviewTbody = document.getElementById('csv-review-tbody');
    const importTableName = document.getElementById('import-table-name');
    const importRowsModal = document.getElementById('import-rows-modal');
    const importRowsForm = document.getElementById('import-rows-form');
    const cancelImportRowsBtn = document.getElementById('cancel-import-rows-btn');
    const importSummaryModal = document.getElementById('import-summary-modal');
    const closeSummaryModalBtn = document.getElementById('close-summary-modal-btn');
    const createWebhookBtn = document.getElementById('create-webhook-btn');
    const webhooksListContainer = document.getElementById('webhooks-list-container');
    const sidebar = document.getElementById('sidebar');
    const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
    const calendarBtn = document.getElementById('calendar-btn');
    const calendarView = document.getElementById('calendar-view');
    const sendToCalendarModal = document.getElementById('send-to-calendar-modal');
    const cancelSendToCalendarBtn = document.getElementById('cancel-send-to-calendar-btn');
    const createEventModal = document.getElementById('create-event-modal');
    const cancelCreateEventBtn = document.getElementById('cancel-create-event-btn');
    const eventDetailsModal = document.getElementById('event-details-modal');


    let dataFetchController = new AbortController();
    let selectedDateElement = null; // To track the highlighted day cell

    const importRowsCsvFile = document.getElementById('import-rows-csv-file');
    let calendar;

    function showError(message, error = null) {
        const banner = document.getElementById('error-banner');
        const bannerMessage = document.getElementById('error-banner-message');
        bannerMessage.textContent = message;
        banner.classList.remove('hidden');

        if (error) {
            console.error("An error occurred:", message, error);
        }
    }

    /**
     * A wrapper for the native fetch function that automatically includes
     * the Supabase authentication token.
     * @param {string} url - The URL to fetch.
     * @param {object} options - The options for the fetch call (e.g., method, body).
     * @returns {Promise<Response>} The fetch Response object.
     */
    async function fetchWithAuth(url, options = {}) {
        const token = await getAuthToken();
        if (!token) return; // getAuthToken handles redirection

        const headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
        return fetch(url, { ...options, headers });
    }

    async function getAuthToken() {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error || !session) {
            console.error("Authentication error, redirecting to login.", error);
            window.location.href = '/login';
            return null;
        }
        return session.access_token;
    }

    /**
     * Safely extracts a detailed error message from a fetch response.
     * @param {Response} response - The fetch Response object.
     * @returns {Promise<string>} A detailed error message.
     */
    async function getErrorFromResponse(response) {
        const errorText = await response.text();
        try {
            const err = JSON.parse(errorText);
            if (err.detail) {
                if (typeof err.detail === 'string') {
                    return err.detail; // It's a simple string error from the backend.
                }
                // Handle Pydantic validation errors which come as an array of objects.
                if (Array.isArray(err.detail)) {
                    const messages = err.detail.map(d => {
                        const field = d.loc ? d.loc.slice(1).join(' -> ') : 'Field'; // e.g., body -> name becomes "name"
                        return `${field}: ${d.msg}`;
                    });
                    return `Validation Error: ${messages.join('; ')}`;
                }
                return JSON.stringify(err.detail, null, 2);
            }
            return JSON.stringify(err, null, 2);
        } catch (e) {
            return `Server returned status ${response.status}. Response: ${errorText.substring(0, 500)}`;
        }
    }

    /**
     * Helper functions for auto-matching webhook fields.
     */
    function normalizeString(str) {
        if (!str) return '';
        return str.toLowerCase().replace(/[\s_-]/g, '');
    }

    function findBestMatch(tableColumnName, incomingFields) {
        const normalizedTableCol = normalizeString(tableColumnName);
        let bestMatch = null;
        let highestScore = 0;

        for (const field of incomingFields) {
            const normalizedField = normalizeString(field);
            let score = 0;

            if (normalizedTableCol === normalizedField) {
                score = 100; // Perfect match
            } else if (normalizedTableCol.includes(normalizedField) || normalizedField.includes(normalizedTableCol)) {
                // Prioritize longer matches to avoid 'id' matching 'grid'
                const similarity = Math.min(normalizedTableCol.length, normalizedField.length) / Math.max(normalizedTableCol.length, normalizedField.length);
                score = 50 * similarity; // Substring match, weighted by similarity
            }

            if (score > highestScore) {
                highestScore = score;
                bestMatch = field;
            }
        }
        return bestMatch;
    }

    function debounce(func, timeout = 300){
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    }

    async function fetchDbIdAndTables() {
        try {
            // 1. Fetch all databases to find the ID for the current dbName
            const dbsResponse = await fetchWithAuth('/api/v1/databases');
            if (!dbsResponse.ok) throw new Error('Could not fetch databases to find ID.');
            const databases = await dbsResponse.json();
            const currentDb = databases.find(db => db.name === state.dbName);
            
            if (!currentDb) throw new Error(`Database '${state.dbName}' not found.`);
            state.dbId = currentDb.id;

            // 2. Fetch tables for the found database ID
            const tablesResponse = await fetchWithAuth(`/api/v1/databases/${state.dbId}/tables`);
            if (!tablesResponse.ok) throw new Error('Could not fetch tables.');
            state.tables = await tablesResponse.json();
            renderTables(state.tables);

        } catch (error) {
            console.error(error);
            placeholderContent.textContent = `Error: ${error.message}`;
        }
    }

    function renderTables(tables) {
        tableList.innerHTML = '';
        if (tables.length === 0) {
            tableList.innerHTML = `<p class="text-sm text-gray-500 p-2">No tables yet.</p>`;
            return;
        }
        tables.forEach(table => {
            const tableLink = document.createElement('a');
            tableLink.href = '#'; // Use flex for icon alignment
            tableLink.className = 'flex items-center gap-3 p-2 rounded-md hover:bg-gray-100';
            tableLink.textContent = table.name;
            tableLink.dataset.tableId = table.id;
            tableList.appendChild(tableLink);
        });
    }

    async function cacheForeignKeyData(table) {
        if (!table || !table.columns) return;

        // Reset cache for the new table context
        state.fkDataCache = {};

        const fkColumns = table.columns.filter(c => c.foreign_key);
        for (const col of fkColumns) {
            const fkInfo = col.foreign_key;
            const referencedTableId = fkInfo.table_id;

            if (state.fkDataCache[referencedTableId]) continue;

            try {
                const response = await fetchWithAuth(`/api/v1/tables/${referencedTableId}/all-rows`);
                if (!response.ok) throw new Error(`Failed to fetch data for FK table ${referencedTableId}`);
                const rows = await response.json();
                
                const referencedTable = state.tables.find(t => t.id === referencedTableId);
                if (!referencedTable) throw new Error(`Could not find metadata for referenced table ${referencedTableId}`);
                
                const pkColumn = referencedTable.columns.find(c => c.is_primary_key);
                if (!pkColumn) throw new Error(`Referenced table ${referencedTableId} has no primary key.`);

                state.fkDataCache[referencedTableId] = {
                    rows: rows,
                    pkColumn: pkColumn.name,
                    displayColumn: fkInfo.column_name
                };
            } catch (error) {
                console.error(`Error caching FK data for table ${referencedTableId}:`, error);
                state.fkDataCache[referencedTableId] = { rows: [], error: error.message };
            }
        }
    }

    function handleTableSelect(e) {
        if (e.target.tagName === 'A') {
            e.preventDefault();
            const tableId = e.target.dataset.tableId;
            state.selectedTable = state.tables.find(t => t.id == tableId);
            if (!state.selectedTable) return;

            tableList.querySelectorAll('a').forEach(a => a.classList.remove('bg-blue-100', 'text-blue-700', 'font-semibold'));
            e.target.classList.add('bg-blue-100', 'text-blue-700', 'font-semibold');
            
            // FIX: Await the FK caching before rendering data to prevent race conditions.
            cacheForeignKeyData(state.selectedTable).then(() => {
                fetchAndRenderData(state.selectedTable.id, 1);
            });

            mainContent.classList.remove('hidden');
            placeholderContent.classList.add('hidden');
            calendarView.classList.add('hidden');
            deleteTableBtn.disabled = false;
            tableTabContainer.classList.remove('hidden');
            document.querySelector('.table-tab-btn[data-tab="data"]').click();

            // Reset to page 1 whenever a new table is selected
            renderStructure(state.selectedTable.columns);
            renderTableSql(state.selectedTable);
            // Pass the full table object, not just the ID
            fetchAndRenderCalendarSync(state.selectedTable);
            fetchAndRenderWebhooks(state.selectedTable.id);
        }
    }

    function renderStructure(columns) {
        const tbody = document.getElementById('structure-tbody');
        tbody.innerHTML = ''; // Clear existing
        if (!columns || columns.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">This table has no columns defined.</td></tr>`;
            return;
        }

        columns.forEach((col, index) => {
            const tr = document.createElement('tr');
            const checkmark = `<span class="text-green-600 font-bold">&#10003;</span>`;
            tr.innerHTML = `
                <td class="p-3 font-mono">${col.name}</td>
                <td class="p-3 font-mono text-purple-600 uppercase">${col.type === 'serial' ? 'SERIAL (PK)' : col.type}</td>
                <td class="p-3 text-center">${col.is_not_null ? checkmark : ''}</td>
                <td class="p-3 text-center">${col.is_primary_key ? checkmark : ''}</td>
                <td class="p-3 text-center">${col.is_unique ? checkmark : ''}</td>
                <td class="p-3 font-mono text-xs">${col.foreign_key ? `-> ${state.tables.find(t => t.id === col.foreign_key.table_id)?.name}.${col.foreign_key.column_name}` : ''}</td>
                <td class="p-3 text-center">
                    ${!col.is_primary_key ? `
                        <div class="flex items-center justify-center gap-2">
                            <button data-column-index="${index}" class="edit-column-btn text-gray-500 hover:text-blue-600" title="Edit Column"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg></button>
                            <button data-column-index="${index}" class="delete-column-btn text-gray-500 hover:text-red-600" title="Delete Column"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    ` : ''}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function fetchAndRenderData(tableId, page = 1, searchTerm = '') {
        // Abort any ongoing fetch for this data to prevent race conditions
        dataFetchController.abort();
        dataFetchController = new AbortController();
        const signal = dataFetchController.signal;


        state.pagination.currentPage = page;
        const offset = (page - 1) * state.pagination.limit;

        const thead = document.querySelector('#data-tab-content table thead');
        const tbody = document.getElementById('data-tbody');
        const loader = document.getElementById('data-table-loader');
        const columns = state.selectedTable.columns.sort((a, b) => a.is_primary_key ? -1 : 1);

        // Show loading overlay
        loader.classList.remove('hidden');

        const searchParam = searchTerm ? `&search=${encodeURIComponent(searchTerm)}` : '';

        try {
            const response = await fetchWithAuth(`/api/v1/tables/${tableId}/rows?limit=${state.pagination.limit}&offset=${offset}${searchParam}`, { signal });
            if (!response.ok) throw new Error(await getErrorFromResponse(response));
            const result = await response.json();
            const rows = result.data;
            state.pagination.totalRows = result.total;

            // --- FIX: Programmatic DOM creation to avoid innerHTML and CSP issues ---
            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Build and append header
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th class="p-3 w-24">Actions</th>';
            columns.forEach(col => {
                const th = document.createElement('th');
                th.className = 'p-3 text-left font-semibold';
                th.textContent = col.name;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Build and append body rows
            if (rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${columns.length + 1}" class="p-8 text-center text-gray-500">No data in this table.</td></tr>`;
            } else {
                rows.forEach(row => {
                    tbody.appendChild(renderRow(row, columns));
                });
            }
            renderPagination();
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Data fetch aborted by new request.'); // This is an expected outcome, not an error.
                return;
            }
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="99" class="p-4 text-center text-red-500">Error loading data: ${error.message}</td></tr>`;
        } finally {
            // Hide loading overlay
            loader.classList.add('hidden');
        }
    }

    function renderRow(row, columns) {
        const tr = document.createElement('tr');
        tr.dataset.rowId = row.id;

        // Actions Cell
        const actionsTd = document.createElement('td');
        actionsTd.className = 'p-3 text-center flex items-center justify-center gap-3';
        actionsTd.innerHTML = `
            <button data-row-id="${row.id}" class="send-to-calendar-btn text-gray-400 hover:text-yellow-600" title="Send to Calendar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            </button>
            <button data-row-id="${row.id}" class="delete-row-btn text-gray-400 hover:text-red-600" title="Delete Row">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        `;
        tr.appendChild(actionsTd);

        // Data Cells
        columns.forEach(col => {
            const td = document.createElement('td');
            td.className = 'p-1';
            td.dataset.columnName = col.name;

            const cellValue = row.data ? (row.data[col.name] ?? '') : '';

            if (col.foreign_key) {
                const fkInfo = col.foreign_key;
                const cacheEntry = state.fkDataCache[fkInfo.table_id];

                if (cacheEntry && !cacheEntry.error) {
                    const select = document.createElement('select');
                    select.className = 'w-full p-2 border-0 rounded-md bg-white focus:ring-2 focus:ring-blue-500 fk-select';
                    select.innerHTML = '<option value="">-- Select --</option>';
                    cacheEntry.rows.forEach(fkRow => {
                        const optionValue = fkRow.data[cacheEntry.pkColumn] ?? fkRow.id;
                        const optionText = fkRow.data[cacheEntry.displayColumn] ?? `(ID: ${optionValue})`;
                        const option = new Option(optionText, optionValue);
                        if (optionValue == cellValue) option.selected = true;
                        select.add(option);
                    });
                    td.appendChild(select);
                } else {
                    td.className = 'p-3 font-mono text-sm text-red-500';
                    td.textContent = 'FK Error';
                }
            } else {
                if (col.is_primary_key) {
                    td.textContent = `(${cellValue})`;
                    td.className = 'p-3'; // Adjust class for non-input cell
                } else if (col.type === 'boolean') {
                    const select = document.createElement('select');
                    select.className = 'w-full p-2 border-0 rounded-md bg-white focus:ring-2 focus:ring-blue-500 boolean-select';
                    const isTrue = ['true', 't', '1', true].includes(String(cellValue).toLowerCase());
                    const isFalse = ['false', 'f', '0', false].includes(String(cellValue).toLowerCase());
                    select.innerHTML = `
                        <option value="" ${!isTrue && !isFalse ? 'selected' : ''}>--</option>
                        <option value="true" ${isTrue ? 'selected' : ''}>True</option>
                        <option value="false" ${isFalse ? 'selected' : ''}>False</option>
                    `;
                    td.appendChild(select);
                } else if (col.type === 'timestamp') {
                    const input = document.createElement('input');
                    input.type = 'date';
                    const dateValue = cellValue ? new Date(cellValue).toISOString().split('T')[0] : '';
                    input.value = dateValue;
                    input.className = 'w-full p-2 border-0 rounded-md bg-white focus:ring-2 focus:ring-blue-500 timestamp-input';
                    td.appendChild(input);
                } else {
                    const input = document.createElement('input');
                    const inputType = (col.type === 'integer' || col.type === 'real') ? 'number' : 'text';
                    input.type = inputType;
                    input.value = cellValue;
                    input.className = 'w-full p-2 border-0 rounded-md bg-white focus:ring-2 focus:ring-blue-500 editable-cell-input';
                    td.appendChild(input);
                }
            }
            tr.appendChild(td);
        });

        return tr;
    }

    function renderTableSql(table) {
        const codeElement = document.getElementById('table-sql-code');
        if (!table || !table.name) {
            codeElement.textContent = '-- No table selected --';
            return;
        }
        let createStatement = `CREATE TABLE "${table.name}" (\n`;
        const columnDefs = table.columns.map(col => {
            let parts = [`  "${col.name}"`, (col.type || 'TEXT').toUpperCase()];
            // Use a Set to prevent duplicate constraints, which is the root of the issue.
            const constraints = new Set();
            if (col.is_primary_key) constraints.add("PRIMARY KEY");
            if (col.is_not_null) constraints.add("NOT NULL");
            if (col.is_unique) constraints.add("UNIQUE");
            
            parts.push(...constraints);
            return parts.join(' ');
        });

        createStatement += columnDefs.join(',\n');
        createStatement += "\n);";
        codeElement.textContent = createStatement;
        hljs.highlightElement(codeElement);
    }

    async function fetchAndRenderWebhooks(tableId) {
        webhooksListContainer.innerHTML = `<div class="text-sm text-gray-500">Loading integrations...</div>`;
        try {
            const response = await fetchWithAuth(`/api/v1/tables/${tableId}/webhooks`);
            if (!response.ok) throw new Error('Failed to fetch webhooks');
            const webhooks = await response.json();
            renderWebhooks(webhooks);
        } catch (error) {
            console.error(error);
            webhooksListContainer.innerHTML = `<div class="text-sm text-red-500">Error loading integrations.</div>`;
        }
    }

    async function fetchAndRenderCalendarSync(table) {
        const container = document.getElementById('calendar-sync-container');
        container.innerHTML = `<div class="text-sm text-gray-500">Loading calendar settings...</div>`;
        try {
            const response = await fetchWithAuth(`/api/v1/tables/${table.id}/calendar-sync`);
            
            if (!response.ok) throw new Error(await getErrorFromResponse(response));
            
            // The API returns 200 OK with a null body if no config is found.
            // response.json() handles this correctly and will resolve to null.
            const config = await response.json();
            renderCalendarSyncForm(config, table);
        } catch (error) {
            // Don't log to console if it's a 404, which is a valid state (no config found)
            // The API now returns 200 with null body for this case, so this check is less critical but good practice.
            if (!error.message.includes("404")) console.error("Error in fetchAndRenderCalendarSync:", error);
            container.innerHTML = `
                <div class="bg-red-50 border border-red-200 text-red-800 text-sm p-4 rounded-lg">
                    <p class="font-bold">Error loading calendar settings.</p>
                    <p class="mt-2 text-xs font-mono bg-red-100 p-2 rounded">Details: ${error.message}</p>
                </div>`;
        }
    }

    function renderCalendarSyncForm(config, table) {
        const container = document.getElementById('calendar-sync-container');
        const template = document.getElementById('calendar-sync-form-template');
        container.innerHTML = template.innerHTML;

        const form = container.querySelector('form');
        const mappingContainer = form.querySelector('#calendar-sync-mapping-fields');
        const enabledToggle = form.querySelector('#calendar-sync-enabled');
        const deleteBtn = form.querySelector('#delete-calendar-sync-btn');

        // Fix: Handle case where config is null
        const currentMapping = config ? config.column_mapping : {};
        const isEnabled = config ? config.is_enabled : false;

        const columns = table.columns.filter(c => !c.is_primary_key);
        const dateLikeColumns = columns.filter(c => ['timestamp', 'text', 'date', 'real', 'integer'].includes(c.type));

        const fields = [
            { id: 'start_time_column', label: 'Start Date/Time', required: true, options: dateLikeColumns },
            { id: 'end_time_column', label: 'End Date/Time', required: false, options: dateLikeColumns },
        ];

        mappingContainer.innerHTML = fields.map(field => `
            <div class="grid grid-cols-3 gap-4 items-center">
                <label for="sync-${field.id}" class="text-sm font-medium text-gray-700">${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}</label>
                <select id="sync-${field.id}" data-mapping-key="${field.id}" class="col-span-2 p-2 border rounded-md bg-white calendar-sync-select" ${field.required ? 'required' : ''}>
                    <option value="">-- Select Column --</option>
                    ${field.options.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                </select>
            </div>
        `).join('');

        // Add a listener to enable the save button only when the required field is filled
        const startSelect = form.querySelector('#sync-start_time_column');
        const saveBtn = form.querySelector('button[type="submit"]');
        startSelect.addEventListener('change', () => { saveBtn.disabled = !startSelect.value; });

        enabledToggle.checked = isEnabled;
        if (config) deleteBtn.classList.remove('hidden');
        for (const [key, value] of Object.entries(currentMapping)) {
            const select = form.querySelector(`[data-mapping-key="${key}"]`);
            if (select) select.value = value;
        }

        // Initial check for the save button state
        saveBtn.disabled = !startSelect.value;

        form.addEventListener('submit', handleSaveCalendarSync);
        deleteBtn.addEventListener('click', handleDeleteCalendarSync);
    }

    async function handleSaveCalendarSync(e) {
        e.preventDefault();
        const form = e.target;
        const payload = {
            is_enabled: form.querySelector('#calendar-sync-enabled').checked,
            column_mapping: {}
        };
        form.querySelectorAll('select[data-mapping-key]').forEach(s => {
            payload.column_mapping[s.dataset.mappingKey] = s.value || null;
        });

        const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/calendar-sync`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            fetchAndRenderCalendarSync(state.selectedTable);
            if (calendar) calendar.refetchEvents(); // Explicitly refresh calendar on sync change
            } else {
                showError('Failed to save sync settings.');
            }
    }

    async function handleDeleteCalendarSync() {
        if (confirm('Are you sure you want to remove the calendar sync for this table?')) {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/calendar-sync`, { method: 'DELETE' });
            if (response.ok) {
                fetchAndRenderCalendarSync(state.selectedTable);
                if (calendar) calendar.refetchEvents(); // Explicitly refresh calendar
            } else {
                showError('Failed to delete sync settings.');
            }
        }
    }

    function renderWebhooks(webhooks) {
        webhooksListContainer.innerHTML = '';
        if (webhooks.length === 0) {
            webhooksListContainer.innerHTML = `<div class="text-center p-6 border-2 border-dashed rounded-lg text-gray-500">
                    <h3 class="font-semibold">No webhooks yet.</h3>
                    <p class="mt-1 text-sm">Create a webhook to start receiving data from external forms.</p>
                    <div class="mt-4 text-xs text-left bg-gray-100 p-3 rounded-md max-w-lg mx-auto">
                        <p class="font-semibold text-gray-600">Pro Tip:</p>
                        <p class="text-gray-500 mt-1">For best results, ensure your table has columns that match the fields you expect to receive (e.g., columns named <code class="bg-gray-200 text-gray-700 px-1 rounded font-mono">name</code>, <code class="bg-gray-200 text-gray-700 px-1 rounded font-mono">email</code>, <code class="bg-gray-200 text-gray-700 px-1 rounded font-mono">message</code>, etc.). This makes field mapping easier after you receive your first test submission.</p>
                    </div>
                </div>`;
            return;
        }
        webhooks.forEach(webhook => {
            const webhookCard = document.createElement('div');
            webhookCard.className = 'bg-white rounded-lg shadow-sm border p-4';
            webhookCard.dataset.webhookId = webhook.id;
            webhookCard.innerHTML = renderSingleWebhook(webhook);
            webhooksListContainer.appendChild(webhookCard);
        });
    }

    function renderSingleWebhook(webhook) {
        const webhookUrl = `${window.location.origin}/api/v1/webhooks/incoming/${webhook.webhook_token}`;
        const statusColors = {
            listening: 'bg-blue-100 text-blue-800',
            active: 'bg-green-100 text-green-800',
            disabled: 'bg-gray-100 text-gray-800'
        };

        let contentHtml = '';
        if (webhook.status === 'listening' && webhook.sample_payload) {
            // State: Ready for mapping
            const incomingFields = Object.keys(webhook.sample_payload);
            const tableColumns = state.selectedTable.columns.filter(c => !c.is_primary_key);

            const mappingFieldsHtml = tableColumns.map(col => {
                // Find the best match for the current table column among the incoming fields.
                const bestMatch = findBestMatch(col.name, incomingFields);
                return `
                    <div class="grid grid-cols-2 gap-4 items-center">
                        <label class="text-right font-medium text-gray-700">${col.name} <span class="font-mono text-xs text-purple-600">(${col.type})</span></label>
                        <select data-table-col="${col.name}" class="p-2 border rounded-md bg-white">
                            <option value="">-- Don't Import --</option>
                            ${incomingFields.map(h => `<option value="${h}" ${h === bestMatch ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                    </div>
                `;
            }).join('');

            contentHtml = `
                <form class="webhook-mapping-form">
                    <h4 class="font-semibold text-gray-800">Map Incoming Fields to Table Columns</h4>
                    <p class="text-sm text-gray-600 mt-1">We received a test submission. Match the fields from your form to the columns in your table.</p>
                    <div class="mt-4 space-y-2 border-t pt-4">
                        ${mappingFieldsHtml}
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold">Save and Activate</button>
                    </div>
                </form>
            `;
        } else if (webhook.status === 'listening') {
            // State: Listening for first submission
            contentHtml = `
                <div class="text-center p-4 bg-blue-50 rounded-md">
                    <h4 class="font-semibold text-blue-800">Listening for data...</h4>
                    <p class="text-sm text-blue-700 mt-1">To complete setup, submit a test entry from your form (e.g., from WordPress) or send a sample payload.</p>
                    <div class="mt-4 flex justify-center items-center gap-4">
                        <button data-webhook-url="${webhookUrl}" class="send-test-webhook-btn text-sm bg-white border border-blue-600 text-blue-600 px-3 py-1 rounded-md hover:bg-blue-50">Send Test Data</button>
                        <button data-webhook-id="${webhook.id}" class="refresh-webhook-btn text-sm text-blue-600 hover:underline">Check for data</button>
                    </div>
                </div>
            `;
        } else if (webhook.status === 'active') {
            // State: Active and running
            const fieldMapping = webhook.field_mapping || {};
            const hasMapping = Object.keys(fieldMapping).length > 0;

            const mappingHtml = hasMapping
                ? Object.entries(fieldMapping).map(([tableCol, formField]) => `
                    <div class="flex items-center gap-2">
                        <span class="font-mono text-sm text-gray-500">${formField}</span>
                        <span class="text-gray-400">&rarr;</span>
                        <span class="font-mono text-sm font-semibold text-gray-800">${tableCol}</span>
                    </div>
                `).join('')
                : '<p class="text-sm text-amber-700">No fields are currently mapped. This webhook will not insert any data.</p>';

            contentHtml = `
                <div class="p-4 bg-green-50 rounded-md">
                    <div class="flex justify-between items-center">
                        <h4 class="font-semibold text-green-800">Webhook is Active</h4>
                        <div class="flex items-center gap-2">
                            <button data-webhook-id="${webhook.id}" data-status="listening" class="toggle-webhook-status-btn text-sm bg-white border border-blue-600 text-blue-600 px-3 py-1 rounded-md hover:bg-blue-50">Re-map Fields</button>
                            <button data-webhook-id="${webhook.id}" data-status="disabled" class="toggle-webhook-status-btn text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300">Pause</button>
                        </div>
                    </div>
                    <p class="text-sm text-green-700 mt-2">This webhook is live and will insert data into your table based on the following mapping:</p>
                    <div class="mt-3 space-y-1">${mappingHtml}</div>
                </div>
            `;
        } else if (webhook.status === 'disabled') {
            // State: Disabled
            contentHtml = `
                <div class="p-4 bg-gray-50 rounded-md">
                    <div class="flex justify-between items-center">
                        <h4 class="font-semibold text-gray-800">Webhook is Disabled</h4>
                        <button data-webhook-id="${webhook.id}" data-status="active" class="toggle-webhook-status-btn text-sm bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700">Resume</button>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">This webhook is currently disabled and will not process any incoming data.</p>
                </div>
            `;
        }

        return `
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-semibold text-gray-500">Webhook URL</p>
                    <div class="flex items-center gap-2 mt-1">
                        <input type="text" readonly value="${webhookUrl}" class="w-full max-w-md p-2 font-mono text-xs bg-gray-100 border rounded-md">
                        <button data-url="${webhookUrl}" class="copy-webhook-url-btn p-2 rounded-md bg-gray-200 hover:bg-gray-300" title="Copy URL">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-xs font-medium px-2 py-1 rounded-full ${statusColors[webhook.status]}">${webhook.status.toUpperCase()}</span>
                    <button data-webhook-id="${webhook.id}" class="delete-webhook-btn text-gray-400 hover:text-red-600" title="Delete Webhook">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t">${contentHtml}</div>
        `;
    }

    tableTabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tab = button.dataset.tab;

            tableTabButtons.forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            button.classList.add('border-blue-500', 'text-blue-600');
            button.classList.remove('border-transparent', 'text-gray-500');

            document.querySelectorAll('.table-tab-content').forEach(content => {
                // Hide all main tab contents
                content.classList.add('hidden');
            });

            // Show the selected one
            const activeContent = document.getElementById(`${tab}-tab-content`);
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }

        });
    });

    // Event Listeners for Create Table Modal Tabs
    createTableTabButtonsInModal.forEach(button => {
        button.addEventListener('click', () => {
            const tab = button.dataset.tab;

            // Update button styles
            createTableTabButtonsInModal.forEach(btn => {
                btn.classList.remove('bg-white', 'shadow');
            });
            button.classList.add('bg-white', 'shadow');

            // Show/hide tab content
            guiCreateTab.classList.toggle('hidden', tab !== 'gui');
            sqlCreateTab.classList.toggle('hidden', tab !== 'sql');

        });
    });


    // Modal Logic

    function openModal(modal) {
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
    }

    function closeModal(modal) {
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 250);
    }

    function toggleSidebar() {
        const isCollapsed = sidebar.classList.toggle('collapsed');
        if (isCollapsed) {
            sidebar.classList.remove('w-72');
            sidebar.classList.add('w-20');
        } else {
            sidebar.classList.remove('w-20');
            sidebar.classList.add('w-72');
        }
        document.getElementById('collapse-icon').classList.toggle('hidden', isCollapsed);
        document.getElementById('expand-icon').classList.toggle('hidden', !isCollapsed);
        
        // Save preference to local storage
        localStorage.setItem('sidebarCollapsed', isCollapsed);
    }

    function checkAndCollapseSidebar() {
        if (window.innerWidth < 768 && !sidebar.classList.contains('collapsed')) {
            toggleSidebar();
        }
    }
    function createColumnRow(isPk = false) {
        const id = `col-${Date.now()}`;
        const tableOptions = state.tables.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

        const div = document.createElement('div');
        div.className = 'column-row grid grid-cols-12 gap-2 items-center border-t pt-2';
        div.innerHTML = `
            <div class="col-span-12 grid grid-cols-12 gap-2 items-center">
                <input type="text" data-key="name" placeholder="column_name" required class="col-span-3 p-2 border rounded-md" ${isPk ? 'value="id" readonly' : ''}>
                <select data-key="type" class="col-span-2 p-2 border rounded-md bg-white" ${isPk ? 'disabled' : ''}>
                    ${isPk ? '<option value="serial" selected>SERIAL (PK)</option>' : `
                    <option value="text" selected>TEXT</option>
                    <option value="integer">INTEGER</option>
                    <option value="real">REAL</option>
                    <option value="boolean">BOOLEAN</option>
                    <option value="timestamp">TIMESTAMP</option>
                    <option value="jsonb">JSONB</option>
                    `}
                </select>
                <div class="col-span-3 flex items-center justify-around text-xs">
                    <label class="flex flex-col items-center"><input data-key="is_not_null" type="checkbox" class="h-4 w-4 rounded" ${isPk ? 'checked disabled' : ''}><span>Not Null</span></label>
                    <label class="flex flex-col items-center"><input data-key="is_unique" type="checkbox" class="h-4 w-4 rounded" ${isPk ? 'checked disabled' : ''}><span>Unique</span></label>
                </div>
            </div>
            <div class="col-span-12 mt-2 pl-1">
                <label class="flex items-center text-xs cursor-pointer"><input type="checkbox" data-key="is_foreign_key" class="fk-checkbox h-4 w-4 rounded mr-2" ${isPk ? 'disabled' : ''}><span>Is Foreign Key</span></label>
                <div class="fk-options-container hidden grid grid-cols-2 gap-2 mt-2 pl-6">
                    <select data-key="fk_table_id" class="fk-table-select p-1 border rounded-md bg-white text-xs">
                        <option value="">-- Select Table --</option>
                        ${tableOptions}
                    </select>
                    <select data-key="fk_column_name" class="fk-column-select p-1 border rounded-md bg-white text-xs" disabled><option value="">-- Select Column --</option></select>
                </div>
            </div>
            <div class="col-span-4 flex justify-end">
                ${!isPk ? '<button type="button" class="remove-column-btn bg-red-100 text-red-700 px-2 py-1 text-xs rounded-md hover:bg-red-200">Delete</button>' : ''}
            </div>
            <input type="hidden" data-key="is_primary_key" value="${isPk}">
        `;
        return div;
    }

    function validateCreateTableForm() {
        const tableName = document.getElementById('new-table-name').value.trim();
        let allColumnsNamed = true;
        document.querySelectorAll('#new-columns-list .column-row').forEach(row => {
            const colName = row.querySelector('[data-key="name"]').value.trim();
            if (!colName) {
                allColumnsNamed = false;
            }
        });
        const isValid = tableName && allColumnsNamed;
        submitCreateTableBtn.disabled = !isValid;
    }

    function resetCreateTableModal() {
        document.getElementById('new-table-name').value = '';
        const columnsList = document.getElementById('new-columns-list');
        columnsList.innerHTML = '';
        columnsList.appendChild(createColumnRow(true)); // Add default PK
        validateCreateTableForm(); // Set initial button state
    }

    // This is a more robust way to handle the submit button click, especially when
    // other libraries like CodeMirror might interfere with form submission events.
    submitCreateTableBtn.addEventListener('click', (e) => {
        handleCreateTableSubmit(e);
    });

    async function handleCreateTableSubmit(e) {
        e.preventDefault();
        const activeTab = document.querySelector('#create-table-modal .create-table-tab-btn.bg-white').dataset.tab;
        let payload;
        let url = `/api/v1/databases/${state.dbId}/tables`;
        let method = 'POST';

        submitCreateTableBtn.disabled = true;
        submitCreateTableBtn.textContent = 'Creating...';

        if (activeTab === 'gui') {
            const tableName = document.getElementById('new-table-name').value.trim();
            const columnRows = document.querySelectorAll('#new-columns-list .column-row');
            
            const columns = Array.from(columnRows).map(row => {
                const isFk = row.querySelector('[data-key="is_foreign_key"]').checked;
                let fk = null;
                if (isFk) {
                    const tableId = row.querySelector('[data-key="fk_table_id"]').value;
                    const columnName = row.querySelector('[data-key="fk_column_name"]').value;
                    if (tableId && columnName) {
                        fk = {
                            table_id: parseInt(tableId, 10),
                            column_name: columnName
                        };
                    }
                }
                return {
                    name: row.querySelector('[data-key="name"]').value,
                    type: row.querySelector('[data-key="type"]').value,
                    is_primary_key: row.querySelector('[data-key="is_primary_key"]').value === 'true',
                    is_not_null: row.querySelector('[data-key="is_not_null"]').checked,
                    is_unique: row.querySelector('[data-key="is_unique"]').checked,
                    foreign_key: fk
                };
            });
            payload = { name: tableName, columns };

        } else { // activeTab === 'sql'
            url = `/api/v1/databases/${state.dbId}/create-table-from-sql`;
            const sqlScript = document.getElementById('create-table-sql-input').value.trim();
            payload = { script: sqlScript };
        }

        try {
            const response = await fetchWithAuth(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const errorDetail = await getErrorFromResponse(response);
                throw new Error(errorDetail);
            }
            closeModal(createTableModal);
            const newTable = await response.json();
            await fetchDbIdAndTables(); // Refresh table list
            
            // Auto-select the newly created table
            const newTableLink = tableList.querySelector(`a[data-table-id="${newTable.id}"]`);
            if (newTableLink) {
                newTableLink.click();
            }
        } catch (error) {
            showError(error.message, error);
        } finally {
            submitCreateTableBtn.disabled = false;
            submitCreateTableBtn.textContent = 'Create Table';
        }
    }

    async function handleDeleteTable() {
        if (!state.selectedTable) return;
        const keepEvents = document.getElementById('keep-calendar-events-checkbox').checked;
        const url = `/api/v1/tables/${state.selectedTable.id}?keep_calendar_events=${keepEvents}`;
        try {
            const response = await fetchWithAuth(url, { method: 'DELETE' });
            if (!response.ok) {
                const errorDetail = await getErrorFromResponse(response);
                throw new Error(errorDetail);
            }
            // Success
            closeModal(deleteTableModal);
            mainContent.classList.add('hidden');
            placeholderContent.classList.remove('hidden');
            tableTabContainer.classList.add('hidden');
            deleteTableBtn.disabled = true;
            state.selectedTable = null;
            await fetchDbIdAndTables(); // Refresh list
        } catch (error) {
            showError(error.message || 'Failed to delete table.', error);
        }
    }

    async function handleAddRow() {
        if (!state.selectedTable) return;

        addRowBtn.disabled = true;
        addRowBtn.textContent = 'Adding...';

        // 1. Create the row in the database
        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/rows`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // The backend now expects a `data` object, even if it's empty.
                body: JSON.stringify({ data: {} })
            });
            if (!response.ok) {
                const errorDetail = await getErrorFromResponse(response);
                throw new Error(errorDetail);
            }
            
            // FIX: Explicitly refetch both the data grid and the calendar events.
            if (calendar) calendar.refetchEvents();
            await fetchAndRenderData(state.selectedTable.id, 1, searchInput.value.trim());

        } catch (error) {
            showError(error.message || 'Failed to add row. Please check the console for details.', error);
        } finally {
            addRowBtn.disabled = false;
            addRowBtn.textContent = 'Add Row';
        }
    }

    async function handleDeleteRow(rowId) {
        if (confirm('Are you sure you want to delete this row?')) {
            try {
                const response = await fetchWithAuth(`/api/v1/rows/${rowId}`, { method: 'DELETE' });
                if (!response.ok) {
                    const errorDetail = await getErrorFromResponse(response);
                    throw new Error(errorDetail);
                }
                // On success, refresh the data grid to show the change.
                // This is more robust than just removing the row from the UI,
                // as it correctly handles pagination.
                await fetchAndRenderData(state.selectedTable.id, state.pagination.currentPage, searchInput.value.trim());
                // FIX: Explicitly refresh calendar
                if (calendar) calendar.refetchEvents();
            } catch (error) {
                showError(error.message || 'Failed to delete row.', error);
            }
        }
    }

    async function handleExportCsv() {
        if (!state.selectedTable) return;
        exportCsvBtn.textContent = 'Exporting...';
        exportCsvBtn.disabled = true;

        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/all-rows`);
            if (!response.ok) throw new Error('Could not fetch data for export.');

            const rows = await response.json();
            if (rows.length === 0) {
                showError('Table is empty, nothing to export.');
                return;
            }

            const columns = state.selectedTable.columns.map(c => c.name);
            const csvRows = [columns.join(',')]; // Header row

            rows.forEach(row => {
                const values = columns.map(colName => {
                    const value = colName === 'id' ? row.id : (row.data ? (row.data[colName] ?? '') : '');
                    // Basic CSV escaping: wrap in quotes if it contains a comma or quote
                    const strValue = String(value);
                    if (strValue.includes(',') || strValue.includes('"')) {
                        return `"${strValue.replace(/"/g, '""')}"`;
                    };
                    return strValue;
                });
                csvRows.push(values.join(','));
            });

            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.selectedTable.name}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        } catch (error) {
            showError(`Error exporting CSV: ${error.message}`, error);
        } finally {
            exportCsvBtn.textContent = 'Export to CSV';
            exportCsvBtn.disabled = false;
        }
    }

    async function handleUpdateRow(cellElement) {
        const tr = cellElement.closest('tr');
        const rowId = tr.dataset.rowId;
        if (!rowId) return;

        const rowData = {};
        tr.querySelectorAll('td[data-column-name]').forEach(cell => {
            const colName = cell.dataset.columnName;
            const fkSelect = cell.querySelector('.fk-select');
            const boolSelect = cell.querySelector('.boolean-select');
            const dateInput = cell.querySelector('.timestamp-input');
            const regularInput = cell.querySelector('.editable-cell-input');

            if (fkSelect) {
                rowData[colName] = fkSelect.value;
            } else if (boolSelect) {
                rowData[colName] = boolSelect.value;
            } else if (dateInput) {
                rowData[colName] = dateInput.value;
            } else if (regularInput) {
                rowData[colName] = regularInput.value;
            }
        });

        // If the cell that triggered the update is an input, give it feedback
        const inputElement = cellElement.querySelector('input, select');
        const feedbackElement = inputElement || cellElement;


        const payload = { data: rowData };

        try {
            const response = await fetchWithAuth(`/api/v1/rows/${rowId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to update row');
            }
            // Visual feedback for success
            feedbackElement.style.transition = 'background-color 0.5s';
            feedbackElement.style.backgroundColor = '#dcfce7'; // Tailwind green-100
            setTimeout(() => {
                feedbackElement.style.backgroundColor = '';
            }, 1500);

            // FIX: Explicitly refresh calendar on successful row update
            if (calendar) calendar.refetchEvents();
        } catch (error) {
            showError(`Error saving data: ${error.message}`, error); // Revert UI on failure
            fetchAndRenderData(state.selectedTable.id); // Revert UI on failure
        }
    }

    function renderPagination() {
        const { currentPage, limit, totalRows } = state.pagination;
        const paginationControls = document.getElementById('pagination-controls');
        paginationControls.innerHTML = '';

        if (totalRows === 0) {
            // Don't show pagination if there are no results
            return;
        }

        if (totalRows <= limit && currentPage === 1) return; // Also hide if only one page

        const totalPages = Math.ceil(totalRows / limit);
        const startRow = totalRows > 0 ? (currentPage - 1) * limit + 1 : 0;
        const endRow = Math.min(currentPage * limit, totalRows);

        const info = document.createElement('div');
        info.textContent = `Showing ${startRow} to ${endRow} of ${totalRows} rows`;
        
        const buttons = document.createElement('div');
        buttons.className = 'flex gap-2';
        buttons.innerHTML = `
            <button data-page="${currentPage - 1}" class="prev-page-btn px-3 py-1 border rounded-md bg-white hover:bg-gray-100" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
            <span class="px-3 py-1">Page ${currentPage} of ${totalPages}</span>
            <button data-page="${currentPage + 1}" class="next-page-btn px-3 py-1 border rounded-md bg-white hover:bg-gray-100" ${currentPage >= totalPages ? 'disabled' : ''}>Next</button>
        `;

        paginationControls.appendChild(info);
        paginationControls.appendChild(buttons);
    }

    async function saveTableStructure() {
        if (!state.selectedTable) return false;

        const payload = {
            name: state.selectedTable.name,
            columns: state.selectedTable.columns
        };

        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                const errorDetail = await getErrorFromResponse(response);
                throw new Error(errorDetail);
            }

            const updatedTable = await response.json();
            const tableIndex = state.tables.findIndex(t => t.id === updatedTable.id);
            if (tableIndex > -1) state.tables[tableIndex] = updatedTable;
            state.selectedTable = updatedTable;
            await fetchAndRenderData(state.selectedTable.id, 1, searchInput.value.trim());
            renderStructure(state.selectedTable.columns);
            return true; // Success
        } catch (error) {
            showError(`Error: ${error.message}`, error);
            await fetchDbIdAndTables(); // Re-fetch to revert optimistic changes
            return false; // Failure
        }
    }

    function populateAndOpenEditModal(column, index) {
        document.getElementById('edit-column-index').value = index;
        document.getElementById('edit-column-name').value = column.name;
        document.getElementById('edit-column-type').value = column.type;
        document.getElementById('edit-is-not-null').checked = column.is_not_null;
        document.getElementById('edit-is-unique').checked = column.is_unique;
        document.getElementById('edit-column-type').disabled = !!column.foreign_key;
        openModal(editColumnModal);
    }

    async function handleEditColumnSubmit(e) {
        e.preventDefault();
        const index = parseInt(document.getElementById('edit-column-index').value, 10);
        state.selectedTable.columns[index].name = document.getElementById('edit-column-name').value;
        state.selectedTable.columns[index].type = document.getElementById('edit-column-type').value;
        state.selectedTable.columns[index].is_not_null = document.getElementById('edit-is-not-null').checked;
        state.selectedTable.columns[index].is_unique = document.getElementById('edit-is-unique').checked;
        
        if (await saveTableStructure()) {
            closeModal(editColumnModal);
        }
    }

    async function handleViewDbSql() {
        if (!state.dbId) return;
        
        dbSqlCodeContent.textContent = 'Loading SQL...';
        openModal(viewDbSqlModal);

        try {
            const response = await fetchWithAuth(`/api/v1/databases/${state.dbId}/export-sql`);
            if (!response.ok) throw new Error('Failed to fetch database SQL');
            
            const sqlText = await response.text();
            dbSqlCodeContent.textContent = sqlText;
            hljs.highlightElement(dbSqlCodeContent);
        } catch (error) {
            dbSqlCodeContent.textContent = `-- Error fetching SQL: ${error.message}`;
        }
    }

    // Sidebar Toggle Event Listener
    toggleSidebarBtn.addEventListener('click', toggleSidebar);
    // Event Listeners
    tableList.addEventListener('click', handleTableSelect);
    addRowBtn.addEventListener('click', handleAddRow);
    importRowsBtn.addEventListener('click', () => {
        if (!state.selectedTable) return;
        document.getElementById('import-rows-table-name').textContent = state.selectedTable.name;
        importRowsForm.reset();
        document.getElementById('import-rows-mapping-container').classList.add('hidden');
        importRowsForm.querySelector('button[type="submit"]').disabled = true;
        openModal(importRowsModal);
        closeModal(importSummaryModal);
    });
    cancelImportRowsBtn.addEventListener('click', () => closeModal(importRowsModal));

    importCsvBtn.addEventListener('click', () => {
        importCsvForm.reset();
        importStep1.classList.remove('hidden');
        importStep2.classList.add('hidden');
        importCsvNextBtn.classList.remove('hidden');
        importCsvSubmitBtn.classList.add('hidden');
        importCsvNextBtn.disabled = true;
        openModal(importCsvModal);
    });
    cancelImportCsvBtn.addEventListener('click', () => closeModal(importCsvModal));

    function checkImportCsvNextButtonState() {
        const file = importCsvFile.files[0];
        const tableName = importTableName.value.trim();
        importCsvNextBtn.disabled = !file || !tableName;
    }

    importCsvFile.addEventListener('change', () => {
        const file = importCsvFile.files[0];
        if (file) {
            importTableName.value = file.name.replace(/\.csv$/i, '').replace(/[^a-z0-9_]+/gi, '_').toLowerCase();
        }
        checkImportCsvNextButtonState();
    });
    importTableName.addEventListener('input', checkImportCsvNextButtonState);

    importCsvNextBtn.addEventListener('click', async () => {
        const file = importCsvFile.files[0];
        const tableName = importTableName.value.trim();
        if (!file || !tableName) {
            showError('Table name and CSV file are required.');
            return;
        }

        importCsvNextBtn.disabled = true;
        importCsvNextBtn.textContent = 'Processing...';

        const reader = new FileReader();
        reader.onload = async (e) => {
            const csvContent = e.target.result;
            try {
                const response = await fetchWithAuth('/api/v1/import-csv/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ csv_content: csvContent })
                });
                if (!response.ok) throw new Error(await getErrorFromResponse(response));
                const previewData = await response.json();
                
                // Populate review table
                csvReviewTbody.innerHTML = '';
                let pk_found = false;
                previewData.sanitized_headers.forEach((header, i) => {
                    const is_pk = header === 'id' && !pk_found;
                    if (is_pk) pk_found = true;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-2 font-mono text-gray-600">${previewData.original_headers[i]}</td>
                        <td class="p-2 font-mono">${header}</td>
                        <td class="p-2">
                            <select data-col-name="${header}" class="csv-col-type-select w-full p-1 border rounded-md bg-white">
                                <option value="text">TEXT</option>
                                <option value="integer">INTEGER</option>
                                <option value="real">REAL</option>
                                <option value="boolean">BOOLEAN</option>
                                <option value="timestamp">TIMESTAMP</option>
                            </select>
                        </td>
                        <td class="p-2 text-center">
                            <input type="checkbox" data-col-name="${header}" class="csv-col-pk-checkbox h-4 w-4 rounded" ${is_pk ? 'checked' : ''}>
                        </td>
                    `;
                    csvReviewTbody.appendChild(tr);
                    tr.querySelector('.csv-col-type-select').value = previewData.inferred_types[i];
                });

                // Switch to step 2
                importStep1.classList.add('hidden');
                importStep2.classList.remove('hidden');
                importCsvNextBtn.classList.add('hidden');
                importCsvSubmitBtn.classList.remove('hidden');

            } catch (error) {
                showError(error.message);
            } finally {
                importCsvNextBtn.disabled = false;
                importCsvNextBtn.textContent = 'Review Columns';
            }
        };
        reader.readAsText(file);
    });

    importCsvForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const tableName = importTableName.value.trim();

        // Gather column definitions from the review step
        const columns = [];
        csvReviewTbody.querySelectorAll('tr').forEach(tr => {
            const name = tr.children[1].textContent;
            const type = tr.querySelector('.csv-col-type-select').value;
            const is_pk = tr.querySelector('.csv-col-pk-checkbox').checked;
            columns.push({
                name: name,
                type: type,
                is_primary_key: is_pk,
                is_not_null: is_pk, // Default not null for PK
                is_unique: is_pk, // Default unique for PK
                foreign_key: null
            });
        });

        importCsvSubmitBtn.disabled = true;
        importCsvSubmitBtn.textContent = 'Importing...';

        const fileReader = new FileReader();
        fileReader.onload = async (e) => {
            const csvContent = e.target.result;
            const payload = {
                name: tableName,
                csv_content: csvContent,
                columns: columns
            };

            try {
                const response = await fetchWithAuth(`/api/v1/databases/${state.dbId}/import-csv`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                const errorDetail = await getErrorFromResponse(response);
                throw new Error(errorDetail);
                }
                closeModal(importCsvModal);
                const newTable = await response.json();
                await fetchDbIdAndTables();
                const newTableLink = tableList.querySelector(`a[data-table-id="${newTable.id}"]`);
                if (newTableLink) newTableLink.click();
            } catch (error) {
                showError(error.message);
            } finally {
                importCsvSubmitBtn.disabled = false;
                importCsvSubmitBtn.textContent = 'Create Table & Import';
            }
        };
        fileReader.readAsText(importCsvFile.files[0]);
    });

    importRowsCsvFile.addEventListener('change', () => {
        const file = importRowsCsvFile.files[0];
        const mappingContainer = document.getElementById('import-rows-mapping-container');
        const mappingFields = document.getElementById('import-rows-mapping-fields');
        const submitBtn = importRowsForm.querySelector('button[type="submit"]');

        if (!file) {
            mappingContainer.classList.add('hidden');
            submitBtn.disabled = true;
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const firstLine = e.target.result.split('\n')[0].trim();
            const csvHeaders = firstLine.split(',').map(h => h.trim().replace(/"/g, ''));
            const tableColumns = state.selectedTable.columns.filter(c => !c.is_primary_key);

            mappingFields.innerHTML = '';
            tableColumns.forEach(col => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-2 gap-4 items-center';
                div.innerHTML = `
                    <label class="text-right font-medium text-gray-700">${col.name} <span class="font-mono text-xs text-purple-600">(${col.type})</span></label>
                    <select data-table-col="${col.name}" class="import-rows-col-select p-2 border rounded-md bg-white">
                        <option value="">-- Don't Import --</option>
                        ${csvHeaders.map(h => `<option value="${h}">${h}</option>`).join('')}
                    </select>
                `;
                mappingFields.appendChild(div);
                // Auto-select if header matches column name
                const matchingHeader = csvHeaders.find(h => h.toLowerCase().replace(/[\s_]+/g, '') === col.name.toLowerCase().replace(/[\s_]+/g, ''));
                if (matchingHeader) {
                    div.querySelector('select').value = matchingHeader;
                }
            });
            mappingContainer.classList.remove('hidden');
            submitBtn.disabled = false;
        };
        reader.readAsText(file);
    });

    importRowsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = importRowsCsvFile.files[0];
        if (!file || !state.selectedTable) return;

        const columnMapping = {};
        document.querySelectorAll('.import-rows-col-select').forEach(select => {
            if (select.value) {
                columnMapping[select.dataset.tableCol] = select.value;
            }
        });

        if (Object.keys(columnMapping).length === 0) {
            showError('You must map at least one CSV column.');
            return;
        }

        const submitBtn = importRowsForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Importing...';

        const reader = new FileReader();
        reader.onload = async (e) => {
            const csvContent = e.target.result;
            try {
                const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/import-rows-from-csv`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ csv_content: csvContent, column_mapping: columnMapping })
                });
                if (!response.ok) throw new Error(await getErrorFromResponse(response));
                const result = await response.json();
                closeModal(importRowsModal);
                
                // Show summary modal
                const summaryContent = document.getElementById('import-summary-content');
                summaryContent.innerHTML = `
                    <p><strong class="font-semibold text-green-600">${result.inserted_count}</strong> rows were successfully imported.</p>
                    <p><strong class="font-semibold text-red-600">${result.failed_count}</strong> rows failed to import.</p>
                `;
                if (result.failed_count > 0) {
                    const errorReportLink = document.createElement('a');
                    errorReportLink.href = "#";
                    errorReportLink.className = "text-blue-600 hover:underline font-semibold";
                    errorReportLink.textContent = "Download Error Report (CSV)";
                    errorReportLink.onclick = (e) => {
                        e.preventDefault();
                        generateErrorCsv(result.errors);
                    };
                    const p = document.createElement('p');
                    p.className = "mt-4";
                    p.appendChild(errorReportLink);
                    summaryContent.appendChild(p);
                }
                openModal(importSummaryModal);

                if (result.inserted_count > 0) {
                    await fetchAndRenderData(state.selectedTable.id, 1); // Refresh data view if anything was inserted
                }
            } catch (error) {
                showError(error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Import Rows';
            }
        };
        reader.readAsText(file);
    });

    closeSummaryModalBtn.addEventListener('click', () => closeModal(importSummaryModal));

    function generateErrorCsv(errors) {
        if (!errors || errors.length === 0) return;

        const originalHeaders = Object.keys(errors[0].data);
        const csvHeaders = ['Row Number', 'Error', ...originalHeaders];
        
        const csvRows = [csvHeaders.join(',')]; // Header row

        errors.forEach(err => {
            const values = [
                err.row_number,
                `"${err.error.replace(/"/g, '""')}"`, // Escape quotes in error message
                ...originalHeaders.map(h => {
                    const value = err.data[h] ?? '';
                    const strValue = String(value);
                    if (strValue.includes(',') || strValue.includes('"')) {
                        return `"${strValue.replace(/"/g, '""')}"`;
                    }
                    return strValue;
                })
            ];
            csvRows.push(values.join(','));
        });

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `import_error_report.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }
    
    createTableBtn.addEventListener('click', () => {
        resetCreateTableModal();
        openModal(createTableModal);
    });
    cancelCreateTableBtn.addEventListener('click', () => closeModal(createTableModal));
    
    deleteTableBtn.addEventListener('click', () => {
        if (!state.selectedTable) return;
        modalTableName.textContent = state.selectedTable.name;
        openModal(deleteTableModal);
    });
    cancelDeleteTableBtn.addEventListener('click', () => closeModal(deleteTableModal));
    confirmDeleteTableBtn.addEventListener('click', handleDeleteTable);
    
    cancelCreateEventBtn.addEventListener('click', () => closeModal(createEventModal));

    cancelSendToCalendarBtn.addEventListener('click', () => closeModal(sendToCalendarModal));
    editColumnForm.addEventListener('submit', handleEditColumnSubmit);
    cancelEditColumnBtn.addEventListener('click', () => closeModal(editColumnModal));

    structureTbody.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-column-btn');
        const deleteBtn = e.target.closest('.delete-column-btn');

        if (editBtn) {
            const index = parseInt(editBtn.dataset.columnIndex, 10);
            populateAndOpenEditModal(state.selectedTable.columns[index], index);
        }

        if (deleteBtn) {
            const index = parseInt(deleteBtn.dataset.columnIndex, 10);
            const column = state.selectedTable.columns[index];
            if (confirm(`Are you sure you want to delete the column "${column.name}"?`)) {
                state.selectedTable.columns.splice(index, 1);
                saveTableStructure();
            }
        }
    });
    dataTbody.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-row-btn');
        if (deleteBtn) {
            const rowId = deleteBtn.dataset.rowId;
            handleDeleteRow(rowId);
        }
        const sendToCalendarBtn = e.target.closest('.send-to-calendar-btn');
        if (sendToCalendarBtn) {
            const rowId = sendToCalendarBtn.dataset.rowId;
            openSendToCalendarModal(rowId);
        }
    });

    document.getElementById('copy-table-sql-btn').addEventListener('click', (e) => {
        const code = document.getElementById('table-sql-code').textContent;
        navigator.clipboard.writeText(code).then(() => {
            e.target.textContent = 'Copied!';
            setTimeout(() => e.target.textContent = 'Copy', 2000);
        });
    });
    exportCsvBtn.addEventListener('click', handleExportCsv);

    viewDbSqlBtn.addEventListener('click', handleViewDbSql);
    viewDbSqlSidebarBtn.addEventListener('click', handleViewDbSql);
    closeDbSqlModalBtn.addEventListener('click', () => closeModal(viewDbSqlModal));

    calendarBtn.addEventListener('click', () => {
        mainContent.classList.add('hidden');
        placeholderContent.classList.add('hidden');
        calendarView.classList.remove('hidden');

        tableList.querySelectorAll('a').forEach(a => a.classList.remove('bg-blue-100', 'text-blue-700', 'font-semibold'));
        // Keep selected table state for "Create New Event"
        // state.selectedTable = null; 
        deleteTableBtn.disabled = true;

        calendar.render();
    });

    // Centralized listener for all data grid cell updates
    dataTbody.addEventListener('change', (e) => {
        const target = e.target;
        if (target.matches('.fk-select, .boolean-select, .timestamp-input, .editable-cell-input')) {
            handleUpdateRow(target.closest('td'));
        }
    });

    dataTbody.addEventListener('blur', (e) => {
        const target = e.target;
        // The 'change' event covers selects and date inputs well.
        // 'blur' is a good fallback for text/number inputs.
        if (target.matches('.editable-cell-input')) {
            handleUpdateRow(target.closest('td'));
        }
    });

    const debouncedSearch = debounce(() => {
        const searchTerm = searchInput.value.trim();
        if (state.selectedTable) {
            fetchAndRenderData(state.selectedTable.id, 1, searchTerm);
        }
    });

    searchInput.addEventListener('input', debouncedSearch);

    document.getElementById('pagination-controls').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (target && (target.classList.contains('prev-page-btn') || target.classList.contains('next-page-btn'))) {
            const page = parseInt(target.dataset.page, 10);
            if (page && state.selectedTable) {
                fetchAndRenderData(state.selectedTable.id, page);
            }
        }
    });
    createTableModal.addEventListener('input', (e) => {
        if (e.target.matches('#new-table-name, [data-key="name"]')) {
            // This handles typing in the table name or any column name
            validateCreateTableForm();
        }
    });
    document.getElementById('new-columns-list').addEventListener('change', (e) => {
        // FK checkbox toggle
        if (e.target.classList.contains('fk-checkbox')) {
            const container = e.target.closest('.column-row').querySelector('.fk-options-container');
            container.classList.toggle('hidden', !e.target.checked);
        }
        // FK table select
        if (e.target.classList.contains('fk-table-select')) {
            const tableId = e.target.value;
            const columnSelect = e.target.closest('.fk-options-container').querySelector('.fk-column-select');
            columnSelect.innerHTML = '<option value="">-- Select Column --</option>';
            columnSelect.disabled = true;

            if (tableId) {
                const targetTable = state.tables.find(t => t.id == tableId);
                if (targetTable) {
                    targetTable.columns.forEach(col => {
                        columnSelect.innerHTML += `<option value="${col.name}">${col.name}</option>`;
                    });
                    columnSelect.disabled = false;
                }
            }
        }
    });

    document.getElementById('new-columns-list').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-column-btn')) {
            e.target.closest('.column-row').remove();
            // Re-validate when a column is removed
            validateCreateTableForm();
        }
    });

    
    addColumnToModalBtn.addEventListener('click', () => {
        document.getElementById('new-columns-list').appendChild(createColumnRow());
        validateCreateTableForm(); // Re-validate when a new column is added
    });

    // Add validation listeners for the create table modal



    function openCreateEventModal(dateStr) {
        if (state.tables.length === 0) {
            showError("You must have at least one table in this database to create an event.");
            return;
        }

        const form = document.getElementById('create-event-form');
        form.reset();

        const tableSelect = document.getElementById('event-source-table-select');
        const rowSelect = document.getElementById('event-source-row-select');
        const startTimeInput = document.getElementById('create-event-start-time');

        // Populate table dropdown
        tableSelect.innerHTML = '<option value="">-- Select a Table --</option>';
        state.tables.forEach(table => {
            tableSelect.innerHTML += `<option value="${table.id}">${table.name}</option>`;
        });
        rowSelect.innerHTML = '<option value="">-- Select a Table First --</option>';
        rowSelect.disabled = true;

        // Pre-fill date
        startTimeInput.value = `${dateStr}T12:00`;

        openModal(createEventModal);
    }

    document.getElementById('event-source-table-select').addEventListener('change', async (e) => {
        const tableId = e.target.value;
        const rowSelect = document.getElementById('event-source-row-select');
        const titleInput = document.getElementById('create-event-title');

        if (!tableId) {
            rowSelect.innerHTML = '<option value="">-- Select a Table First --</option>';
            rowSelect.disabled = true;
            return;
        }

        rowSelect.disabled = true;
        rowSelect.innerHTML = '<option value="">Loading rows...</option>';

        try {
            const response = await fetchWithAuth(`/api/v1/tables/${tableId}/all-rows`);
            if (!response.ok) throw new Error('Failed to fetch rows for selection.');
            const rows = await response.json();

            const table = state.tables.find(t => t.id == tableId);
            const displayColumn = table.columns.find(c => /name|title|subject|email/i.test(c.name)) || table.columns.find(c => c.is_primary_key);

            rowSelect.innerHTML = '<option value="">-- Select a Row --</option>';
            rows.forEach(row => {
                const displayValue = row.data[displayColumn.name] || `Row ID: ${row.id}`;
                rowSelect.innerHTML += `<option value="${row.id}" data-display-text="${displayValue}">${displayValue}</option>`;
            });
            rowSelect.disabled = false;

        } catch (error) {
            showError(error.message);
            rowSelect.innerHTML = '<option value="">-- Error Loading Rows --</option>';
        }
    });

    document.getElementById('event-source-row-select').addEventListener('change', (e) => {
        const selectedOption = e.target.options[e.target.selectedIndex];
        const titleInput = document.getElementById('create-event-title');
        if (selectedOption && selectedOption.value) {
            titleInput.value = selectedOption.dataset.displayText;
        }
    });

    document.getElementById('create-event-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitBtn = form.querySelector('button[type="submit"]');

        const payload = {
            source_table_id: document.getElementById('event-source-table-select').value,
            source_row_id: document.getElementById('event-source-row-select').value,
            title: document.getElementById('create-event-title').value,
            start_time: document.getElementById('create-event-start-time').value,
        };

        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';

        try {
            const response = await fetchWithAuth(`/api/v1/calendar/events`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to create event.');
            }

            closeModal(createEventModal);
            calendar.refetchEvents();
        } catch (error) {
            showError(error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Event';
        }
    });

    function openSendToCalendarModal(rowId, defaultDate = null) {
        if (!state.selectedTable) {
            showError("Please select a table first.");
            return;
        }

        document.getElementById('calendar-source-row-id').value = rowId;
        const columns = state.selectedTable.columns.filter(c => !c.is_primary_key);
        const dateLikeColumns = columns.filter(c => c.type === 'timestamp' || c.type === 'text'); // Be liberal with what can be a date

        const selects = {
            'calendar-title-col': columns,
            'calendar-start-col': dateLikeColumns,
            'calendar-end-col': dateLikeColumns,
            'calendar-desc-col': columns
        };

        for (const [selectId, cols] of Object.entries(selects)) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- Select Column --</option>';
            cols.forEach(col => {
                select.innerHTML += `<option value="${col.name}">${col.name}</option>`;
            });
        }
        
        // Auto-select common names
        const titleSelect = document.getElementById('calendar-title-col');
        const startSelect = document.getElementById('calendar-start-col');
        
        const autoTitle = columns.find(c => /title|name|subject|task/i.test(c.name));
        if (autoTitle) titleSelect.value = autoTitle.name;

        // If a default date is provided (from calendar click), use it.
        if (defaultDate) {
            // This part is tricky without a dedicated date input. We'll rely on mapping.
        }
        const autoStart = dateLikeColumns.find(c => /start|date|deadline|due/i.test(c.name)) || (dateLikeColumns.length > 0 ? dateLikeColumns[0] : null);
        if (autoStart) startSelect.value = autoStart.name;

        openModal(sendToCalendarModal);
    }

    document.getElementById('send-to-calendar-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const rowId = document.getElementById('calendar-source-row-id').value;
        const payload = {
            title_column: document.getElementById('calendar-title-col').value,
            start_time_column: document.getElementById('calendar-start-col').value,
            end_time_column: document.getElementById('calendar-end-col').value || null,
            description_column: document.getElementById('calendar-desc-col').value || null,
        };

        try {
            const response = await fetchWithAuth(`/api/v1/rows/${rowId}/send-to-calendar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to create event');
            }
            closeModal(sendToCalendarModal);
            calendar.refetchEvents(); // Refresh calendar to show the new event
        } catch (error) {
            showError(error.message);
        }
    });

    function initializeCalendar() {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            dayMaxEvents: true, // This is the key for handling multiple events!
            eventClick: (info) => {
                openEventDetailsModal(info.event);
            },
            dateClick: (info) => {
                handleDateClick(info);
            },
            editable: true,
            eventDrop: async (info) => {
                // Handle event drag-and-drop
                const { event } = info;
                try {
                    await fetchWithAuth(`/api/v1/calendar/events/${event.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ start_time: event.start.toISOString(), end_time: event.end ? event.end.toISOString() : null })
                    });
                } catch (error) {
                    showError('Failed to update event time.');
                    info.revert(); // Revert the change on failure
                }
            },
            eventDidMount: function(info) {
                tippy(info.el, {
                    content: `<strong>${info.event.title}</strong>` +
                             (info.event.extendedProps.description ? `<div class="mt-1 text-sm">${info.event.extendedProps.description}</div>` : ''),
                    allowHTML: true,
                    placement: 'top',
                });
            },
            events: async (fetchInfo, successCallback, failureCallback) => {
                if (!state.dbId) {
                    successCallback([]); // Return an empty array of events.
                    return;
                }

                const start = fetchInfo.startStr.split('T')[0];
                const end = fetchInfo.endStr.split('T')[0];

                try {
                    const response = await fetchWithAuth(`/api/v1/calendar/events?start_date=${start}&end_date=${end}&db_id=${state.dbId}`);
                    if (!response.ok) throw new Error('Failed to fetch events');
                    const apiEvents = await response.json();
                    const calendarEvents = apiEvents.map(event => ({
                        id: event.id, title: event.title, start: event.start_time, end: event.end_time,
                        allDay: !event.start_time.includes('T'),
                        extendedProps: { ...event }, // Pass the whole event object
                        backgroundColor: event.is_completed ? '#10B981' : '#3B82F6',
                        borderColor: event.is_completed ? '#059669' : '#2563EB',
                    }));
                    successCallback(calendarEvents);
                } catch (error) {
                    showError('Failed to load calendar events. Please check console for details.', error);
                    failureCallback(error);
                }
            }
        });
    }

    function handleDateClick(info) {
        const eventsContainer = document.getElementById('selected-day-events-container');
        eventsContainer.classList.remove('hidden');

        // Remove highlight from previously selected date
        if (selectedDateElement) {
            selectedDateElement.style.backgroundColor = '';
        }
        // Add highlight to current date. Direct style is more reliable than a class.
        info.dayEl.style.backgroundColor = '#dbeafe'; // Tailwind's blue-100
        selectedDateElement = info.dayEl;

        const allEvents = calendar.getEvents();
        const clickedDate = info.date;

        // Set the end of the clicked day for filtering
        const endOfDay = new Date(clickedDate);
        endOfDay.setDate(endOfDay.getDate() + 1);

        const dayEvents = allEvents.filter(event => {
            // An event is on this day if its range overlaps with the day's range.
            const eventStart = event.start;
            // If an event has no end, its range is just that single point in time.
            const eventEnd = event.end || event.start;
            return eventStart < endOfDay && eventEnd > clickedDate;
        });

        renderSelectedDayEvents(dayEvents, clickedDate);
    }

    function renderSelectedDayEvents(events, date) {
        const header = document.getElementById('selected-day-header');
        const list = document.getElementById('selected-day-events-list');
        const addEventBtn = document.getElementById('add-event-for-selected-day-btn');

        header.textContent = `Events for ${date.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
        addEventBtn.onclick = () => openCreateEventModal(date.toISOString().split('T')[0]);

        if (events.length === 0) {
            list.innerHTML = `<p class="text-gray-500 text-sm p-4 text-center">No events scheduled for this day.</p>`;
            return;
        }

        list.innerHTML = '';
        events.sort((a, b) => a.start - b.start).forEach(event => {
            const eventEl = document.createElement('div');
            eventEl.className = 'p-3 rounded-md hover:bg-gray-100 cursor-pointer border-l-4';
            eventEl.style.borderColor = event.backgroundColor;

            const timeFormat = { hour: 'numeric', minute: '2-digit', hour12: true };
            const timeText = event.allDay ? 'All-day' : event.start.toLocaleTimeString([], timeFormat);

            const titleEl = document.createElement('p');
            titleEl.className = 'font-semibold text-gray-800';
            titleEl.textContent = event.title;

            const timeEl = document.createElement('p');
            timeEl.className = 'text-xs font-medium text-gray-500';
            timeEl.textContent = timeText;

            eventEl.appendChild(titleEl);
            eventEl.appendChild(timeEl);

            const props = event.extendedProps;
            if (props.source_row_data) {
                const detailsContainer = document.createElement('div');
                detailsContainer.className = 'mt-2 pt-2 border-t border-gray-200 space-y-1 font-mono text-xs';
                for (const [key, value] of Object.entries(props.source_row_data)) {
                    if (value !== null && value !== undefined && value !== '') {
                        const detailItem = document.createElement('div');
                        const keySpan = document.createElement('span');
                        keySpan.className = 'text-gray-500';
                        keySpan.textContent = `${key}: `;
                        const valueSpan = document.createElement('span');
                        valueSpan.className = 'text-black font-semibold';
                        valueSpan.textContent = value;
                        detailItem.appendChild(keySpan);
                        detailItem.appendChild(valueSpan);
                        detailsContainer.appendChild(detailItem);
                    }
                }
                eventEl.appendChild(detailsContainer);
            } else if (props.description) {
                const descEl = document.createElement('p');
                descEl.className = 'text-sm text-gray-600 mt-1';
                descEl.textContent = props.description;
                eventEl.appendChild(descEl);
            }

            eventEl.addEventListener('click', () => {
                const fullEvent = calendar.getEventById(event.id);
                if (fullEvent) openEventDetailsModal(fullEvent);
            });
            list.appendChild(eventEl);
        });
    }

    function formatDateTimeForInput(date) {
        if (!date) return '';
        // The datetime-local input expects a format like 'YYYY-MM-DDTHH:mm'.
        // We need to convert the UTC string from the DB to the user's local time.
        const d = new Date(date);
        return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
    }

    function openEventDetailsModal(event) {
        const props = event.extendedProps;
        document.getElementById('edit-event-id').value = props.id;
        document.getElementById('edit-event-title').value = props.title;
        document.getElementById('edit-event-start-time').value = formatDateTimeForInput(props.start_time);
        document.getElementById('edit-event-end-time').value = formatDateTimeForInput(props.end_time);
        document.getElementById('edit-event-description').value = props.description || '';
        document.getElementById('edit-event-completed').checked = props.is_completed;

        const sourceDataContainer = document.getElementById('event-source-data-container');
        const sourceDataDetails = document.getElementById('event-source-data-details');

        if (props.source_row_data) {
            sourceDataContainer.classList.remove('hidden');
            document.getElementById('event-source-table-name').textContent = props.source_table_name;
            
            const sourceTable = state.tables.find(t => t.id === props.source_table_id);
            let detailsHtml = '';

            if (sourceTable) {
                sourceTable.columns.forEach(col => {
                    const value = props.source_row_data[col.name];
                    if (value === undefined || value === null) return;

                    let displayValue = value;
                    // If it's a foreign key, try to resolve it for a user-friendly display
                    if (col.foreign_key) {
                        const fkCache = state.fkDataCache[col.foreign_key.table_id];
                        if (fkCache && fkCache.rows) {
                            const fkRow = fkCache.rows.find(r => (r.data[fkCache.pkColumn] ?? r.id) == value);
                            if (fkRow && fkRow.data[fkCache.displayColumn]) {
                                displayValue = `${fkRow.data[fkCache.displayColumn] || value} <span class="text-gray-400">(FK to ${col.foreign_key.table_id})</span>`;
                            }
                        }
                    }
                    detailsHtml += `<div><span class="text-gray-500">${col.name}:</span> <span class="text-black font-semibold">${displayValue}</span></div>`;
                });
            }
            sourceDataDetails.innerHTML = detailsHtml;
        } else {
            sourceDataContainer.classList.add('hidden');
        }
        openModal(eventDetailsModal);
    }

    document.getElementById('close-event-details-btn').addEventListener('click', () => closeModal(eventDetailsModal));
    document.getElementById('cancel-edit-event-btn').addEventListener('click', () => closeModal(eventDetailsModal));

    document.getElementById('event-details-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const eventId = document.getElementById('edit-event-id').value;
        const payload = {
            title: document.getElementById('edit-event-title').value,
            start_time: document.getElementById('edit-event-start-time').value,
            end_time: document.getElementById('edit-event-end-time').value || null,
            description: document.getElementById('edit-event-description').value,
            is_completed: document.getElementById('edit-event-completed').checked
        };

        try {
            const response = await fetchWithAuth(`/api/v1/calendar/events/${eventId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to update event.');
            }
            closeModal(eventDetailsModal);
            calendar.refetchEvents();
        } catch (error) {
            showError(error.message);
        }
    });

    document.getElementById('delete-event-btn').addEventListener('click', async () => {
        const eventId = document.getElementById('edit-event-id').value;
        if (confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
            try {
                const response = await fetchWithAuth(`/api/v1/calendar/events/${eventId}`, { method: 'DELETE' });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to delete event.');
                }
                closeModal(eventDetailsModal);
                calendar.refetchEvents();
            } catch (error) {
                showError(error.message);
            }
        }
    });


    createWebhookBtn.addEventListener('click', async () => {
        if (!state.selectedTable) return;
        createWebhookBtn.disabled = true;
        createWebhookBtn.textContent = 'Creating...';
        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/webhooks`, { method: 'POST' });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to create webhook');
            }
            await fetchAndRenderWebhooks(state.selectedTable.id);
        } catch (error) {
            showError(error.message);
        } finally {
            createWebhookBtn.disabled = false;
            createWebhookBtn.textContent = 'Create New Webhook';
        }
    });

    webhooksListContainer.addEventListener('click', async (e) => {
        const copyBtn = e.target.closest('.copy-webhook-url-btn');
        if (copyBtn) {
            navigator.clipboard.writeText(copyBtn.dataset.url).then(() => {
                // Maybe add a "Copied!" tooltip later
            });
        }

        const deleteBtn = e.target.closest('.delete-webhook-btn');
        if (deleteBtn && confirm('Are you sure you want to delete this webhook?')) {
            const webhookId = deleteBtn.dataset.webhookId;
            const response = await fetchWithAuth(`/api/v1/webhooks/${webhookId}`, { method: 'DELETE' });
            if (response.ok) {
                deleteBtn.closest('[data-webhook-id]').remove();
            } else {
                showError('Failed to delete webhook.');
            }
        }

        const refreshBtn = e.target.closest('.refresh-webhook-btn');
        if (refreshBtn) {
            await fetchAndRenderWebhooks(state.selectedTable.id);
        }

        const toggleBtn = e.target.closest('.toggle-webhook-status-btn');
        if (toggleBtn) {
            const webhookId = toggleBtn.dataset.webhookId;
            const newStatus = toggleBtn.dataset.status;
            const response = await fetchWithAuth(`/api/v1/webhooks/${webhookId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            if (response.ok) {
                await fetchAndRenderWebhooks(state.selectedTable.id);
            } else {
                showError(`Failed to change status to ${newStatus}.`);
            }
        }

        const testBtn = e.target.closest('.send-test-webhook-btn');
        if (testBtn) {
            const webhookUrl = testBtn.dataset.webhookUrl;
            testBtn.disabled = true;
            testBtn.textContent = 'Sending...';

            const samplePayload = {
                name: "Jane Doe",
                email: "test@example.com",
                company: "Acme Inc.",
                message: "This is a test submission to help map fields."
            };

            try {
                // This is a public endpoint, so no auth is needed.
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(samplePayload)
                });

                if (!response.ok) throw new Error('Failed to send test data.');
                
                // Success! Refresh the UI to show the mapping view.
                setTimeout(() => fetchAndRenderWebhooks(state.selectedTable.id), 500);
            } catch (error) {
                showError(error.message);
                testBtn.disabled = false;
                testBtn.textContent = 'Send Test Data';
            }
        }
    });

    webhooksListContainer.addEventListener('submit', async (e) => {
        if (e.target.classList.contains('webhook-mapping-form')) {
            e.preventDefault();
            const form = e.target;
            const webhookId = form.closest('[data-webhook-id]').dataset.webhookId;
            
            const fieldMapping = {};
            form.querySelectorAll('select[data-table-col]').forEach(select => {
                if (select.value) {
                    fieldMapping[select.dataset.tableCol] = select.value;
                }
            });

            const payload = {
                field_mapping: fieldMapping,
                status: 'active'
            };

            const response = await fetchWithAuth(`/api/v1/webhooks/${webhookId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (response.ok) await fetchAndRenderWebhooks(state.selectedTable.id);
        }
    });

    // Check for saved sidebar state on load
    if (localStorage.getItem('sidebarCollapsed') === 'true') {
        toggleSidebar();
    }
    checkAndCollapseSidebar(); // Collapse on mobile on initial load
    // Initial Load
    initializeCalendar();
    supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION' || event === 'TOKEN_REFRESHED') {
            if (session) {
                localStorage.setItem('supabase_token', session.access_token);
                // Only fetch initial data on sign in, not on every token refresh
                if (event !== 'TOKEN_REFRESHED') {
                    fetchDbIdAndTables();
                }
            } else {
                window.location.href = '/login';
            }
        } else if (event === 'SIGNED_OUT') {
            window.location.href = '/login';
        }
    });
});
</script>

</body>
</html>