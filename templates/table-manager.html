<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Manager - FormPipeDB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-gray-50">

<div class="flex h-screen">
    <!-- Left Sidebar -->
    <aside class="w-72 bg-white border-r flex flex-col">
        <div class="p-4 border-b">
            <a href="/app" class="text-sm text-blue-600 hover:underline">&larr; Back to Dashboard</a>
            <h1 class="text-2xl font-bold text-gray-800 mt-2">{{ db_name }}</h1>
        </div>
        <div class="p-4 border-b">
            <h2 class="text-lg font-semibold text-gray-700">Tables</h2>
        </div>
        <nav id="table-list" class="flex-1 p-4 space-y-1 overflow-y-auto">
            <div class="flex items-center gap-2 text-sm text-gray-500 p-2">
                <svg class="animate-spin h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span>Loading tables...</span>
            </div>
        </nav>
        <div class="p-4 border-t space-y-2">
            <button id="create-table-btn" class="w-full text-center p-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 font-semibold">Create Table</button>
            <button id="delete-table-btn" class="w-full text-center p-2 rounded-md bg-red-100 text-red-700 hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Delete Table</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 p-8 overflow-auto hidden">
        <div class="border-b mb-6">
            <nav class="flex space-x-6">
                <button data-tab="data" class="tab-btn py-2 px-1 font-medium border-b-2 border-blue-500 text-blue-600">Data</button>
                <button data-tab="structure" class="tab-btn py-2 px-1 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Structure</button>
                <button data-tab="sql" class="tab-btn py-2 px-1 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">SQL Runner</button>
            </nav>
        </div>

        <!-- Structure Tab Content -->
        <div id="structure-tab-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-3 text-left font-semibold">Column Name</th>
                            <th class="p-3 text-left font-semibold">Data Type</th>
                            <th class="p-3 text-center font-semibold">Not Null</th>
                            <th class="p-3 text-center font-semibold">Primary Key</th>
                            <th class="p-3 text-center font-semibold">Unique</th>
                            <th class="p-3 text-left font-semibold">Foreign Key</th>
                            <th class="p-3 text-center font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="structure-tbody" class="divide-y">
                        <!-- Structure rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Data Tab Content -->
        <div id="data-tab-content" class="tab-content">
            <div class="flex justify-between items-center mb-4 gap-2">
                <div class="w-1/3">
                    <input type="search" id="row-search-input" placeholder="Search rows..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex gap-2">
                    <button id="add-row-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Add Row</button>
                    <button id="export-csv-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 ml-2">Export to CSV</button>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border overflow-auto max-h-[70vh]">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                        <!-- Data header will be injected here -->
                    </thead>
                    <tbody id="data-tbody" class="divide-y">
                        <!-- Data rows will be injected here -->
                    </tbody>
                </table>
            </div>
            <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm text-gray-600">
                <!-- Pagination controls will be injected here -->
            </div>
        </div>

        <!-- SQL Runner Tab Content -->
        <div id="sql-tab-content" class="tab-content hidden">
            <div class="space-y-6">
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="p-4 border-b">
                        <h3 class="text-lg font-semibold">SQL Runner</h3>
                        <p class="text-sm text-gray-500 mt-1">Execute custom SQL queries against your database.</p>
                    </div>
                    <div class="p-4">
                        <div class="bg-gray-900 text-white p-4 rounded-md font-mono text-sm ring-1 ring-gray-200">
                            <textarea id="sql-query-input" class="w-full h-40 bg-transparent text-white outline-none resize-none" placeholder="-- Example: SELECT * FROM users WHERE id > 10;"></textarea>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="run-query-btn" class="bg-blue-600 text-white px-5 py-2 rounded-md hover:bg-blue-700 font-semibold">Run Query</button>
                        </div>
                    </div>
                </div>
                <div id="query-results-container" class="bg-white rounded-lg shadow-sm border min-h-[10rem]">
                    <!-- Query results or errors will be displayed here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Placeholder for initial view -->
    <div id="placeholder-content" class="flex-1 flex items-center justify-center text-gray-500">
        Select a table to view its structure and data.
    </div>
</div>

<!-- Create Table Modal -->
<div id="create-table-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <form id="create-table-form" class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
        <div class="p-6 border-b">
            <h3 class="text-xl font-semibold">Create New Table</h3>
        </div>
        <div class="p-6 space-y-4 overflow-y-auto">
            <input id="new-table-name" type="text" placeholder="Table Name" required class="w-full p-2 border rounded-md">
            <div id="new-columns-list" class="space-y-2"></div>
            <button id="add-column-to-modal-btn" type="button" class="text-sm text-blue-600 hover:underline">+ Add Column</button>
        </div>
        <div class="p-6 mt-auto border-t bg-gray-50 flex justify-end gap-4">
            <button id="cancel-create-table-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Create Table</button>
        </div>
    </form>
</div>

<!-- Edit Column Modal -->
<div id="edit-column-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <form id="edit-column-form" class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
        <h3 class="text-lg font-semibold mb-6">Edit Column</h3>
        <input type="hidden" id="edit-column-index">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Column Name</label>
                <input type="text" id="edit-column-name" required class="mt-1 block w-full p-2 border rounded-md shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Data Type</label>
                <select id="edit-column-type" class="mt-1 block w-full p-2 border rounded-md shadow-sm bg-white">
                    <option value="text">TEXT</option>
                    <option value="integer">INTEGER</option>
                    <option value="real">REAL</option>
                    <option value="boolean">BOOLEAN</option>
                    <option value="timestamp">TIMESTAMP</option>
                    <option value="jsonb">JSONB</option>
                </select>
            </div>
            <fieldset class="space-y-2 pt-2">
                <legend class="text-sm font-medium text-gray-700">Constraints</legend>
                <div class="grid grid-cols-2 gap-4">
                    <label class="flex items-center"><input id="edit-is-not-null" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2"> Not Null</label>
                    <label class="flex items-center"><input id="edit-is-unique" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2"> Unique</label>
                </div>
            </fieldset>
        </div>
        <div class="mt-8 flex justify-end gap-4">
            <button id="cancel-edit-column-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save Changes</button>
        </div>
    </form>
</div>

<!-- Delete Table Confirmation Modal -->
<div id="delete-table-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
        <h3 class="text-lg font-semibold mb-4">Confirm Table Deletion</h3>
        <p>Are you sure you want to delete the table "<strong id="modal-table-name"></strong>"? This will permanently delete all of its data. This action cannot be undone.</p>
        <div class="mt-6 flex justify-end gap-4">
            <button id="cancel-delete-table-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button id="confirm-delete-table-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Delete</button>
        </div>
    </div>
</div>

<script>
const supabaseUrl = '{{ supabase_url }}';
const supabaseAnonKey = '{{ supabase_anon_key }}';
const supabase = supabaseUrl && supabaseAnonKey ? window.supabase.createClient(supabaseUrl, supabaseAnonKey) : null;

document.addEventListener('DOMContentLoaded', () => {
    if (!supabase) {
        document.body.innerHTML = '<div class="text-center p-8 text-red-600">Supabase client not configured. Please check your environment variables.</div>';
        return;
    }

    // State
    let state = {
        dbId: null,
        dbName: '{{ db_name }}',
        tables: [],
        selectedTable: null,
        pagination: {
            currentPage: 1,
            limit: 50, // This should match the default limit in the API
            totalRows: 0
        }
    };

    // DOM Elements
    const tableList = document.getElementById('table-list');
    const mainContent = document.getElementById('main-content');
    const placeholderContent = document.getElementById('placeholder-content');
    const deleteTableBtn = document.getElementById('delete-table-btn');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const createTableBtn = document.getElementById('create-table-btn');
    const createTableModal = document.getElementById('create-table-modal');
    const createTableForm = document.getElementById('create-table-form');
    const cancelCreateTableBtn = document.getElementById('cancel-create-table-btn');
    const addColumnToModalBtn = document.getElementById('add-column-to-modal-btn');
    const deleteTableModal = document.getElementById('delete-table-modal');
    const modalTableName = document.getElementById('modal-table-name');
    const cancelDeleteTableBtn = document.getElementById('cancel-delete-table-btn');
    const confirmDeleteTableBtn = document.getElementById('confirm-delete-table-btn');
    const editColumnModal = document.getElementById('edit-column-modal');
    const editColumnForm = document.getElementById('edit-column-form');
    const cancelEditColumnBtn = document.getElementById('cancel-edit-column-btn');
    const structureTbody = document.getElementById('structure-tbody');
    const addRowBtn = document.getElementById('add-row-btn');
    const dataTbody = document.getElementById('data-tbody');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const searchInput = document.getElementById('row-search-input');
    const runQueryBtn = document.getElementById('run-query-btn');
    const sqlQueryInput = document.getElementById('sql-query-input');
    const queryResultsContainer = document.getElementById('query-results-container');


    /**
     * A wrapper for the native fetch function that automatically includes
     * the Supabase authentication token.
     * @param {string} url - The URL to fetch.
     * @param {object} options - The options for the fetch call (e.g., method, body).
     * @returns {Promise<Response>} The fetch Response object.
     */
    async function fetchWithAuth(url, options = {}) {
        const token = await getAuthToken();
        if (!token) return; // getAuthToken handles redirection

        const headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
        return fetch(url, { ...options, headers });
    }

    async function getAuthToken() {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error || !session) {
            console.error("Authentication error, redirecting to login.", error);
            window.location.href = '/login';
            return null;
        }
        return session.access_token;
    }

    function debounce(func, timeout = 300){
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    }

    async function fetchDbIdAndTables() {
        try {
            // 1. Fetch all databases to find the ID for the current dbName
            const dbsResponse = await fetchWithAuth('/api/v1/databases');
            if (!dbsResponse.ok) throw new Error('Could not fetch databases to find ID.');
            const databases = await dbsResponse.json();
            const currentDb = databases.find(db => db.name === state.dbName);
            
            if (!currentDb) throw new Error(`Database '${state.dbName}' not found.`);
            state.dbId = currentDb.id;

            // 2. Fetch tables for the found database ID
            const tablesResponse = await fetchWithAuth(`/api/v1/databases/${state.dbId}/tables`);
            if (!tablesResponse.ok) throw new Error('Could not fetch tables.');
            state.tables = await tablesResponse.json();
            renderTables(state.tables);

        } catch (error) {
            console.error(error);
            placeholderContent.textContent = `Error: ${error.message}`;
        }
    }

    function renderTables(tables) {
        tableList.innerHTML = '';
        if (tables.length === 0) {
            tableList.innerHTML = `<p class="text-sm text-gray-500 p-2">No tables yet.</p>`;
            return;
        }
        tables.forEach(table => {
            const tableLink = document.createElement('a');
            tableLink.href = '#';
            tableLink.className = 'block p-2 rounded-md hover:bg-gray-100';
            tableLink.textContent = table.name;
            tableLink.dataset.tableId = table.id;
            tableList.appendChild(tableLink);
        });
    }

    function handleTableSelect(e) {
        if (e.target.tagName === 'A') {
            e.preventDefault();
            const tableId = e.target.dataset.tableId;
            state.selectedTable = state.tables.find(t => t.id == tableId);
            if (!state.selectedTable) return;

            tableList.querySelectorAll('a').forEach(a => a.classList.remove('bg-blue-100', 'text-blue-700', 'font-semibold'));
            e.target.classList.add('bg-blue-100', 'text-blue-700', 'font-semibold');
            
            mainContent.classList.remove('hidden');
            placeholderContent.classList.add('hidden');
            deleteTableBtn.disabled = false;

            // Reset to page 1 whenever a new table is selected
            renderStructure(state.selectedTable.columns);
            fetchAndRenderData(state.selectedTable.id, 1);
        }
    }

    function renderStructure(columns) {
        const tbody = document.getElementById('structure-tbody');
        tbody.innerHTML = ''; // Clear existing
        if (!columns || columns.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">This table has no columns defined.</td></tr>`;
            return;
        }

        columns.forEach((col, index) => {
            const tr = document.createElement('tr');
            const checkmark = `<span class="text-green-600 font-bold">&#10003;</span>`;
            tr.innerHTML = `
                <td class="p-3 font-mono">${col.name}</td>
                <td class="p-3 font-mono text-purple-600 uppercase">${col.type}</td>
                <td class="p-3 text-center">${col.is_not_null ? checkmark : ''}</td>
                <td class="p-3 text-center">${col.is_primary_key ? checkmark : ''}</td>
                <td class="p-3 text-center">${col.is_unique ? checkmark : ''}</td>
                <td class="p-3 font-mono text-xs">${col.foreign_key ? `-> ${col.foreign_key.table_id}.${col.foreign_key.column_name}` : ''}</td>
                <td class="p-3 text-center">
                    <div class="flex items-center justify-center gap-2">
                    ${!col.is_primary_key ? `
                        <button data-column-index="${index}" class="edit-column-btn text-gray-500 hover:text-blue-600" title="Edit Column"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg></button>
                        <button data-column-index="${index}" class="delete-column-btn text-gray-500 hover:text-red-600" title="Delete Column"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    ` : ''}
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function fetchAndRenderData(tableId, page = 1, searchTerm = '') {
        state.pagination.currentPage = page;
        const offset = (page - 1) * state.pagination.limit;

        const dataTable = document.querySelector('#data-tab-content table');
        const thead = dataTable.querySelector('thead');
        const tbody = document.getElementById('data-tbody');
        const columns = state.selectedTable.columns;
        const colspan = columns.length + 1;

        thead.innerHTML = ''; // Clear old header while loading
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="p-8 text-center text-gray-500"><div class="flex justify-center items-center gap-2"><svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Loading data...</span></div></td></tr>`;
        renderPagination(); // Render empty pagination while loading

        const searchParam = searchTerm ? `&search=${encodeURIComponent(searchTerm)}` : '';

        try {
            const response = await fetchWithAuth(`/api/v1/tables/${tableId}/rows?limit=${state.pagination.limit}&offset=${offset}${searchParam}`);
            if (!response.ok) throw new Error('Failed to fetch rows');
            const result = await response.json();
            const rows = result.data;
            state.pagination.totalRows = result.total;

            const headerRow = document.createElement('tr');
            // Add an empty header for the actions column
            headerRow.innerHTML += `<th class="p-3 w-12"></th>`;
            columns.forEach(col => {
                headerRow.innerHTML += `<th class="p-3 text-left font-semibold">${col.name}</th>`;
            });
            thead.innerHTML = '';
            thead.appendChild(headerRow);

            tbody.innerHTML = ''; // Clear loading indicator
            if (rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${columns.length + 1}" class="p-8 text-center text-gray-500">No data in this table.</td></tr>`;
                renderPagination();
                return;
            }

            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.dataset.rowId = row.id;
                // Add delete button cell
                tr.innerHTML += `
                    <td class="p-3 text-center">
                        <button data-row-id="${row.id}" class="delete-row-btn text-gray-400 hover:text-red-600" title="Delete Row">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                columns.forEach(col => {
                    // The primary key's value comes from row.id, not the data blob.
                    // Other data comes from the row.data JSONB object.
                    const isPk = col.is_primary_key;
                    const cellValue = isPk ? row.id : (row.data ? (row.data[col.name] ?? '') : '');
                    const contentEditable = !isPk ? 'contenteditable="true"' : '';

                    tr.innerHTML += `
                        <td class="p-3 font-mono text-sm editable-cell" data-column-name="${col.name}" ${contentEditable}>${cellValue}</td>
                    `;
                });
                tbody.appendChild(tr);
            });
            renderPagination();
        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="99" class="p-4 text-center text-red-500">Error loading data.</td></tr>`;
        }
    }

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tab = button.dataset.tab;

            tabButtons.forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            button.classList.add('border-blue-500', 'text-blue-600');
            button.classList.remove('border-transparent', 'text-gray-500');

            tabContents.forEach(content => {
                if (content.id === `${tab}-tab-content`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        });
    });


    // Modal Logic

    function openModal(modal) {
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
    }

    function closeModal(modal) {
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 250);
    }

    function createColumnRow(isPk = false) {
        const id = `col-${Date.now()}`;
        const tableOptions = state.tables.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

        const div = document.createElement('div');
        div.className = 'column-row grid grid-cols-12 gap-2 items-center border-t pt-2';
        div.innerHTML = `
            <div class="col-span-12 grid grid-cols-12 gap-2 items-center">
                <input type="text" data-key="name" placeholder="column_name" required class="col-span-4 p-2 border rounded-md" ${isPk ? 'value="id" readonly' : ''}>
                <select data-key="type" class="col-span-3 p-2 border rounded-md bg-white" ${isPk ? 'disabled' : ''}>
                    ${isPk ? '<option value="serial" selected>SERIAL (PK)</option>' : `
                    <option value="text" selected>TEXT</option>
                    <option value="integer">INTEGER</option>
                    <option value="real">REAL</option>
                    <option value="boolean">BOOLEAN</option>
                    <option value="timestamp">TIMESTAMP</option>
                    <option value="jsonb">JSONB</option>
                    `}
                </select>
                <div class="col-span-4 flex items-center justify-around text-xs">
                    <label class="flex flex-col items-center"><input data-key="is_not_null" type="checkbox" class="h-4 w-4 rounded" ${isPk ? 'checked disabled' : ''}><span>Not Null</span></label>
                    <label class="flex flex-col items-center"><input data-key="is_unique" type="checkbox" class="h-4 w-4 rounded" ${isPk ? 'checked disabled' : ''}><span>Unique</span></label>
                </div>
            </div>
            <div class="col-span-12 mt-2 pl-1">
                <label class="flex items-center text-xs cursor-pointer"><input type="checkbox" data-key="is_foreign_key" class="fk-checkbox h-4 w-4 rounded mr-2" ${isPk ? 'disabled' : ''}><span>Is Foreign Key</span></label>
                <div class="fk-options-container hidden grid grid-cols-2 gap-2 mt-2 pl-6">
                    <select data-key="fk_table_id" class="fk-table-select p-1 border rounded-md bg-white text-xs">
                        <option value="">-- Select Table --</option>
                        ${tableOptions}
                    </select>
                    <select data-key="fk_column_name" class="fk-column-select p-1 border rounded-md bg-white text-xs" disabled><option value="">-- Select Column --</option></select>
                </div>
            </div>
            <div class="col-span-1 flex justify-end">
                ${!isPk ? '<button type="button" class="remove-column-btn text-red-500 hover:text-red-700">&times;</button>' : ''}
            </div>
            <input type="hidden" data-key="is_primary_key" value="${isPk}">
        `;
        return div;
    }

    function resetCreateTableModal() {
        document.getElementById('new-table-name').value = '';
        const columnsList = document.getElementById('new-columns-list');
        columnsList.innerHTML = '';
        columnsList.appendChild(createColumnRow(true)); // Add default PK
    }

    async function handleCreateTableSubmit(e) {
        e.preventDefault();
        const tableName = document.getElementById('new-table-name').value.trim();
        const columnRows = document.querySelectorAll('#new-columns-list .column-row');
        
        const columns = Array.from(columnRows).map(row => {
            const isFk = row.querySelector('[data-key="is_foreign_key"]').checked;
            let foreignKey = null;
            if (isFk) {
                const tableId = row.querySelector('[data-key="fk_table_id"]').value;
                const columnName = row.querySelector('[data-key="fk_column_name"]').value;
                if (tableId && columnName) {
                    foreignKey = {
                        table_id: parseInt(tableId, 10),
                        column_name: columnName
                    };
                }
            }
            return {
                name: row.querySelector('[data-key="name"]').value,
                type: row.querySelector('[data-key="type"]').value,
                is_primary_key: row.querySelector('[data-key="is_primary_key"]').value === 'true',
                is_not_null: row.querySelector('[data-key="is_not_null"]').checked,
                is_unique: row.querySelector('[data-key="is_unique"]').checked,
                foreign_key: foreignKey
            };
        });

        const payload = { name: tableName, columns };

        try {
            const response = await fetchWithAuth(`/api/v1/databases/${state.dbId}/tables`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to create table');
            }
            closeModal(createTableModal);
            const newTable = await response.json();
            await fetchDbIdAndTables(); // Refresh table list
            
            // Auto-select the newly created table
            const newTableLink = tableList.querySelector(`a[data-table-id="${newTable.id}"]`);
            if (newTableLink) {
                newTableLink.click();
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    async function handleDeleteTable() {
        if (!state.selectedTable) return;
        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}`, { method: 'DELETE' });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to delete table');
            }
            // Success
            closeModal(deleteTableModal);
            mainContent.classList.add('hidden');
            placeholderContent.classList.remove('hidden');
            deleteTableBtn.disabled = true;
            state.selectedTable = null;
            await fetchDbIdAndTables(); // Refresh list
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    async function handleAddRow() {
        if (!state.selectedTable) return;
        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/rows`, { method: 'POST' });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to add row');
            }
            await fetchAndRenderData(state.selectedTable.id);
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    async function handleDeleteRow(rowId) {
        if (confirm('Are you sure you want to delete this row?')) {
            try {
                const response = await fetchWithAuth(`/api/v1/rows/${rowId}`, { method: 'DELETE' });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to delete row');
                }
                // On success, just remove the row from the UI for a faster feel
                document.querySelector(`button.delete-row-btn[data-row-id="${rowId}"]`).closest('tr').remove();
                state.pagination.totalRows -= 1;
                renderPagination();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
    }

    async function handleExportCsv() {
        if (!state.selectedTable) return;
        exportCsvBtn.textContent = 'Exporting...';
        exportCsvBtn.disabled = true;

        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}/all-rows`);
            if (!response.ok) throw new Error('Could not fetch data for export.');

            const rows = await response.json();
            if (rows.length === 0) {
                alert('Table is empty, nothing to export.');
                return;
            }

            const columns = state.selectedTable.columns.map(c => c.name);
            const csvRows = [columns.join(',')]; // Header row

            rows.forEach(row => {
                const values = columns.map(colName => {
                    const value = colName === 'id' ? row.id : (row.data ? (row.data[colName] ?? '') : '');
                    // Basic CSV escaping: wrap in quotes if it contains a comma or quote
                    const strValue = String(value);
                    if (strValue.includes(',') || strValue.includes('"')) {
                        return `"${strValue.replace(/"/g, '""')}"`;
                    }
                    return strValue;
                });
                csvRows.push(values.join(','));
            });

            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.selectedTable.name}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        } catch (error) {
            alert(`Error exporting CSV: ${error.message}`);
        } finally {
            exportCsvBtn.textContent = 'Export to CSV';
            exportCsvBtn.disabled = false;
        }
    }

    async function handleUpdateRow(cellElement) {
        const tr = cellElement.closest('tr');
        const rowId = tr.dataset.rowId;
        if (!rowId) return;

        const rowData = {};
        // IMPORTANT: Only gather data from cells that are actually editable.
        // This correctly excludes the primary key from the data payload.
        tr.querySelectorAll('td.editable-cell[contenteditable="true"]').forEach(cell => {
            const colName = cell.dataset.columnName;
            rowData[colName] = cell.innerText;
        });

        const payload = { data: rowData };

        try {
            const response = await fetchWithAuth(`/api/v1/rows/${rowId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to update row');
            }
            // Visual feedback for success
            cellElement.style.transition = 'background-color 0.5s';
            cellElement.style.backgroundColor = '#dcfce7'; // Tailwind green-100
            setTimeout(() => {
                cellElement.style.backgroundColor = '';
            }, 1500);
        } catch (error) {
            alert(`Error saving data: ${error.message}`);
            fetchAndRenderData(state.selectedTable.id); // Revert UI on failure
        }
    }

    function renderPagination() {
        const { currentPage, limit, totalRows } = state.pagination;
        const paginationControls = document.getElementById('pagination-controls');
        paginationControls.innerHTML = '';

        if (totalRows === 0) {
            // Don't show pagination if there are no results
            return;
        }

        if (totalRows <= limit && currentPage === 1) return; // Also hide if only one page

        const totalPages = Math.ceil(totalRows / limit);
        const startRow = totalRows > 0 ? (currentPage - 1) * limit + 1 : 0;
        const endRow = Math.min(currentPage * limit, totalRows);

        const info = document.createElement('div');
        info.textContent = `Showing ${startRow} to ${endRow} of ${totalRows} rows`;
        
        const buttons = document.createElement('div');
        buttons.className = 'flex gap-2';
        buttons.innerHTML = `
            <button data-page="${currentPage - 1}" class="prev-page-btn px-3 py-1 border rounded-md bg-white hover:bg-gray-100" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
            <span class="px-3 py-1">Page ${currentPage} of ${totalPages}</span>
            <button data-page="${currentPage + 1}" class="next-page-btn px-3 py-1 border rounded-md bg-white hover:bg-gray-100" ${currentPage >= totalPages ? 'disabled' : ''}>Next</button>
        `;

        paginationControls.appendChild(info);
        paginationControls.appendChild(buttons);
    }

    async function saveTableStructure() {
        if (!state.selectedTable) return false;

        const payload = {
            name: state.selectedTable.name,
            columns: state.selectedTable.columns
        };

        try {
            const response = await fetchWithAuth(`/api/v1/tables/${state.selectedTable.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Failed to update table structure');
            }

            const updatedTable = await response.json();
            const tableIndex = state.tables.findIndex(t => t.id === updatedTable.id);
            if (tableIndex > -1) state.tables[tableIndex] = updatedTable;
            state.selectedTable = updatedTable;
            await fetchAndRenderData(state.selectedTable.id, 1, searchInput.value.trim());
            renderStructure(state.selectedTable.columns);
            return true; // Success
        } catch (error) {
            alert(`Error: ${error.message}`);
            await fetchDbIdAndTables(); // Re-fetch to revert optimistic changes
            return false; // Failure
        }
    }

    function populateAndOpenEditModal(column, index) {
        document.getElementById('edit-column-index').value = index;
        document.getElementById('edit-column-name').value = column.name;
        document.getElementById('edit-column-type').value = column.type;
        document.getElementById('edit-is-not-null').checked = column.is_not_null;
        document.getElementById('edit-is-unique').checked = column.is_unique;
        openModal(editColumnModal);
    }

    async function handleEditColumnSubmit(e) {
        e.preventDefault();
        const index = parseInt(document.getElementById('edit-column-index').value, 10);
        state.selectedTable.columns[index].name = document.getElementById('edit-column-name').value;
        state.selectedTable.columns[index].type = document.getElementById('edit-column-type').value;
        state.selectedTable.columns[index].is_not_null = document.getElementById('edit-is-not-null').checked;
        state.selectedTable.columns[index].is_unique = document.getElementById('edit-is-unique').checked;
        
        if (await saveTableStructure()) {
            closeModal(editColumnModal);
        }
    }

    function renderQueryResults(result) {
        queryResultsContainer.innerHTML = '';
        if (result.error) {
            queryResultsContainer.innerHTML = `
                <div class="p-4 border-b bg-red-50 text-red-700 font-semibold">Error</div>
                <div class="p-4 font-mono text-sm text-red-600 whitespace-pre-wrap">${result.error}</div>
            `;
            return;
        }

        const data = result.data;
        if (!data || data.length === 0) {
            queryResultsContainer.innerHTML = `
                <div class="p-4 border-b font-semibold">Success</div>
                <div class="p-4 text-gray-500">Query executed successfully, but returned no rows.</div>
            `;
            return;
        }

        const headers = Object.keys(data[0]);
        const table = document.createElement('table');
        table.className = 'min-w-full text-sm';
        table.innerHTML = `
            <thead class="bg-gray-50">
                <tr>${headers.map(h => `<th class="p-3 text-left font-semibold">${h}</th>`).join('')}</tr>
            </thead>
            <tbody class="divide-y">
                ${data.map(row => `<tr>${headers.map(h => `<td class="p-3 font-mono">${row[h]}</td>`).join('')}</tr>`).join('')}
            </tbody>
        `;
        queryResultsContainer.appendChild(table);
    }

    async function handleRunQuery() {
        const query = sqlQueryInput.value.trim();
        if (!query) return;

        runQueryBtn.disabled = true;
        runQueryBtn.textContent = 'Running...';
        queryResultsContainer.innerHTML = `<div class="p-4 text-gray-500 flex items-center gap-2"><svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Executing query...</div>`;

        // --- MOCK IMPLEMENTATION ---
        // This section simulates an API call. Replace this with the real fetchWithAuth call
        // once the backend endpoint is ready.
        await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate network delay
        if (query.toLowerCase().includes('error')) {
            renderQueryResults({ error: 'SYNTAX ERROR at or near "error"\nLINE 1: ...' });
        } else if (query.toLowerCase().startsWith('select')) {
            renderQueryResults({ data: [
                { id: 1, name: 'John Doe', email: 'john.doe@example.com' },
                { id: 2, name: 'Jane Smith', email: 'jane.smith@example.com' }
            ]});
        } else {
            renderQueryResults({ data: [] }); // For INSERT, UPDATE, etc.
        }
        // --- END MOCK IMPLEMENTATION ---

        /*
        // --- REAL IMPLEMENTATION (when backend is ready) ---
        try {
            const response = await fetchWithAuth(`/api/v1/databases/${state.dbId}/execute-query`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });
            const result = await response.json();
            if (!response.ok) {
                renderQueryResults({ error: result.detail || 'An unknown error occurred.' });
            } else {
                renderQueryResults({ data: result });
            }
        } catch (error) {
            renderQueryResults({ error: error.message });
        }
        */

        runQueryBtn.disabled = false;
        runQueryBtn.textContent = 'Run Query';
    }

    // Event Listeners
    tableList.addEventListener('click', handleTableSelect);
    
    createTableBtn.addEventListener('click', () => {
        resetCreateTableModal();
        openModal(createTableModal);
    });
    cancelCreateTableBtn.addEventListener('click', () => closeModal(createTableModal));
    createTableForm.addEventListener('submit', handleCreateTableSubmit);
    
    deleteTableBtn.addEventListener('click', () => {
        if (!state.selectedTable) return;
        modalTableName.textContent = state.selectedTable.name;
        openModal(deleteTableModal);
    });
    cancelDeleteTableBtn.addEventListener('click', () => closeModal(deleteTableModal));
    confirmDeleteTableBtn.addEventListener('click', handleDeleteTable);

    editColumnForm.addEventListener('submit', handleEditColumnSubmit);
    cancelEditColumnBtn.addEventListener('click', () => closeModal(editColumnModal));

    structureTbody.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-column-btn');
        const deleteBtn = e.target.closest('.delete-column-btn');

        if (editBtn) {
            const index = parseInt(editBtn.dataset.columnIndex, 10);
            populateAndOpenEditModal(state.selectedTable.columns[index], index);
        }

        if (deleteBtn) {
            const index = parseInt(deleteBtn.dataset.columnIndex, 10);
            const column = state.selectedTable.columns[index];
            if (confirm(`Are you sure you want to delete the column "${column.name}"?`)) {
                state.selectedTable.columns.splice(index, 1);
                saveTableStructure();
            }
        }
    });
    dataTbody.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-row-btn');
        if (deleteBtn) {
            const rowId = deleteBtn.dataset.rowId;
            handleDeleteRow(rowId);
        }
    });
    runQueryBtn.addEventListener('click', handleRunQuery);
    exportCsvBtn.addEventListener('click', handleExportCsv);
    dataTbody.addEventListener('blur', (e) => {
        // The 'blur' event fires when a user clicks away from an editable cell.
        if (e.target.classList.contains('editable-cell') && e.target.hasAttribute('contenteditable')) {
            handleUpdateRow(e.target);
        }
    }, true); // Use capture phase to handle event delegation properly

    dataTbody.addEventListener('keydown', (e) => {
        // When the user presses Enter in an editable cell, treat it as a confirmation.
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // Prevents adding a new line in the cell.
            const cell = e.target;
            cell.blur(); // Trigger the blur event, which calls the save function.
        }
    });

    const debouncedSearch = debounce(() => {
        const searchTerm = searchInput.value.trim();
        if (state.selectedTable) {
            fetchAndRenderData(state.selectedTable.id, 1, searchTerm);
        }
    });

    searchInput.addEventListener('input', debouncedSearch);

    document.getElementById('pagination-controls').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (target && (target.classList.contains('prev-page-btn') || target.classList.contains('next-page-btn'))) {
            const page = parseInt(target.dataset.page, 10);
            if (page && state.selectedTable) {
                fetchAndRenderData(state.selectedTable.id, page);
            }
        }
    });
    addRowBtn.addEventListener('click', handleAddRow);
    addColumnToModalBtn.addEventListener('click', () => {
        document.getElementById('new-columns-list').appendChild(createColumnRow());
    });

    document.getElementById('new-columns-list').addEventListener('change', (e) => {
        // FK checkbox toggle
        if (e.target.classList.contains('fk-checkbox')) {
            const container = e.target.closest('.column-row').querySelector('.fk-options-container');
            container.classList.toggle('hidden', !e.target.checked);
        }
        // FK table select
        if (e.target.classList.contains('fk-table-select')) {
            const tableId = e.target.value;
            const columnSelect = e.target.closest('.fk-options-container').querySelector('.fk-column-select');
            columnSelect.innerHTML = '<option value="">-- Select Column --</option>';
            columnSelect.disabled = true;

            if (tableId) {
                const targetTable = state.tables.find(t => t.id == tableId);
                if (targetTable) {
                    targetTable.columns.forEach(col => {
                        columnSelect.innerHTML += `<option value="${col.name}">${col.name}</option>`;
                    });
                    columnSelect.disabled = false;
                }
            }
        }
    });

    document.getElementById('new-columns-list').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-column-btn')) {
            e.target.closest('.column-row').remove();
        }
    });

    // Initial Load
    supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION' || event === 'TOKEN_REFRESHED') {
            if (session) {
                localStorage.setItem('supabase_token', session.access_token);
                // Only fetch initial data on sign in, not on every token refresh
                if (event !== 'TOKEN_REFRESHED') {
                    fetchDbIdAndTables();
                }
            } else {
                window.location.href = '/login';
            }
        } else if (event === 'SIGNED_OUT') {
            window.location.href = '/login';
        }
    });
});
</script>

</body>
</html>